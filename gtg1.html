<!DOCTYPE html>
<html>

<head>

<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
* {box-sizing: border-box}

a {color: blue; outline: 0}
a:link {text-decoration: none}
a:visited {text-decoration: none}
a:hover {text-decoration: underline}
a:focus {text-decoration: underline}
a:active {text-decoration: none}

body {font-size: 110%; font-family: Helvetica}
input {font-size: 95%; font-family: Helvetica; background-color: #f9f9f9; padding-left: 4px; padding-right: 4px; padding-top: 1px}
option {font-size: 95%; font-family: Helvetica; background-color: #f9f9f9}
select {font-size: 95%; font-family: Helvetica; background-color: #f9f9f9; padding-left: 1px; padding-right: 1px}
</style>

<title>gtg1</title>
</head>

<body>

<div id="dvDisplayBlocks">

<div id="dvBrowserSaveOuter" style="display: none; padding-left: 0.4em; padding-top: 0.4em">
  <div style="display: inline-block">
    <div><a href="javascript: browser_save__return_to_game()">return to game</a></div>
    <div style="height:0.8em"></div>
    <hr></hr>
  </div>
  <div style="height:0.6em"></div>
  <div id="dvBrowserSaveInner"></div>
  <div style="height:0.6em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.8em"></div>
    <div><a href="javascript: browser_save__return_to_game()">return to game</a></div>
  </div>
  <div style="height:50em"></div>
  <div><a href="javascript: browser_save__delete_all_saved_data()">delete all browser saved data</a></div>
  <div style="height:1em"></div>
</div>

<div id="dvEditor_AddToLocInventory_Outer" style="padding-left: 0.4em; padding-top: 0.4em">
  <div><b>Add New Object To Location's Inventory</b></div>
  <div style="height:0.6em"></div>
  <div>
    Name of New Object: <input id="ipEditor_AddToLocInventory_ItmName" class="" value="" />
  </div>
  <div style="height:0.6em"></div>
  <div>
    Can Be Grabbed: <input id="ipEditor_AddToLocInventory_CanGrab" type="checkbox" class="" />
  </div>
  <div style="height:0.6em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.8em"></div>
    <div>
      <a style="white-space: nowrap" href="javascript: dev_editor__add_to_location_inventory__do_add()">add</a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript: dev_editor__add_to_location_inventory__cancel_add()">cancel</a>
    </div>
  </div>
  <div style="height:1em"></div>
</div>

<div id="dvEditor_PageAdd_Outer" style="padding-left: 0.4em; padding-top: 0.4em">
  <div><b>Create New Page/Location</b></div>
  <div style="height:0.6em"></div>
  <div>
    Name of Page/Location: <input id="ipEditor_PageAdd_Name" class="" value="" />
  </div>
  <div style="height:0.6em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.8em"></div>
    <div>
      <a style="white-space: nowrap" href="javascript: dev_editor__create_new_page__do_add()">add</a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript: dev_editor__create_new_page__cancel_add()">cancel</a>
    </div>
  </div>
  <div style="height:1em"></div>
</div>

<div id="dvEditor_UaAdd_Outer" style="padding-left: 0.4em; padding-top: 0.4em">
  <div><b>Add User Action</b></div>
  <div style="height:0.6em"></div>
  <div>
    Name of Action: <input id="ipEditor_UaAdd_UaText" class="" value="" />
  </div>
  <div style="height:0.6em"></div>
  <div>
    Action Type: <span id="spnEditor_UaAdd_Uatype"></span>
  </div>
  <div id="dvEditor_UaAdd_Itms">
    <div style="height:0.6em"></div>
    <div>
      Object: <span id="spnEditor_UaAdd_ItmCodename"></span>
    </div>
  </div>
  <div id="dvEditor_UaAdd_Locs">
    <div style="height:0.6em"></div>
    <div>Location: <span id="spnEditor_UaAdd_LocCodename"></span></div>
    <!--
    <div>
      <div><input id="rdEditor_UaAdd_LocCurOrNew" type="radio" class="" value="LocCur"/></div>
      <div style="height:0.1em"></div>
      <div>&nbsp;&nbsp;&nbsp;Current Location: <span id="spnEditor_UaAdd_LocCodename"></span></div>
      <div><input id="rdEditor_UaAdd_LocCurOrNew" type="radio" class="" value="LocNew" /></div>
      <div style="height:0.1em"></div>
      <div>&nbsp;&nbsp;&nbsp;New Location: <input id="ipEditor_UaAdd_UaText" class="" value="" /></div>
    </div>
    -->
  </div>
  <div style="height:0.6em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.8em"></div>
    <div>
      <a style="white-space: nowrap" href="javascript: dev_editor__add_user_action__do_add()">add</a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript: dev_editor__add_user_action__cancel_add()">cancel</a>
    </div>
  </div>
  <div style="height:1em"></div>
</div>

<div id="dvEditor_UaDelete_Outer" style="padding-left: 0.4em; padding-top: 0.4em">
  <div><b>Confirm Deletion of User Action</b></div>
  <div style="height:0.6em"></div>
  <div>
    User-Action Name: <span id="spnEditor_UaDelete_UaText" class=""></span>
  </div>
  <div style="height:0.6em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.8em"></div>
    <div>
      <a style="white-space: nowrap" href="javascript: dev_editor__delete_user_action__do_delete()">confirm deletion</a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id="aEditor_UaDelete_cancelDelete" href="javascript: dev_editor__delete_user_action__cancel_delete()">cancel deletion</a>
    </div>
  </div>
  <div style="height:1em"></div>
</div>

<div id="dvEditor_UaEdit_Outer" style="padding-left: 0.4em; padding-top: 0.4em">
  <div><b>Edit User Action</b></div>
  <div style="height:0.6em"></div>
  <div>
    New Name for Action: <input id="ipEditor_UaEdit_UaText" class="" value="" />
  </div>
  <div style="height:0.6em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.8em"></div>
    <div>
      <a style="white-space: nowrap" href="javascript: dev_editor__edit_user_action__do_edit()">add</a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript: dev_editor__edit_user_action__cancel_edit()">cancel</a>
    </div>
  </div>
  <div style="height:1em"></div>
</div>

<div id="dvEditor_ViewAllPages_Outer" style="padding-left: 0.4em; padding-top: 0.4em">
  <div><b>All Pages For Game</b></div>
  <div style="height:0.6em"></div>
  <div>
    Game: <span id="spnEditor_ViewAllPages_GameName" class=""></span>
  </div>
  <div style="height:0.6em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.8em"></div>
    <div>
      <a style="white-space: nowrap" href="javascript: dev_editor__delete_user_action__do_delete()">confirm deletion</a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id="aEditor_UaDelete_cancelDelete" href="javascript: dev_editor__delete_user_action__cancel_delete()">cancel deletion</a>
    </div>
  </div>
  <div style="height:1em"></div>
</div>

<div id="dvGameOuter" style="padding-left: 1em; padding-top: 1em">
  <div id="dvGameInner_Page"></div>
  <div style="height:1.5em"></div>
  <div id="dvGameInner_Dev"></div>
</div>

<div id="dvUserInventory_Outer" style="padding-left: 1em; padding-top: 1em">
  <div><b>Your Inventory</b></div>
  <div style="height:0.6em"></div>
  <div id="dvUserInventory_Inner" class=""></div>
  <div style="height:0.6em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.8em"></div>
    <div>
      <a style="white-space: nowrap" href="javascript: return_from_user_inventory()">done</a>
    </div>
  </div>
  <div style="height:1em"></div>
</div>

</div>

<script type="text/javascript">

"use strict";


// CONSTANTS
const C_altFilterOpt_exists = "exists";

const C_appSetting_defaultGameCodename = "defaultGameCodename";
const C_appSetting_dev = "dev";
const C_appSetting_dev_hideEditor = "dev_hideEditor";
const C_appSetting_narrow = "narrow";
const C_appSetting_LS = "LS";

const C_att_canGrab = "canGrab";
const C_att_curPageCodename = "curPageCodename"
const C_att_gameCodename = "gameCodename";
const C_att_inventory = "inventory";
const C_att_isUser = "isUser";
const C_att_itmCodename = "itmCodename";
const C_att_locCodename = "locCodename";
const C_att_locName = "locName";
const C_att_name = "name";
const C_att_pageCodename = "pageCodename";
const C_att_startLocCodename = "startLocCodename";
const C_att_startPageCodename = "startPageCodename"
const C_att_textOfRow = "textOfRow";
const C_att_uaText = "uaText";
const C_att_uatype = "uatype";

const C_displayVarStub_locAtt = "LOC_ATT";

const C_displayVar_you = "YOU";
const C_displayVar_curLoc = "CUR_LOC";

const C_locCodename_cozyRoom = "cozy room";
const C_locCodename_scaryRoom = "scary room";

const C_misc_codename = "codename";
const C_misc_userCodename = "user";
const C_misc_userDefName = "You";

const C_saveTypeName_appSetting = "appSetting";
const C_saveTypeName_entity = "entity";
const C_saveTypeName_game = "game";
const C_saveTypeName_location = "location";
const C_saveTypeName_page = "page";
const C_saveTypeName_unknown = "unknown";

const C_spacerHeight = "0.5em"

const C_typecode_appSetting = "appSetting";
const C_typecode_ent = "E";
const C_typecode_game = "G";
const C_typecode_itm = "itm";
const C_typecode_loc = "L";
const C_typecode_page = "P";
const C_typecode_tr = "tr";
const C_typecode_ua = "ua";
const C_typecode_unknown = "?";

const C_uatype_moveToLoc = "moveToLoc";
const C_uatype_grabItm = "grabItm";

const C_userAction_changeYourName = "change your name";
const C_userAction_closeDoor = "close door";
const C_userAction_goToInfo = "go to info";
const C_userAction_goToPage = "go to page"
const C_userAction_moveToLoc = "move to location"
const C_userAction_openDoor = "open door";
const C_userAction_openInventory = "open your inventory";


// APP-LEVEL VARIABLES

const APP = {};
APP.allGameBrSvObjs = [];
APP.curGameObj = null;
APP.curPageObj = null;
APP.dev = "0";
APP.dev_hideEditor = "0";
APP.editor_curUaCodename = null;
APP.userEntObj = null;


// INTERNAL FUNCTIONS

function addLocationAtt(pageObj, locCodename, att, defaultVal) {
  var locAttVal = getLocationAttFromBrowserSave(locCodename, att);

  if ( isBlank(locAttVal) ) {
    locAttVal = defaultVal;
    setLocationAttInBrowserSave(locCodename, att, locAttVal);
  }

  pageObj[att] = locAttVal;
}

function addPageAction(page, actionName, actionLinkText, actionVar1) {
  var action = {};

  action.name = actionName;
  action.linkText = actionLinkText;

  if (actionVar1 == "" || ! isBlank(actionVar1) ) {
    action.var1 = actionVar1;
  } else {
    action.var1 = "";
  }

  page.actions.push(action);
}

function addPageTextRow(page, textOfRow, spacesDown) {
  var textRow = {};

  textRow.textOfRow = textOfRow;
  textRow.spacesDown = spacesDown;

  page.textRows.push(textRow);
}

function changeLocAtt(pageObj, att, newVal) {
  setLocationAttInBrowserSave(pageObj.name, att, newVal);
  pageObj[att] = newVal;
}

// the daX and dcX functions are using "x = function(y) {}" syntax, so that we can e.g. do the frequent search for "dc ("  [without the space]  without finding the called function
const da = function(text) {
  alert(text);
};

const dc = function(text1, text2, text3, text4, text5, text6, text7, text8, text9, text10) {
  var str = "";

  if ( text1 === undefined ) {
  } else {
    str += text1;
  }

  if ( text2 === undefined ) {
  } else {
    str += " ----- " + text2;
  }

  if ( text3 === undefined ) {
  } else {
    str += " ----- " + text3;
  }

  if ( text4 === undefined ) {
  } else {
    str += " ----- " + text4;
  }

  if ( text5 === undefined ) {
  } else {
    str += " ----- " + text5;
  }

  if ( text6 === undefined ) {
  } else {
    str += " ----- " + text6;
  }

  if ( text7 === undefined ) {
  } else {
    str += " ----- " + text7;
  }

  if ( text8 === undefined ) {
  } else {
    str += " ----- " + text8;
  }

  if ( text9 === undefined ) {
  } else {
    str += " ----- " + text9;
  }

  if ( text10 === undefined ) {
  } else {
    str += " ----- " + text10;
  }

  console.log(str);
}

const dc_ = function() {
  // this blank function exists to give the developer an option to change dc ("some text here") to dc_ ("some text here")  [keep space between "dc" and "(" to avoid this comment popping up with Ctrl-F]
  // , as a way to remove the console.log action that occurs via calling dc ()
  // , but without having to comment out the line via //dc ("some text here")
  //
  // --> allows searching for "dc ("  [without the space]  to determine whether there are any stray console.log calls that will occur when running the code
};

const dc2 = function(varName) {
  dc ( varName, eval(varName) );
};

function deleteFromBrowserSave_multiple(typecodeToDelete, codenameToDelete) {
  for (var i = 0; i < localStorage.length; i++) {
    let keyName = localStorage.key(i);
    let bskParts = keyName.split(":");

    let curTypecode = bskParts[0];
    let curCodename = bskParts[1];

    if ( isEqual(curTypecode, typecodeToDelete) && isEqual(curCodename, codenameToDelete) ) {
      localStorage.removeItem(keyName);
    }
  }
}

function deleteFromBrowserSave_singleRow(typecode, codename, att) {
  var bsk = getBrowserSaveKey(typecode, codename, att);
  localStorage.removeItem(bsk);
}

function displayBrowserSave() {
  hideAllDisplays();
  writeBrowserSavedData();
  elem("dvBrowserSaveOuter").style.display = "";
}

function displayEditor_pageAdd() {
  hideAllDisplays();

  elem("ipEditor_PageAdd_Name").value = "";

  elem("dvEditor_PageAdd_Outer").style.display = "";
  elem("ipEditor_PageAdd_Name").focus();
}

function displayEditor_uaAdd() {
  var uatypesObjs, htmlSel_uatypes, allGameItmObjs, htmlSel_itms, allGameLocObjs, htmlSel_locs;

  hideAllDisplays();

  elem("ipEditor_UaAdd_UaText").value = "";

  uatypesObjs = getUatypesObjAy();
  htmlSel_uatypes = getHtml_sel("selEditor_UaAdd_Uatype", true, uatypesObjs, null, "width: 2in", "displayEditor_uaAdd_changeUatype()", null, false, undefined, undefined, undefined);
  elem("spnEditor_UaAdd_Uatype").innerHTML = htmlSel_uatypes;
  
  allGameItmObjs = APP.curGameObj.getAllItmObjs();
  htmlSel_itms = getHtml_sel("selEditor_UaAdd_ItmCodename", true, allGameItmObjs, null, "width: 2in", undefined, undefined, undefined);
  elem("spnEditor_UaAdd_ItmCodename").innerHTML = htmlSel_itms;
  elem("dvEditor_UaAdd_Itms").style.display = "none";

  allGameLocObjs = APP.curGameObj.getAllLocObjs();
  htmlSel_locs = getHtml_sel("selEditor_UaAdd_LocCodename", true, allGameLocObjs, null, "width: 2in", undefined, undefined, undefined);
  elem("spnEditor_UaAdd_LocCodename").innerHTML = htmlSel_locs;
  elem("dvEditor_UaAdd_Locs").style.display = "none";

  elem("dvEditor_UaAdd_Outer").style.display = "";
  elem("ipEditor_UaAdd_UaText").focus();
}

function displayEditor_uaAdd_changeUatype() {
  var uatype = getElemVal("selEditor_UaAdd_Uatype");

  elem("dvEditor_UaAdd_Itms").style.display = "none";
  elem("dvEditor_UaAdd_Locs").style.display = "none";

  switch(uatype) {
    case C_uatype_grabItm:
      elem("dvEditor_UaAdd_Itms").style.display = "";
      //elem("selEditor_UaAdd_ItmCodename").focus();
      break;
    case C_uatype_moveToLoc:
      elem("dvEditor_UaAdd_Locs").style.display = "";
      //elem("selEditor_UaAdd_LocCodename").focus();
      break;
  }
}

function displayEditor_uaDelete() {
  var uaObj;

  hideAllDisplays();

  uaObj = APP.curPageObj.getUaObj(APP.editor_curUaCodename, APP.curPageObj.gameCodename, APP.curPageObj.codename);
  elem("spnEditor_UaDelete_UaText").innerHTML = uaObj.uaText;

  elem("dvEditor_UaDelete_Outer").style.display = "";

  elem("aEditor_UaDelete_cancelDelete").focus();
}

function displayEditor_uaEdit(uaCodename) {
  var uaObj;

  hideAllDisplays();

  uaObj = APP.curPageObj.getUaObj(uaCodename, APP.curPageObj.gameCodename, APP.curPageObj.codename);
  elem("ipEditor_UaEdit_UaText").value = uaObj.uaText;

  elem("dvEditor_UaEdit_Outer").style.display = "";

  elem("ipEditor_UaEdit_UaText").focus();
  elem("ipEditor_UaEdit_UaText").select();
}

function displayEditor_locInventory_add() {
  hideAllDisplays();
  elem("ipEditor_AddToLocInventory_ItmName").value = "";
  elem("dvEditor_AddToLocInventory_Outer").style.display = "";
  elem("ipEditor_AddToLocInventory_ItmName").focus();
}

function displayPage(pageObj) {
  var displayText = "";

  hideAllDisplays();

  if (pageObj) {
    pageObj.init();
    displayText = getHtml_pageDisplay(pageObj);
  } else {
    displayText = "ERROR: could not load game page";
  }

  elem("dvGameInner_Page").innerHTML = displayText;
  elem("dvGameOuter").style.display = "";
}

function displayUserInventory() {
  var htmlList;

  hideAllDisplays();

  htmlList = APP.userEntObj.getInventoryListHtml()
  elem("dvUserInventory_Inner").innerHTML = htmlList;

  elem("dvUserInventory_Outer").style.display = "";
}

function elem(elemId) {
  return document.getElementById(elemId);
}

function getAndMakeNewEnt(codename, isUser, name, gameCodename, locCodename, startLocCodename) {
  var entObj;

  if ( isBlank(codename)) {
    codename = getCodenameFromName(name);
  }

  entObj = getEntObj(codename, true, isUser, name, gameCodename, locCodename, null, startLocCodename);

  entObj.saveToBrowser();

  return entObj;
}

function getAndMakeNewGame(codename, name) {
  var gameObj;

  if ( isBlank(codename)) {
    codename = getCodenameFromName(name);
  }

  gameObj = getGameObj(codename, name);

  gameObj.saveToBrowser();

  return gameObj;
}

function getAndMakeNewItm(codename, name, gameCodename, canGrab) {
  var itmObj;

  if ( isBlank(codename)) {
    codename = getCodenameFromName(name);
  }

  itmObj;

  codename = getStringWithCharsReplaced(codename, ";", "");

  itmObj = getItmObj(codename, name, gameCodename, canGrab);

  itmObj.saveToBrowser();

  return itmObj;
}

function getAndMakeNewLoc(codename, name, gameCodename, pageCodename) {
  var locObj;

  if ( isBlank(codename)) {
    codename = getCodenameFromName(name);
  }

  locObj = getLocObj(codename, name, gameCodename, pageCodename);

  locObj.saveToBrowser();

  return locObj;
}

function getAndMakeNewPage(codename, name, gameCodename, locCodename, isNewLoc) {
  var pageObj, firstTrObj;

  if ( isBlank(codename)) {
    codename = getCodenameFromName(name);
  }

  if (isNewLoc) {
    getAndMakeNewLoc(codename, name, gameCodename, codename);
    locCodename = codename;
  }

  pageObj = getPageObj(codename, name, gameCodename, locCodename);

  pageObj.saveToBrowser();

  getAndMakeNewTr( pageObj, name );
  getAndMakeNewTr( pageObj, "You are in " + name.toLowerCase() );

  pageObj.init();

  return pageObj;
}

function getAndMakeNewTr(pageObj, textOfRow) {
  var trObj, trCodename;

  trCodename = getNextSortedCodename(C_typecode_tr, pageObj.gameCodename, pageObj.codename, C_att_textOfRow);

  trObj = getTrObj(trCodename, pageObj.gameCodename, pageObj.codename, textOfRow);

  pageObj.trObjs.push(trObj);

  trObj.saveToBrowser();

  return trObj;
}

function getAndMakeNewUa(pageObj, uaText, uatype, itmCodename, locCodename) {
  var uaObj, uaCodename;

  uaCodename = getNextSortedCodename(C_typecode_ua, pageObj.gameCodename, pageObj.codename, C_att_uaText);

  uaObj = getUaObj(uaCodename, pageObj.gameCodename, pageObj.codename, uaText, uatype, itmCodename, locCodename);

  pageObj.uaObjs.push(uaObj);

  uaObj.saveToBrowser();

  return uaObj;
}

function getAppSetting(settingName) {
  var val = getFromBrowserSave_single(C_typecode_appSetting, settingName, null);
  return val;
}

function getAsOneZero(val) {
  if (val == "1") {
    return "1";
  }

  if (val === 1) {
    return "1";
  }

  if (val == "0") {
    return "0";
  }

  if (val === 0) {
    return "0";
  }

  if ( isTrue(val) ) {
    return "1";
  }

  return "0";
}

function getBrowserSaveKey(typecode, codename, att) {
  var bsk, codename_processed, att_processed;
  
  bsk = typecode + ":";

  codename_processed = getProcessedSaveText(codename);

  bsk += codename_processed

  if ( ! isEqual(typecode, C_typecode_appSetting) ) {
    att_processed = getProcessedSaveText(att);
    bsk += ":" + att_processed;
  }

  return bsk;
}

// don't need anymore?
function getBrowserSaveType_fromSaveTypeCode(typecode) {
  switch(typecode) {
    case C_typecode_appSetting:
      return C_saveTypeName_appSetting;
    case C_typecode_ent:
      return C_saveTypeName_entity;
    case C_typecode_game:
      return C_saveTypeName_game;
    case C_typecode_loc:
      return C_saveTypeName_location;
    case C_typecode_page:
      return C_saveTypeName_page;
    default:
      return C_saveTypeName_unknown;
  }
}

// don't need anymore?
function getBrowserSaveTypeCode_fromSaveTypeName(saveTypeName) {
  switch(saveTypeName) {
    case C_saveTypeName_appSetting:
      return C_typecode_appSetting;
    case C_saveTypeName_entity:
      return C_typecode_ent;
    case C_saveTypeName_game:
      return C_typecode_game;
    case C_saveTypeName_location:
      return C_typecode_loc;
    case C_saveTypeName_page:
      return C_typecode_page;
    default:
      return C_typecode_unknown;
  }
}

function getBrowserSaveObj(keyName, keyValue) {
  var brSvObj = {};
  var bskParts = keyName.split(":");

  brSvObj.typecode = bskParts[0];
  brSvObj.codename = bskParts[1];
  
  if (bskParts.length > 2) {
    brSvObj.att = bskParts[2];
  } else {
    brSvObj.att = null;
  }

  brSvObj.val = keyValue;

  return brSvObj;
}

function getBrSvObjsFromBrowserSave(typecode, typecode_altFilterOpt, codename, codename_altFilterOpt, att, att_altFilterOpt, val, val_altFilterOpt, codenameLeft) {
  var brSvObjAy = [];
  var typecodeCheckPassed, codenameCheckPassed, attCheckPassed, valCheckPassed, codenameLeftCheckPassed;

  for (var i = 0; i < localStorage.length; i++) {
    typecodeCheckPassed = false, codenameCheckPassed = false, attCheckPassed = false, valCheckPassed = false, codenameLeftCheckPassed = false;

    let keyName = localStorage.key(i);
    let keyValue = localStorage.getItem(keyName);

    //TO-DO: need to handle C_altFilterOpt_exists and etc.

if (codenameLeft == "game1,location1,") dc_(keyName, localStorage.getItem(keyName))
    let brSvObj = getBrowserSaveObj(keyName, keyValue);

    if ( isBlank(typecode) && isBlank(typecode_altFilterOpt) ) {
      typecodeCheckPassed = true;
    } else {
      if ( isEqual(brSvObj.typecode, typecode) ) {
if (codenameLeft == "game1,location1,") dc_("typecode check found & passed", typecode)
        typecodeCheckPassed = true;
      } else {
if (codenameLeft == "game1,location1,") dc_("typecode check found & failed", typecode)
      }
    }

    if (typecodeCheckPassed) {
      if ( isBlank(codename) && isBlank(codename_altFilterOpt) ) {
        codenameCheckPassed = true;
      } else {
        if ( isEqual(brSvObj.codename, codename) ) {
if (codenameLeft == "game1,location1,") dc_("codename check found & passed", codename)
          codenameCheckPassed = true;
        } else {
if (codenameLeft == "game1,location1,") dc_("codename check found & failed", codename)
        }
      }
    }

    if (typecodeCheckPassed && codenameCheckPassed) {
      if ( isBlank(att) && isBlank(att_altFilterOpt) ) {
        attCheckPassed = true;
      } else {
        if ( isEqual(brSvObj.att, att) ) {
if (codenameLeft == "game1,location1,") dc_("att check found & passed", att)
          attCheckPassed = true;
        } else {
if (codenameLeft == "game1,location1,") dc_("att check found & failed", att)
        }
      }
    }

    if (typecodeCheckPassed && codenameCheckPassed && attCheckPassed) {
      if ( isBlank(val) && isBlank(val_altFilterOpt) ) {
        valCheckPassed = true;
      } else {
        if ( isEqual(brSvObj.val, val) ) {
if (codenameLeft == "game1,location1,") dc_("val check found & passed", val)
          valCheckPassed = true;
        } else {
if (codenameLeft == "game1,location1,") dc_("val check found & failed", val)
        }
      }
    }

    if (typecodeCheckPassed && codenameCheckPassed && attCheckPassed && valCheckPassed) {
      if ( isBlank(codenameLeft) ) {
        codenameLeftCheckPassed = true;
      } else {
        if ( leftIs(brSvObj.codename, codenameLeft) ) {
if (codenameLeft == "game1,location1,") dc_("codenameLeft check found & passed", "cnLeft=>", codenameLeft, ", cn=", brSvObj.codename)
          codenameLeftCheckPassed = true;
        } else {
if (codenameLeft == "game1,location1,") dc_("typecode check found & ", typecode)
        }
      }
    }

    if (typecodeCheckPassed && codenameCheckPassed && attCheckPassed && valCheckPassed && codenameLeftCheckPassed) {
      brSvObjAy.push(brSvObj);


      if (codenameLeft == "game1,location1,") dc_("..... YES passed checks")
    } else {
      if (codenameLeft == "game1,location1,") dc_("..... NOT passed checks")


    }
  }

  return brSvObjAy;
}

function getCodenameFromName(name) {
  var codename = getStringWithCharsReplaced(name, ":", "-");
  codename = getStringWithCharsReplaced(codename, " ", "-");
  codename = codename.toLowerCase();
  return codename;
}

function getCodenameLeft(parent1Codename, parent2Codename) {
  var codenameLeft = parent1Codename + ",";
  if ( ! isBlank(parent2Codename) ) {
    codenameLeft += parent2Codename + ",";
  }
  return codenameLeft;
}

function getElemFromObjArray(theArray, propName, propValToMatch) {
  var revisedArray = theArray.filter( (arrayElem) => {
    var returnValue = false;
    if ( isEqual(arrayElem[propName], propValToMatch) ) {
      returnValue = true;
    }
    return returnValue;
  });

  if (revisedArray.length == 0) {
    return null;
  } else {
    return revisedArray[0];
  }
}

function getElemFromValArray(theArray, valToMatch) {
  var revisedArray = theArray.filter( (arrayElem) => {
    var returnValue = false;
    if ( isEqual(arrayElem, valToMatch) ) {
      returnValue = true;
    }
    return returnValue;
  });

  if (revisedArray.length == 0) {
    return "";
  } else {
    return revisedArray[0];
  }
}

function getElemVal(elemId) {
  var theElem, elemType, elemVal;

  theElem = elem(elemId);
  elemType = theElem.type;

  switch (elemType) {
    case "checkbox":
      if (elemVal = theElem.checked) {
        elemVal = "1";
      } else {
        elemVal = "0";
      }
      break;

    default:
      elemVal = theElem.value;
  }

  return elemVal;
}

function getEntObj(codename, isInitialEntCreation, isUser, name, gameCodename, locCodename, inventory, startLocCodename) {
  var entObj = {}, itmCodenames, i;
  
  if (isInitialEntCreation) {

    if ( isTrue(isUser) ) {
      entObj.isUser = "1";
      codename = C_misc_userCodename + "," + gameCodename;
    } else {
      entObj.isUser = "0";
      if ( isEqual(codename, C_misc_userCodename) ) {
        codename += String(getRandomPositiveWholeNumber());
      }
      codename = codename + "," + gameCodename;
    }

  } else {

    if ( isBlank(isUser) ) {
      isUser = getFromBrowserSave_single(C_typecode_ent, codename, C_att_isUser);
    }
    entObj.isUser = getAsOneZero(isUser);

  }

  entObj.codename = codename;

  if ( isBlank(name) ) {
    name = getFromBrowserSave_single(C_typecode_ent, codename, C_att_name);
  }

  if ( isBlank(gameCodename) ) {
    gameCodename = getFromBrowserSave_single(C_typecode_ent, codename, C_att_gameCodename);
  }

  if ( isBlank(locCodename) ) {
    locCodename = getFromBrowserSave_single(C_typecode_ent, codename, C_att_locCodename);
  }

  if ( isBlank(inventory) ) {
    inventory = getFromBrowserSave_single(C_typecode_ent, codename, C_att_inventory);
  }

  if ( isBlank(startLocCodename) ) {
    startLocCodename = getFromBrowserSave_single(C_typecode_ent, codename, C_att_startLocCodename);
  }

  entObj.name = name;
  entObj.gameCodename = gameCodename;
  entObj.locCodename = locCodename;
  entObj.startLocCodename = startLocCodename;

  entObj.itmObjs = getItmObjsFromInventory(inventory);

  entObj.getInventoryListHtml = function() {
    var i, html = "";

    if (this.itmObjs.length == 0) {

      html += "<div>... (your inventory is empty)</div>\n";

    } else {

      for (i = 0; i < this.itmObjs.length; i++) {
        let curItmObj = this.itmObjs[i];
        html += "<div>- " + curItmObj.name + "</div>\n";
      }

    }

    return html;
  };

  entObj.moveToLocCodename = function(locCodename) {
    this.locCodename = locCodename;
    saveToBrowser(C_typecode_ent, this.codename, C_att_locCodename, this.locCodename);
  };

  entObj.moveToLocObj = function(locObj) {
    this.moveToLocCodename(locObj.codename);
  };

  entObj.receiveItmObj = function(itmObj) {
    var inventory;

    this.itmObjs.push(itmObj);

    inventory = getInventoryFromItmObjs(this.itmObjs);

    saveToBrowser(C_typecode_ent, this.codename, C_att_inventory, inventory);
  };

  entObj.removeItmObj = function(itmObj) {
    var inventory;

    this.itmObjs = getObjArrayWithoutElem(this.itmObjs, C_misc_codename, itmObj.codename)

    inventory = getInventoryFromItmObjs(this.itmObjs);

    saveToBrowser(C_typecode_ent, this.codename, C_att_inventory, inventory);
  };

  entObj.saveToBrowser = function() {
    var inventory = getInventoryFromItmObjs(this.itmObjs);

    saveToBrowser(C_typecode_ent, this.codename, C_att_isUser, this.isUser);
    saveToBrowser(C_typecode_ent, this.codename, C_att_name, this.name);
    saveToBrowser(C_typecode_ent, this.codename, C_att_gameCodename, this.gameCodename);
    saveToBrowser(C_typecode_ent, this.codename, C_att_locCodename, this.locCodename);
    saveToBrowser(C_typecode_ent, this.codename, C_att_inventory, inventory);
    saveToBrowser(C_typecode_ent, this.codename, C_att_startLocCodename, startLocCodename);
  };
  
  return entObj;
}

function getFromBrowserSave_single(typecode, codename, att) {
  var bsk = getBrowserSaveKey(typecode, codename, att);
  var val = localStorage.getItem(bsk);
  return val;
}

function getGameObj(codename, name, startPageCodename, curPageCodename) {
  var gameObj = {};

  gameObj.codename = codename;

  if ( isBlank(name) ) {
    name = getFromBrowserSave_single(C_typecode_game, codename, C_att_name);
  }

  if ( isBlank(startPageCodename) ) {
    startPageCodename = getFromBrowserSave_single(C_typecode_game, codename, C_att_startPageCodename);
  }

  if ( isBlank(curPageCodename) ) {
    curPageCodename = getFromBrowserSave_single(C_typecode_game, codename, C_att_curPageCodename);
  }
  
  gameObj.name = name;
  gameObj.startPageCodename = startPageCodename;
  gameObj.curPageCodename = curPageCodename;

  gameObj.getAllEntObjs = function() {
    var entBrSvObjs, i, entObjs = [];

    entBrSvObjs = getBrSvObjsFromBrowserSave(C_typecode_ent, null, null, null, C_att_gameCodename, null, this.codename, null, null);

    for (let curEntBrSvObj in entBrSvObjs) {
      let curEntCodename = curEntBrSvObj.codename;
      let curEntObj = getEntObj(curEntCodename, null, null, null, this.codename);
      entObjs.push(curEntObj);
    }

    return entObjs;
  };

  gameObj.getAllItmObjs = function(doSort) {
    var entObjs = this.getAllEntObjs();
    var pageObjs = this.getAllPageObjs();
    var itmObjs = [];

    for (let curEntObj in entObjs) {
      for (let curItmObj in curEntObj.itmObjs) {
        itmObjs.push[curItmObj];
      }
    }

    for (let curPageObj in pageObjs) {
      for (let curItmObj in curPageObj.itmObjs) {
        itmObjs.push[curItmObj];
      }
    }

    if ( isTrue(doSort) ) {
      itmObjs.sort( sorting_objs(C_att_name) );
    }

    return itmObjs;
  };

  gameObj.getAllLocObjs = function() {
    var locBrSvObjs, i, locObjs = [];

    locBrSvObjs = getBrSvObjsFromBrowserSave(C_typecode_loc, null, null, null, C_att_gameCodename, null, this.codename, null, null);

    for (i = 0; i < locBrSvObjs.length; i++) {
      let curLocBrSvObj = locBrSvObjs[i];
      let curLocCodename = curLocBrSvObj.codename;
      let curLocObj = getLocObj(curLocCodename, null, this.codename);
      locObjs.push(curLocObj);
    }

    return locObjs;
  };

  gameObj.getAllPageObjs = function() {
    var pageBrSvObjs, i, pageObjs = [];

    pageBrSvObjs = getBrSvObjsFromBrowserSave(C_typecode_page, null, null, null, C_att_gameCodename, null, this.codename, null, null);

    for (let curPageBrSvObj in pageBrSvObjs) {
      let curPageCodename = curPageBrSvObj.codename;
      let curPageObj = getPageObj(curPageCodename, null, this.codename);
      curPageObj.init();
      pageObjs.push(curPageObj);
    }

    return pageObjs;
  };

  gameObj.saveToBrowser = function() {
    saveToBrowser(C_typecode_game, this.codename, C_att_name, this.name);
    saveToBrowser(C_typecode_game, this.codename, C_att_startPageCodename, this.startPageCodename);
  };
  
  return gameObj;
}

function getHtml_a(linkText, jsFunc, jsArg1, jsArg2) {
  var html = "<a href='javascript: " + jsFunc + " (" ;

  if ( ! isBlank(jsArg1) ) {
    html += " \"" + jsArg1 + "\"";
  }

  if ( ! isBlank(jsArg2) ) {
    html += " , \"" + jsArg2 + "\"";
  }

  html += " )'>" + linkText + "</a>";

  return html;
}

function getHtml_pageDisplay(pageObj) {
  var html = "";
  var i, infoLinkHtml;


  // TEXT-ROWS

  for (i = 0; i < pageObj.trObjs.length; i++) {
    let curTrObj = pageObj.trObjs[i];
    let textOfRow = curTrObj.textOfRow;

    if ( isTrue(APP.dev) && ! isTrue(APP.dev_hideEditor) ) {
      textOfRow += "&nbsp;&nbsp;&nbsp;" + getHtml_a("> edit", "dev_editor__edit_text_row", curTrObj.codename);
      textOfRow += "&nbsp;&nbsp;&nbsp;" + getHtml_a("> delete", "dev_editor__delete_text_row", curTrObj.codename);
    }

    html += getHtmlForAddedTextRow(html, textOfRow, 1);
  }

  if ( isTrue(APP.dev) && ! isTrue(APP.dev_hideEditor) ) {
    html += getHtmlDownSpacer();
    html += "<div>" + getHtml_a("> add new text-row", "dev_editor__add_text_row") + "</div>\n";
  }

  html += getHtmlDownSpacer(2);


  // USER-ACTIONS FOR PAGE

  if (pageObj.uaObjs.length == 0) {

    html += getHtmlForAddedTextRow(html, "(no user-actions are available yet for this page)", 1);

  } else {

    for (i = 0; i < pageObj.uaObjs.length; i++) {
      let curUaObj = pageObj.uaObjs[i];
      let uaText = getHtml_a(curUaObj.uaText, "do_action", curUaObj.uatype, curUaObj.codename);

      if ( isTrue(APP.dev) && ! isTrue(APP.dev_hideEditor) ) {
        uaText += "&nbsp;&nbsp;&nbsp;" + getHtml_a("> edit", "dev_editor__goto__edit_user_action", curUaObj.codename);
        uaText += "&nbsp;&nbsp;&nbsp;" + getHtml_a("> delete", "dev_editor__goto__delete_user_action", curUaObj.codename);
      }

      html += getHtmlForAddedTextRow(html, uaText, 1);

      //let actionLinkHtml = getHtml_userAction(action.linkText, action.name, action.var1);
      //html += getHtmlForAddedTextRow(html, actionLinkHtml);
    }

  }

  if ( isTrue(APP.dev) && ! isTrue(APP.dev_hideEditor) ) {
    html += getHtmlDownSpacer();
    html += "<div>" + getHtml_a("> add new user-action", "dev_editor__goto__add_user_action") + "</div>\n";
  }


  // USER-ACTIONS GENERAL

  if ( ! isBlank(pageObj.locCodename) ) {
    infoLinkHtml = getHtml_userAction(C_userAction_openInventory, C_userAction_openInventory);
    html += getHtmlForAddedTextRow(html, infoLinkHtml, 2, true);
  }


  return html;
}

function getHtml_sel(selectElemId, includeBlank, ay, defValue, theStyle, onChange, blankDisplay, isDisabled, valueProp = "codename", displayProp = "name", isValArray = false) {
  var i, html;

  html = "<select id='" + selectElemId + "'";

  if (  !isBlank(theStyle) ) {
    html += " style='" + theStyle + "'";
  }

  if ( !isBlank(onChange) ) {
    html += " onchange='javascript: " + onChange + "'";
  }

  if (isDisabled) {
    html += " disabled";
  }

  html += ">\n";

  if (includeBlank) {
    html += "<option value=''";
    if ( isBlank(defValue) ) html += " selected";
    html += ">";
    if (blankDisplay) {
      html += blankDisplay + "</option>\n";
    } else {
      html += " </option>\n";
    }
  }

  for (i = 0; i < ay.length; i++ ) {
    let curOptionId, curOptionDisplay;

    if (isValArray) {
      curOptionId = ay[i];
      curOptionDisplay = ay[i];
    } else {
      curOptionId = ay[i][valueProp];
      curOptionDisplay = ay[i][displayProp];
    }

    html += "<option value='" + curOptionId + "'";

    if ( isEqual(defValue, curOptionId) ) {
      html += " selected";
    }

    html += ">" + curOptionDisplay + "</option>\n";
  }

  html += "</select>\n";

  return html;
}

function getHtml_userAction(linkText, linkActionName, linkActionVar1) {
  var html = getHtml_a(linkText, "do_action", linkActionName, linkActionVar1);
  return html;
}

function getHtmlDownSpacer(spacesDown) {
  var i, html = "";

  if ( ! isNumeric(spacesDown) ) {
    spacesDown = 1;
  } else {
    if ( spacesDown < 0 || spacesDown > 100 ) {
      spacesDown = 1;
    }
  }

  for (i = 1; i <= spacesDown; i++ ) {
    html += "<div style='height: " + C_spacerHeight + "'></div>\n";
  }

  return html;
}

function getHtmlForAddedTextRow(curHtml, rowOfText, spacesDown, skipParsing) {
  var newHtml = "", parsedText;

  if ( ! isNumeric(spacesDown) ) {
    spacesDown = 1;
  } else {
    if ( spacesDown < 0 || spacesDown > 100 ) {
      spacesDown = 1;
    }
  }

  if ( isBlank(curHtml) && spacesDown <= 1 ) {
    // no action -- no need to add a space for the first row of text on the screen (unless the calling function requested 2+ spaces)
  } else {
    newHtml += getHtmlDownSpacer(spacesDown);
  }

  if (skipParsing) {
    parsedText = rowOfText;
  } else {
    parsedText = getParsedDisplayText(rowOfText);
  }

  newHtml += "<div>" + parsedText + "</div>\n";

  return newHtml;
}

function getInventoryFromItmObjs(itmObjs) {
  var i, inventory = "";

  for(i = 0; i < itmObjs.length; i++) {
    let curItmObj = itmObjs[i];
    let curItmCodename = curItmObj.codename;

    if (i > 0) {
      inventory += ";";
    }

    inventory += curItmCodename;
  }

  return inventory;
}

function getItmObj(codename, name, gameCodename, canGrab) {
  var itmObj = {};

  itmObj.codename = codename;

  if ( isBlank(name) ) {
    name = getFromBrowserSave_single(C_typecode_itm, codename, C_att_name);
  }

  if ( isBlank(gameCodename) ) {
    gameCodename = getFromBrowserSave_single(C_typecode_itm, codename, C_att_gameCodename);
  }

  if ( isBlank(canGrab) ) {
    canGrab = getFromBrowserSave_single(C_typecode_itm, codename, C_att_canGrab);
  }

  itmObj.name = name;
  itmObj.gameCodename = gameCodename;
  itmObj.canGrab = getAsOneZero(canGrab);

  itmObj.saveToBrowser = function() {
    let canGrabOneZero = getAsOneZero(this.canGrab);

    saveToBrowser(C_typecode_itm, this.codename, C_att_name, this.name);
    saveToBrowser(C_typecode_itm, this.codename, C_att_gameCodename, this.gameCodename);
    saveToBrowser(C_typecode_itm, this.codename, C_att_canGrab, canGrabOneZero);
  };
  
  return itmObj;
}

function getItmObjsFromInventory(inventory) {
  var itmObjs, itmCodenames, i;

  itmObjs = [];

  if ( isBlank(inventory) ) {
    return itmObjs;
  }

  itmCodenames = inventory.split(";");

  for (i = 0; i < itmCodenames.length; i++) {
    let curItmCodename = itmCodenames[i];
    let curItmObj = getItmObj(curItmCodename);
    itmObjs.push(curItmObj);
  }

  return itmObjs;
}

function getLocationAttFromBrowserSave(locCodename, att) {
  var val = getFromBrowserSave_single(C_saveTypeName_location, locCodename, att);
  return val;
}

function getLocDisplayVar(att) {
  var displayVar = C_displayVarStub_locAtt + "__" + att;
  return displayVar;
}

function getLocDisplayVarCode(att) {
  var displayVarCode = "_" + getLocDisplayVar(att) + "_"
  return displayVarCode;
}

function getLocObj(codename, name, gameCodename, pageCodename, inventory) {
  var locObj = {}, itmCodenames, i;

  locObj.codename = codename;

  if ( isBlank(name) ) {
    name = getFromBrowserSave_single(C_typecode_loc, codename, C_att_name);
  }

  if ( isBlank(gameCodename) ) {
    gameCodename = getFromBrowserSave_single(C_typecode_loc, codename, C_att_gameCodename);
  }

  if ( isBlank(pageCodename) ) {
    pageCodename = getFromBrowserSave_single(C_typecode_loc, codename, C_att_pageCodename);
  }

  if ( isBlank(inventory) ) {
    inventory = getFromBrowserSave_single(C_typecode_loc, codename, C_att_inventory);
  }

  locObj.name = name;
  locObj.gameCodename = gameCodename;
  locObj.pageCodename = pageCodename;

  locObj.itmObjs = getItmObjsFromInventory(inventory);

  locObj.getInventoryListHtml = function() {
    var i, html = "";

    if (this.itmObjs.length == 0) {

      html += "<div>... (nothing in this location's inventory)</div>\n";

    } else {

      for (i = 0; i < this.itmObjs.length; i++) {
        let curItmObj = this.itmObjs[i];
        html += "<div>- " + curItmObj.name + "</div>\n";
      }

    }

    return html;
  };

  locObj.receiveItmObj = function(itmObj) {
    var inventory;

    this.itmObjs.push(itmObj);

    inventory = getInventoryFromItmObjs(this.itmObjs);

    saveToBrowser(C_typecode_loc, this.codename, C_att_inventory, inventory);
  };

  locObj.removeItmObj = function(itmObj) {
    var inventory;

    this.itmObjs = getObjArrayWithoutElem(this.itmObjs, C_misc_codename, itmObj.codename)

    inventory = getInventoryFromItmObjs(this.itmObjs);

    saveToBrowser(C_typecode_loc, this.codename, C_att_inventory, inventory);
  };

  locObj.saveToBrowser = function() {
    var inventory = getInventoryFromItmObjs(this.itmObjs);

    saveToBrowser(C_typecode_loc, this.codename, C_att_name, this.name);
    saveToBrowser(C_typecode_loc, this.codename, C_att_gameCodename, this.gameCodename);
    saveToBrowser(C_typecode_loc, this.codename, C_att_pageCodename, this.pageCodename);
    saveToBrowser(C_typecode_loc, this.codename, C_att_inventory, inventory);
  };
  
  return locObj;
}

function getNextSortedCodename(typecode, parent1Codename, parent2Codename, att) {
  var codenameLeftToFind, ay, aySorted, lastAyItemCodename, lastCurSortval, nextSortval, nextSortedCodename;

  codenameLeftToFind = getCodenameLeft(parent1Codename, parent2Codename);
//da(att)
  ay = getBrSvObjsFromBrowserSave(typecode, null, null, null, att, null, null, null, codenameLeftToFind);

  aySorted = sortSortedCodenameAy(ay);

  if (ay.length == 0) {
    nextSortval = 1;
  } else {
    lastAyItemCodename = ay[ay.length - 1].codename;
    lastCurSortval = withoutLeft(lastAyItemCodename, codenameLeftToFind);
    nextSortval = Number(lastCurSortval) + 1;
  }

  nextSortedCodename = parent1Codename + "," + parent2Codename + "," + nextSortval;

  return nextSortedCodename;
}

function getObjArrayAsString(theArray, propName, propName2) {
  var i, str = "";
  for (i = 0; i < theArray.length; i++ ){
    str += "array item #" + (parseInt(i) + 1) + " ----- ";
    str += propName1 + ": " + theArray[i][propName1];
    if ( !isBlank(propName2) ) str += ", " + propName2 + ": " + theArray[i][propName2];
    str += "\n";
  }
  return str;
}

function getObjArrayWithoutElem(theArray, propName, propValToExclude) {
  var revisedArray;

  revisedArray = theArray.filter( (arrayElem) => {
    var returnValue = true;
    if ( isEqual(arrayElem[propName], propValToExclude) ) {
      returnValue = false;
    }
    return returnValue;
  });

  return revisedArray;

  /* test code for this function:
  var x1 = {prop1: "a"};
  var x2 = {prop1: "b"};
  var x3 = {prop1: "b"};
  var x4 = {prop1: "a"};

  var ay = [x1, x2, x3, x4];

  var ay2 = getObjArrayWithoutElem(ay, "prop1", "b")

  dc_(getObjArrayAsString(ay2, "prop1"))
  */
}

function getPageObj(codename, name, gameCodename, locCodename) {
  var pageObj = {};

  pageObj.codename = codename;

  if ( isBlank(name) ) {
    name = getFromBrowserSave_single(C_typecode_page, codename, C_att_name);
  }

  if ( isBlank(gameCodename) ) {
    gameCodename = getFromBrowserSave_single(C_typecode_page, codename, C_att_gameCodename);
  }

  if ( isBlank(locCodename) ) {
    locCodename = getFromBrowserSave_single(C_typecode_page, codename, C_att_locCodename);
  }

  pageObj.name = name;
  pageObj.gameCodename = gameCodename;
  pageObj.locCodename = locCodename;

  pageObj.trObjs = [];
  pageObj.uaObjs = [];

  pageObj.deleteTr = function(trCodenameToDelete) {
    var newAy;

    deleteFromBrowserSave_multiple(C_typecode_tr, trCodenameToDelete);

    newAy = getObjArrayWithoutElem(this.trObjs, C_misc_codename, trCodenameToDelete);
    this.trObjs = newAy;
  };

  pageObj.deleteUa = function(uaCodenameToDelete) {
    var newAy;

    deleteFromBrowserSave_multiple(C_typecode_ua, uaCodenameToDelete);

    newAy = getObjArrayWithoutElem(this.uaObjs, C_misc_codename, uaCodenameToDelete);
    this.uaObjs = newAy;
  };

  pageObj.getTrObj = function(trCodename) {
    for (var i = 0; i < this.trObjs.length; i++) {
      let curTrObj = this.trObjs[i];
      if ( isEqual(trCodename, curTrObj.codename) ) {
        return curTrObj;
      }
    }
    return null;
  };

  pageObj.getUaObj = function(uaCodename) {
    for (var i = 0; i < this.uaObjs.length; i++) {
      let curUaObj = this.uaObjs[i];
      if ( isEqual(uaCodename, curUaObj.codename) ) {
        return curUaObj;
      }
    }
    return null;
  };

  pageObj.init = function() {
    this.loadTrObjsFromBrowserSave();
    this.loadUaObjsFromBrowserSave();
  };

  pageObj.loadTrObjsFromBrowserSave = function() {
    var codenameLeft, brSvObjs, i;

    this.trObjs = [];

    codenameLeft = getCodenameLeft(this.gameCodename, this.codename);

    brSvObjs = getBrSvObjsFromBrowserSave(C_typecode_tr, null, null, null, C_att_textOfRow, null, null, null, codenameLeft);

    for (i = 0; i < brSvObjs.length; i++) {
      let curBrSvObj = brSvObjs[i];
      let newTrObj = getTrObj(curBrSvObj.codename, this.gameCodename, this.codename, curBrSvObj.val);
      this.trObjs.push(newTrObj);
    }

    this.trObjs = sortSortedCodenameAy(this.trObjs);
  };

  pageObj.loadUaObjsFromBrowserSave = function() {
    var codenameLeft, brSvObjs, i;

    this.uaObjs = [];

    codenameLeft = getCodenameLeft(this.gameCodename, this.codename);

    brSvObjs = getBrSvObjsFromBrowserSave(C_typecode_ua, null, null, null, C_att_uaText, null, null, null, codenameLeft);

    for (i = 0; i < brSvObjs.length; i++) {
      let curBrSvObj = brSvObjs[i];
      let newUaObj = getUaObj(curBrSvObj.codename, this.gameCodename, this.codename, curBrSvObj.val);
      this.uaObjs.push(newUaObj);
    }

    this.uaObjs = sortSortedCodenameAy(this.uaObjs);
  };

  pageObj.saveToBrowser = function() {
    saveToBrowser(C_typecode_page, this.codename, C_att_name, this.name);
    saveToBrowser(C_typecode_page, this.codename, C_att_gameCodename, this.gameCodename);
    saveToBrowser(C_typecode_page, this.codename, C_att_locCodename, this.locCodename);
  };
  
  return pageObj;
}

function getParsedDisplayText(originalText) {
  var i, newText = "";
  var words = originalText.split(" ");

  for (i = 0; i < words.length; i++) {
    let curWord = words[i];
    let curTmp1, curTmp2, curTmp3, possibleDisplayVar;
    let textToAddLeft = "";
    let textToAddRight = "";

    //alert("word " + (i + 1) + " => " + curWord); 
    if ( leftIs(curWord, "_") || leftIs(curWord, "\"_") ) {

      if ( leftIs(curWord, "\"_") ) {
        textToAddLeft = "\""
        curTmp1 = withoutLeft(curWord, "\"_");
      } else {
        curTmp1 = withoutLeft(curWord, "_");
      }

      //alert("... has a left underscore ..."); 

      if ( rightIs(curWord, "_") ) {

        //alert("... and a right underscore ..."); 
        possibleDisplayVar = withoutRight(curTmp1, "_" );

      } else if ( rightIs(curWord, ",") ) {

        //alert("... and a right comma ..."); 
        curTmp2 = withoutRight(curTmp1, ",");
        if ( rightIs(curTmp2, "_") ) {
          //alert("... after an underscore ..."); 
          possibleDisplayVar = withoutRight(curTmp2, "_" );
          textToAddRight = ","
        }

      } else if ( rightIs(curWord, ".") ) {

        //alert("... and a right period ..."); 
        curTmp2 = withoutRight(curTmp1, ".");
        if ( rightIs(curTmp2, "_") ) {
          //alert("... after an underscore ..."); 
          possibleDisplayVar = withoutRight(curTmp2, "_" );
          textToAddRight = "."
        }

      } else if ( rightIs(curWord, "?") ) {

        //alert("... and a right question mark ..."); 
        curTmp2 = withoutRight(curTmp1, "?");
        if ( rightIs(curTmp2, "_") ) {
          //alert("... after an underscore ..."); 
          possibleDisplayVar = withoutRight(curTmp2, "_" );
          textToAddRight = "?"
        }

      } else if ( rightIs(curWord, "!") ) {

        //alert("... and a right exclamation point ..."); 
        curTmp2 = withoutRight(curTmp1, "!");
        if ( rightIs(curTmp2, "_") ) {
          //alert("... after an underscore ..."); 
          possibleDisplayVar = withoutRight(curTmp2, "_" );
          textToAddRight = "!"
        }

      } else if ( rightIs(curWord, ";") ) {

        //alert("... and a right semicolon ..."); 
        curTmp2 = withoutRight(curTmp1, ";");
        if ( rightIs(curTmp2, "_") ) {
          //alert("... after an underscore ..."); 
          possibleDisplayVar = withoutRight(curTmp2, "_" );
          textToAddRight = ";"
        }

      } else if ( rightIs(curWord, ":") ) {

        //alert("... and a right colon ..."); 
        curTmp2 = withoutRight(curTmp1, ":");
        if ( rightIs(curTmp2, "_") ) {
          //alert("... after an underscore ..."); 
          possibleDisplayVar = withoutRight(curTmp2, "_" );
          textToAddRight = ":"
        }

      } else if ( rightIs(curWord, "\"") ) {

        //alert("... and a right colon ..."); 
        curTmp2 = withoutRight(curTmp1, "\"");
        if ( rightIs(curTmp2, "_") ) {
          //alert("... after an underscore ..."); 
          possibleDisplayVar = withoutRight(curTmp2, "_" );
          textToAddRight = "\""
        }

      } else if ( rightIs(curWord, "</a>") ) {

        //alert("... and a right colon ..."); 
        curTmp2 = withoutRight(curTmp1, "</a>");
        if ( rightIs(curTmp2, "_") ) {
          //alert("... after an underscore ..."); 
          possibleDisplayVar = withoutRight(curTmp2, "_" );
          textToAddRight = "</a>"
        }

      }
     
      if (possibleDisplayVar) {
        curWord = getParsedDisplayText_doPossDisVar(curWord, possibleDisplayVar, textToAddLeft, textToAddRight)
      }

    }

    if ( newText.length > 0 ) {
      newText += " ";
    }

    newText += curWord;
  }

  return newText;
}

function getParsedDisplayText_doPossDisVar(curWord, possibleDisplayVar, textToAddLeft, textToAddRight) {
  //alert("... resulting in a possible displayVar of '" + possibleDisplayVar + "' ..."); 
  switch (possibleDisplayVar) {

    case C_displayVar_you:
      curWord = textToAddLeft + APP.youObj.name + textToAddRight;
      //alert("... and we found displayVar '" + possibleDisplayVar + "' so we changed to the underlying value!");
      break;

    case C_displayVar_curLoc:
      curWord = textToAddLeft + APP.youObj.locName + textToAddRight;
      //alert("... and we found displayVar '" + possibleDisplayVar + "' so we changed to the underlying value!");
      break;

    default:

      //alert("... checking possibleDisplayVar '" + possibleDisplayVar + "' for leftIs '" + C_displayVarStub_locAtt + "'");
      if ( leftIs(possibleDisplayVar, C_displayVarStub_locAtt) ) {
        let att = withoutLeft(possibleDisplayVar, C_displayVarStub_locAtt + "__");
        curWord = textToAddLeft + APP.curPageObj[att] + textToAddRight;
      }

      //alert("... but displayVar '" + possibleDisplayVar + "' does not exist as an option, so we are sticking with the original word " + curWord);
  }

  return curWord;
}

function getProcessedSaveText(text) {
  var x = getStringWithCharsReplaced(text, ":", " ");
  return x;
}

function getProcessedStringForSave(oldString) {
  var newString = getStringWithCharsReplaced(oldString, "  ", "&nbsp;&nbsp;");
  newString = getStringWithCharsReplaced(newString, "\n", "<br />");
  return newString;
}

function getProcessedStringForTextView(oldString) {
  var newString = getStringWithCharsReplaced(oldString, "&nbsp;&nbsp;", "  ");
  newString = getStringWithCharsReplaced(newString, "<br />", "\n");
  return newString;
}

function getRandomPositiveWholeNumber() {
  var a = Math.random();
  var b = String(a);
  var c = b.split(".");
  var d = c[1];
  return d;
}

function getStringWithCharsReplaced(oldString, oldChars, newChars) {
  if ( oldString == null || oldChars == null ) {
    return "";
  }

  if ( newChars == null ) {
    newChars = "";
  }

  var newString = oldString;

  for (var i = 1; i <= 100000; i++) {  //use a counter to prevent being stuck in a loop if something goes wrong
    if ( !newString.includes(oldChars) ) {
      return newString;
    }

    newString = newString.replace(oldChars, newChars);
  }

  return newString;
}

function getTextFromUser(promptText, defaultVal) {
  if ( isBlank(defaultVal) ) {
    defaultVal = "";
  }

  var response = prompt(promptText, defaultVal);

  return response;
}

function getTrObj(codename, gameCodename, pageCodename, textOfRow) {
  var trObj = {};

  trObj.codename = codename;

  if ( isBlank(gameCodename) ) {
    gameCodename = getFromBrowserSave_single(C_typecode_tr, codename, C_att_gameCodename);
  }

  if ( isBlank(pageCodename) ) {
    pageCodename = getFromBrowserSave_single(C_typecode_tr, codename, C_att_pageCodename);
  }

  if ( isBlank(textOfRow) ) {
    textOfRow = getFromBrowserSave_single(C_typecode_tr, codename, C_att_textOfRow);
  }

  trObj.gameCodename = gameCodename;
  trObj.pageCodename = pageCodename;
  trObj.textOfRow = textOfRow;

  trObj.changeTextOfRow = function(newTextOfRow) {
    this.textOfRow = newTextOfRow;
    saveToBrowser(C_typecode_tr, this.codename, C_att_textOfRow, this.textOfRow);
  };

  trObj.saveToBrowser = function() {
    saveToBrowser(C_typecode_tr, this.codename, C_att_gameCodename, this.gameCodename);
    saveToBrowser(C_typecode_tr, this.codename, C_att_pageCodename, this.pageCodename);
    saveToBrowser(C_typecode_tr, this.codename, C_att_textOfRow, this.textOfRow);
  };
  
  return trObj;
}

function getUaObj(codename, gameCodename, pageCodename, uaText, uatype, itmCodename, locCodename) {
  var uaObj = {};

  uaObj.codename = codename;

  if ( isBlank(gameCodename) ) {
    gameCodename = getFromBrowserSave_single(C_typecode_ua, codename, C_att_gameCodename);
  }

  if ( isBlank(pageCodename) ) {
    pageCodename = getFromBrowserSave_single(C_typecode_ua, codename, C_att_pageCodename);
  }

  if ( isBlank(uaText) ) {
    uaText = getFromBrowserSave_single(C_typecode_ua, codename, C_att_uaText);
  }

  if ( isBlank(uatype) ) {
    uatype = getFromBrowserSave_single(C_typecode_ua, codename, C_att_uatype);
  }

  if ( isBlank(itmCodename) ) {
    itmCodename = getFromBrowserSave_single(C_typecode_ua, codename, C_att_itmCodename);
  }

  if ( isBlank(locCodename) ) {
    locCodename = getFromBrowserSave_single(C_typecode_ua, codename, C_att_locCodename);
  }

  uaObj.gameCodename = gameCodename;
  uaObj.pageCodename = pageCodename;
  uaObj.uaText = uaText;
  uaObj.uatype = uatype;
  uaObj.itmCodename = itmCodename;
  uaObj.locCodename = locCodename;

  uaObj.saveToBrowser = function() {
    saveToBrowser(C_typecode_ua, this.codename, C_att_gameCodename, this.gameCodename);
    saveToBrowser(C_typecode_ua, this.codename, C_att_pageCodename, this.pageCodename);
    saveToBrowser(C_typecode_ua, this.codename, C_att_uaText, this.uaText);
    saveToBrowser(C_typecode_ua, this.codename, C_att_uatype, this.uatype);
    saveToBrowser(C_typecode_ua, this.codename, C_att_itmCodename, this.itmCodename);
    saveToBrowser(C_typecode_ua, this.codename, C_att_locCodename, this.locCodename);
  };
  
  return uaObj;
}

function getUatypeDisplayText(uatype) {
  switch(uatype) {
    case C_uatype_grabItm:
      return "grab item";
      break;
    case C_uatype_moveToLoc:
      return "move to location";
      break;
  }
}

function getUatypesObjAy() {
  var ay = [];
  var uatypeObj_grabItm = {};
  var uatypeObj_moveToLoc = {};

  uatypeObj_grabItm.codename = C_uatype_grabItm;
  uatypeObj_grabItm.name = getUatypeDisplayText(C_uatype_grabItm);
  ay.push(uatypeObj_grabItm);
  
  uatypeObj_moveToLoc.codename = C_uatype_moveToLoc;
  uatypeObj_moveToLoc.name = getUatypeDisplayText(C_uatype_moveToLoc);
  ay.push(uatypeObj_moveToLoc);

  return ay;
}

function getValArrayWithoutElem(theArray, valToExclude) {
  var revisedArray;

  revisedArray = theArray.filter( (arrayElem) => {
    var returnValue = true;
    if ( isEqual(arrayElem, valToExclude) ) {
      returnValue = false;
    }
    return returnValue;
  });

  return revisedArray;
}

function hideAllDisplays() {
  elem("dvBrowserSaveOuter").style.display = "none";
  elem("dvEditor_AddToLocInventory_Outer").style.display = "none";
  elem("dvEditor_PageAdd_Outer").style.display = "none";
  elem("dvEditor_UaAdd_Outer").style.display = "none";
  elem("dvEditor_UaDelete_Outer").style.display = "none";
  elem("dvEditor_UaEdit_Outer").style.display = "none";
  elem("dvGameOuter").style.display = "none";
  elem("dvUserInventory_Outer").style.display = "none";
  elem("dvEditor_ViewAllPages_Outer").style.display = "none";
}

function isBlank(val) {
  if(val === undefined) return true;

  if(val == null) return true;

  if(val == "0")return false;

  if(parseInt(val) == 0)return false;

  if(val == "") return true;

  if(!val)return true;

  return false;
}

function isEqual(val1, val2) {
  if ( isBlank(val1) && isBlank(val2) ) return true;
  if ( val1 == val2 ) return true;
  if ( Number(val1) == Number(val2) ) return true;
  return false;
}

function isNumeric(val) {
  if ( isBlank(val) ) return false;
  return val == val * 1;
}

function isTrue(arg) {
  if ( isBlank(arg) ) {
    return false;
  }

  if ( arg === true ) {
    return true;
  }

  if ( arg == "1" || arg == 1 ) {
    return true;
  }

  if ( String(arg).toLowerCase() == "true" ) {
    return true;
  }

  return false;
}

function left(str, numChars) {
  if (typeof str !== "string") return null;
  if ( ! isNumeric(numChars) ) return null;
  if (numChars < 0) return null;
  if ( isEqual(numChars, 0) ) return "";
  if (numChars > str.length) return str;
  var theLeft = str.substr(0, numChars);
  return theLeft;
}

function leftIs(haystack, needle) {
  if (typeof haystack !== "string") return false;
  if (typeof needle !== "string") return false;

  var lenNeedle = needle.length;

  if ( isEqual(lenNeedle, 0) ) {
    if ( isEqual(haystack.length, 0) ) {
      return true;
    } else {
      return false;
    }
  }

  var haystackLeft = left(haystack, lenNeedle);

  return isEqual(haystackLeft, needle);
}

function loadAllGameCodenames() {
  APP.allGameBrSvObjs = getBrSvObjsFromBrowserSave(C_typecode_game, null, null, null, C_att_name, null, null, null, null);
}

function loadEntites() {
  //APP.youObj.codename = C_misc_userDefName;
  //
  //APP.youObj.name = getFromBrowserSave_single(C_typecode_ent, C_misc_userDefName, C_att_name);
  //if ( isBlank(APP.youObj.name) ) {
  //  APP.youObj.name = "Person With Unknown Name";
  //  saveToBrowser(C_typecode_ent, C_misc_userDefName, C_att_name, APP.youObj.name)
  //}
  //
  //APP.youObj.locName = getFromBrowserSave_single(C_typecode_ent, C_misc_userDefName, C_att_locName);
  //
  //if ( isBlank(APP.youObj.locName) ) {
  //  moveEntityToLocation(APP.youObj, C_page_cozyRoom);
  //}
  //
  //setCurPageObj_fromPageName(APP.youObj.locName);
}

function right(str, numChars) {
  if (typeof str !== "string") return null;
  if ( ! isNumeric(numChars) ) return null;
  if (numChars < 0) return null;
  if ( isEqual(numChars, 0) ) return "";
  if (numChars > str.length) return str;
  var theRight = str.substr(str.length - numChars);
  return theRight;
}

function rightIs(haystack, needle) {
  if (typeof haystack !== "string") return false;
  if (typeof needle !== "string") return false;

  var lenNeedle = needle.length;

  if ( isEqual(lenNeedle, 0) ) {
    if ( isEqual(haystack.length, 0) ) {
      return true;
    } else {
      return false;
    }
  }

  var haystackRight = right(haystack, lenNeedle);

  return isEqual(haystackRight, needle);
}

function runCurGame() {
  runCurGame_init();

  if (APP.curPageObj && ! isBlank(APP.curPageObj.locCodename) ) {
    APP.curLocObj = getLocObj(APP.curPageObj.locCodename, null, APP.curGameObj.codename);
  }

  displayPage(APP.curPageObj);

  if (APP.dev == "1") {
    runCurGame_addDevOptions();
  }

  elem("dvGameOuter").style.display = "";
}

function runCurGame_addDevOptions() {
  var curGameName, curPageName, html = "", curPageIsLoc, curPageIsLoc_display;

  if (APP.curGameObj) {
    curGameName = APP.curGameObj.name;
  } else {
    curGameName = "(no game loaded)";
  }

  if (APP.curPageObj) {

    curPageName = APP.curPageObj.name;

    if ( ! isBlank(APP.curPageObj.locCodename) ) {
      curPageIsLoc = true;
      curPageIsLoc_display = "yes";
    } else {
      curPageIsLoc = false;
      curPageIsLoc_display = "no";
    }

  } else {

    curPageName = "(no page loaded)";

  }

  html += "<div><hr></hr></div>\n";
  html += getHtmlDownSpacer(2);
  html += "<div style='color: red'>Dev Options:"

  if ( isTrue(APP.dev_hideEditor) ) {
    html += "&nbsp;&nbsp;<a href='javascript: dev_editor__show_editor ( )'>> show dev editor</a>";
  }

  html += "</div>\n";

  if ( ! isTrue(APP.dev_hideEditor) ) {

    html += getHtmlDownSpacer(2);

    html += "<div>current game: " + curGameName;
    if (APP.curGameObj) {
      html += "&nbsp;&nbsp;<a href='javascript: dev_editor__rename_game ( )'>> rename</a>";
    }
    html += "&nbsp;&nbsp;|&nbsp;&nbsp;<a href='javascript: dev_editor__view_all_games ( )'>> view all games</a></div>\n";

    html += getHtmlDownSpacer(2);

    html += "<div>current page: " + curPageName;
    if (APP.curPageObj) {
      html += "&nbsp;&nbsp;<a href='javascript: dev_editor__rename_page ( )'>> rename</a>";
    }
    html += "&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href='javascript: dev_editor__view_all_pages ( )'>> view all pages</a>";
    html += "&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href='javascript: dev_editor__goto__create_new_page ( )'>> create new page/location</a></div>\n";

    html += getHtmlDownSpacer();

    html += "<div>current page is a location: " + curPageIsLoc + "</div>\n";

    if (curPageIsLoc) {
      html += getHtmlDownSpacer();
      html += "<div>inventory for location:</div>\n";
      html += getHtmlDownSpacer();
      html += APP.curLocObj.getInventoryListHtml();
      html += getHtmlDownSpacer();
      html += "<div>" + getHtml_a("&nbsp;> add to location's inventory", "dev_editor__goto__add_to_location_inventory", APP.curLocObj.codename) + "</div>\n";
    }

    html += getHtmlDownSpacer();

    html += "<a href='javascript: browser_save__view ( )'>> view browser saved data</a></div>\n";

    html += getHtmlDownSpacer();

    html += "<a href='javascript: dev_editor__hide_editor ( )'>> hide dev editor</a></div>\n";
  }

  elem("dvGameInner_Dev").innerHTML = html;
}

function runCurGame_init() {
  runCurGame_init_startPage();
  runCurGame_init_userEntity();
}

function runCurGame_init_startPage() {
  APP.curGame_allPageBrSvObjs = getBrSvObjsFromBrowserSave(C_typecode_page, null, null, null, C_att_gameCodename, null, APP.curGameObj.codename, null, null);

  if ( isBlank(APP.curGameObj.startPageCodename) ) {

    if (APP.curGame_allPageBrSvObjs.length == 0) {
      APP.curPageObj = getAndMakeNewPage(null, "Room 1", APP.curGameObj.codename, null, true);
    } else {
      let pageCodename = APP.curGame_allPageBrSvObjs[0].codename;
      APP.curPageObj = getPageObj(pageCodename, null, APP.curGameObj.codename);
    }

    APP.curGameObj.startPageCodename = APP.curPageObj.codename;
    APP.curGameObj.saveToBrowser();

  } else {

    APP.curPageObj = getPageObj(APP.curGameObj.startPageCodename, null, APP.curGameObj.codename);

  }
}

function runCurGame_init_userEntity() {
  var i, hasUserEnt = false;

  APP.curGame_allEntBrSvObjs = getBrSvObjsFromBrowserSave(C_typecode_ent, null, null, null, C_att_gameCodename, null, APP.curGameObj.codename, null, null);

  for (i = 0; i < APP.curGame_allEntBrSvObjs.length; i++) {
    let curEntCodename;

    curEntCodename = APP.curGame_allEntBrSvObjs[i].codename;

    if ( isEqual(curEntCodename, C_misc_userCodename + "," + APP.curGameObj.codename) ) {
      APP.userEntObj = getEntObj(curEntCodename, null, null, null, APP.curGameObj.codename);
      hasUserEnt = true;
      break;
    }
  }

  if ( ! hasUserEnt ) {
    APP.userEntObj = getAndMakeNewEnt(C_misc_userCodename + "," + APP.curGameObj.codename, true, C_misc_userDefName, APP.curGameObj.codename, APP.curGameObj.startPageCodename, APP.curPageObj.locCodename);
  }
}

function runUserAction(uatype, uaVar1) {
  switch (uatype) {

    case C_uatype_moveToLoc:
      {
        let uaObj = getUaObj(uaVar1, APP.curGameObj.codename, APP.curPageObj.codename);
        let moveToLocObj = getLocObj(uaObj.locCodename, null, APP.curGameObj.codename);
        APP.curPageObj = getPageObj(moveToLocObj.pageCodename);
        APP.userEntObj.moveToLocObj(moveToLocObj);
        displayPage(APP.curPageObj);
      }
      break;


    case C_uatype_grabItm:
        let uaObj = getUaObj(uaVar1, APP.curGameObj.codename, APP.curPageObj.codename);
      break;


    // OLD -- begin
    //
          case C_userAction_changeYourName:
            {
              let newName = getTextFromUser("New Name:", "");
              if ( ! isBlank(newName) || isEqual(APP.youObj.name, newName) ) {
                APP.youObj.name = newName;
                saveToBrowser(C_typecode_ent, C_misc_userDefName, C_att_name, APP.youObj.name)
                displayPage(C_page_info);
              }
            }
            break;

          case C_userAction_closeDoor:
            changeLocAtt(APP.curPageObj, "door", "closed");
            displayPage(APP.curPageObj);
            break;

          case C_userAction_goToInfo:
            //displayPage(C_page_info);
            break;

          case C_userAction_goToPage:
            displayPage_fromName(linkActionVar1);
            break;

          case C_userAction_openDoor:
            changeLocAtt(APP.curPageObj, "door", "open");
            displayPage(APP.curPageObj);
            break;

          case C_userAction_openInventory:
            displayUserInventory();
            break;
    //
    // OLD -- end

  
    default:
      alert("ERROR: action '" + getUatypeDisplayText(uatype) + "' was not found");
  }
}

function saveToBrowser(typecode, codename, att, val) {
  var bsk = getBrowserSaveKey(typecode, codename, att);
  
  if ( isBlank(val) ) {
    val = "";
  }

  localStorage.setItem(bsk, val);
}

function setAppSetting(settingName, val) {
  saveToBrowser(C_typecode_appSetting, settingName, null, val);
}

function setLocationAttInBrowserSave(locCodename, att, locAttVal) {
  saveToBrowser(C_typecode_loc, locCodename, att, locAttVal);
}

function setPageToNonLocation(page) {
  page.isLocation = false;
}

function sorting_objs(propNameToSortBy) {
  return function(objA, objB) {
    var comparisonCode;

    var objA_hasProp = doesObjHaveProp(objA, propNameToSortBy);
    var objB_hasProp = doesObjHaveProp(objB, propNameToSortBy);

    if ( objA_hasProp && objB_hasProp ) {
      comparisonCode = sorting_returnComparisonCode(objA[propNameToSortBy], objB[propNameToSortBy]);
    } else if ( objA_hasProp ) {
      comparisonCode = -1;
    } else if ( objB_hasProp ) {
      comparisonCode = 1;
    } else {
      comparisonCode = 0;
    }

    return comparisonCode;
  };

  /* test code for this function:

  var i, ay = [];

  var x1 = {};
  x1.thisObjName = "x1";
  // no setting x1.prop1
  ay.push(x1);

  var x2 = [];
  x2.thisObjName = "x2";
  x2.prop1 = "b";
  ay.push(x2);

  var x3 = [];
  x3.thisObjName = "x3";
  x3.prop1 = null;
  ay.push(x3);

  var x4 = [];
  x4.thisObjName = "x4";
  x4.prop1 = "";
  ay.push(x4);

  var x5 = [];
  x5.thisObjName = "x5";
  x5.prop1 = "c";
  ay.push(x5);

  var x6 = [];
  x6.thisObjName = "x6";
  x6.prop1 = "a";
  ay.push(x6);

  dc_("--------------------");

  for (i = 0; i < ay.length; i++) {
    dc_("PRE-sort: ay[" + i + "], .thisObjName=" + ay[i].thisObjName + ", .prop1=" + ay[i].prop1);
  }

  dc_("--------------------");

  ay.sort( sorting_objs("prop1") );

  for (i = 0; i < ay.length; i++) {
    dc_("POST-sort: ay[" + i + "], .thisObjName=" + ay[i].thisObjName + ", .prop1=" + ay[i].prop1);
  }

  */
}

function sorting_vals() {
  return function(valA, valB) {
    var comparisonCode = sorting_returnComparisonCode(valA, valB);
    return comparisonCode;
  };
}

function sorting_returnComparisonCode(valA, valB) {
  var comparisonCode;

  var aIsBlank = isBlank(valA);
  var bIsBlank = isBlank(valB);

  var aIsNumeric = isNumeric(valA);
  var bIsNumeric = isNumeric(valB);

  // return -1  -->  A comes before B
  // return  1  -->  B comes before A
  // return  0  -->  neither A nor B comes first

  if ( aIsBlank && bIsBlank ) {
    // both are blank, so neither comes first
    comparisonCode = 0;

  } else if (aIsBlank && !bIsBlank) {
    // A is blank, so B comes first
    comparisonCode = 1;

  } else if (!aIsBlank && bIsBlank) {
    // B is blank, so A comes first
    comparisonCode = -1;

  } else if (aIsNumeric && !bIsNumeric) {
    // A is a number, but B is not, so A comes first
    comparisonCode = -1;

  } else if (!aIsNumeric && bIsNumeric) {
    // B is a number, but A is not, so B comes first
    comparisonCode = 1;

  } else if (aIsNumeric && bIsNumeric) {

    // both are numbers...
    let valA_num = parseFloat(valA);
    let valB_num = parseFloat(valB);

    if (valA_num < valB_num) {
      // A < B numerically, so A comes first
      comparisonCode = -1;

    } else if (valA_num > valB_num) {
      // A > B numerically, so B comes first
      comparisonCode = 1;

    } else {
      // A == B numerically, so neither comes first
      comparisonCode = 0;

    }

  } else {

    // both are non-blank non-numbers, so compare as lowercase strings
    let valA_str = String(valA).toLowerCase();
    let valB_str = String(valB).toLowerCase();

    if (valA_str < valB_str) {
      // A < B by lowercase-string comparison, so A comes first
      comparisonCode = -1;

    } else if (valA_str > valB_str) {
      // A > B by lowercase-string comparison, so B comes first
      comparisonCode = 1;

    } else {
      // A == B by lowercase-string comparison, so neither comes first
      comparisonCode = 0;

    }

  }

  return comparisonCode;
}

function sortSortedCodenameAy(ay) {
  var newAy = ay.sort( sortSortedCodenameAy_sortingFunc() );
  return newAy;
}

const sortSortedCodenameAy_sortingFunc = () => {
  return (ayObjA, ayObjB) => {
    var codenameParts, codenameLeft, sortvalA, sortvalB;

    codenameParts = ayObjA.codename.split(",");
    codenameLeft = getCodenameLeft(codenameParts[0], codenameParts[1]);

    sortvalA = withoutLeft(ayObjA.codename, codenameLeft);
    sortvalB = withoutLeft(ayObjB.codename, codenameLeft);

    if ( Number(sortvalA) < Number(sortvalB) ) {
      return -1;
    } else {
      return 1;
    }
  };
};

function startApp() {
  var defGameCodename, defGameObj;

  startApp_processQueryString();

  APP.dev = getAsOneZero( getAppSetting(C_appSetting_dev) );

  //keys_startMonitoring();

  if ( getAppSetting(C_appSetting_LS) == "1" ) {
    displayBrowserSave();
    return;
  }

  APP.dev_hideEditor = getAsOneZero( getAppSetting(C_appSetting_dev_hideEditor) );

  loadAllGameCodenames();

  defGameCodename = getAppSetting(C_appSetting_defaultGameCodename);

  if ( isBlank(defGameCodename) ) {
    if (APP.allGameBrSvObjs.length > 0) {
      defGameCodename = APP.allGameBrSvObjs[0].codename;
    } else {
      defGameObj = getAndMakeNewGame("game1", "Your First Game");
      defGameCodename = defGameObj.codename;
    }
  
    setAppSetting(C_appSetting_defaultGameCodename, defGameCodename);
  }

  if ( ! defGameObj ) {
    defGameObj = getGameObj(defGameCodename);
  }

  APP.curGameObj = defGameObj;

  runCurGame();
}

function startApp_processQueryString() {
  var qs_urlParams = new URLSearchParams(window.location.search);

  if ( qs_urlParams.has(C_appSetting_dev) ) {
    setAppSetting(C_appSetting_dev, "1");
  }

  if ( qs_urlParams.has(C_appSetting_narrow) ) {
    setAppSetting(C_appSetting_narrow, "1");
  }

  if ( qs_urlParams.has(C_appSetting_LS) ) {
    setAppSetting(C_appSetting_LS, "1");
  } else {
    setAppSetting(C_appSetting_LS, "0");
  }
}

function withoutLeft(haystack, needle) {
  if (typeof haystack !== "string") return "";
  if (typeof needle !== "string") return haystack;

  var lenNeedle = needle.length;

  if (lenNeedle == 0) {
    return haystack;
  }

  var haystackLeft = left(haystack, lenNeedle);

  if ( isEqual(haystackLeft, needle) ) {
    return haystack.substr(lenNeedle);
  } else {
    return haystack;
  }
}

function withoutRight(haystack , needle) {
  if (typeof haystack !== "string") return "";
  if (typeof needle !== "string") return haystack;

  var lenNeedle = needle.length;

  if (lenNeedle == 0) {
    return haystack;
  }

  var haystackRight = right(haystack, lenNeedle);

  if ( isEqual(haystackRight, needle) ) {
    return haystack.substr(0, haystack.length - lenNeedle);
  } else {
    return haystack;
  }
}

function writeBrowserSavedData() {
  var i, keyName, keyValue, html = "", appSetting_narrow;
  var ay = [];

  appSetting_narrow = getAppSetting(C_appSetting_narrow);

  html += "<div><a href='javascript: browser_save__add_row()'>add row</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href='javascript: browser_save__refresh_view()'>refresh view</a></div>\n";
  html += "<div style='height:0.8em'></div>\n";
  html += "<table cellpadding=5 cellspacing=0 border=1>\n";

  if (localStorage.length <= 0) {
    html += "<tr><td>(no items in storage)</td></tr>\n";
  } else {
    if (appSetting_narrow == "1") {
      html += "<tr><td></td><td>\n";
      html += "  <table cellpadding=0 cellspacing=0>\n";
      html += "  <tr><td><b>Key Name</b></td></tr>\n";
      html += "  <tr><td style='height: 3px'></td></tr>\n";
      html += "  <tr><td style='height: 1px; background-color: black'></td></tr>\n";
      html += "  <tr><td style='height: 3px'></td></tr>\n";
      html += "  <tr><td><b>Key Value</b></td></tr>\n";
      html += "  </table>\n";
      html += "</td></tr>\n";
    } else {
      html += "<tr><td></td><td><b>Key Name</b></td><td><b>Key Value</b></td></tr>\n";
    }
  }

  // put localStorage into an array, for sorting
  for (i = 0; i < localStorage.length; i++) {
    let lsPair = {};
    lsPair.keyName = localStorage.key(i);
    lsPair.keyValue = localStorage.getItem(lsPair.keyName);
    ay.push(lsPair);
  }

  ay.sort( writeBrowserSavedData_sortingFunc() );

  for (i = 0; i < ay.length; i++) {
    keyName = ay[i].keyName;
    keyValue = ay[i].keyValue;

    if (appSetting_narrow == "1") {
      html += "<tr><td>\n";
      html += "  <table cellpadding=0 cellspacing=0>\n";
      html += "  <tr><td><a href='javascript: browser_save__edit_row(\"" + keyName + "\")'>edit</a></td></tr>\n";
      html += "  <tr><td style='height: 15px'></td></tr>\n";
      html += "  <tr><td><a href='javascript: browser_save__change_key_name(\"" + keyName + "\")'>change key</a></td></tr>\n";
      html += "  <tr><td style='height: 15px'></td></tr>\n";
      html += "  <tr><td><a href='javascript: browser_save__delete_row(\"" + keyName + "\")'>delete</a></td></tr>\n";
      html += "  </table>\n";
      html += "</td>\n";
    } else {
      html += "<tr><td style='white-space: nowrap'>&nbsp;<a href='javascript: browser_save__edit_row(\"" + keyName + "\")'>edit</a>\n";
      html += "&nbsp;|&nbsp;&nbsp;<a href='javascript: browser_save__change_key_name(\"" + keyName + "\")'>change key</a>\n";
      html += "&nbsp;|&nbsp;&nbsp;<a href='javascript: browser_save__delete_row(\"" + keyName + "\")'>delete</a>&nbsp;&nbsp;</td>\n";
    }

    if (appSetting_narrow == "1") {
      html += "<td>" + keyName + "</td></tr>\n";
      html += "<tr><td></td><td>" + keyValue + "</td></tr>\n";
    } else {
      html += "<td>" + keyName + "</td><td>" + keyValue + "</td></tr>\n";
    }
  }

  html += "</table>\n";
  html += "<div style='height:0.8em'></div>\n";
  html += "<div><a href='javascript: browser_save__add_row()'>add row</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href='javascript: browser_save__refresh_view()'>refresh view</a></div>\n";

  elem("dvBrowserSaveInner").innerHTML = html;
}

const writeBrowserSavedData_sortingFunc = () => {
  return (lsPairA, lsPairB) => {
    if (lsPairA.keyName.toLowerCase() < lsPairB.keyName.toLowerCase()) {
      return -1;
    } else {
      return 1;
    }
  };
};


// USER-VIEWABLE FUNCTIONS

function browser_save__add_row() {
  var keyName = prompt("\nNew key name:", "");
  var keyValue = prompt("\nNew key value:", "");

  if ( isBlank(keyName) ) {
    return undefined;
  }

  localStorage.setItem(keyName, keyValue);
  displayBrowserSave();
  return undefined;
}

function browser_save__change_key_name(curKeyName) {
  var editedKeyName, keyValue, keyValueFromEditedKeyName, warningMsg, confirmationMsg;

  //get new key name user requests
  editedKeyName = prompt("\nChange key name to:", curKeyName);

  //exit if user did not provide a new key name
  if ( isBlank(editedKeyName) ) {
    return undefined;
  }

  //grab existing key value for current key name
  keyValue = localStorage.getItem(curKeyName);

  //check to see if new requestd key name is already in use; if so, disallow
  keyValueFromEditedKeyName = localStorage.getItem(editedKeyName);
  if ( !isBlank(keyValueFromEditedKeyName) ) {
    warningMsg = "*** OPERATION DISALLOWED ***\n";
    warningMsg += "You tried to change key with keyName='" + curKeyName + "'\n";
    warningMsg += "( keyValue='" + keyValue + "' )\n";
    warningMsg += "... to the new-keyName '" + editedKeyName + "'\n";
    warningMsg += "... but that new-keyName already exists, with existing-keyValue '" + keyValueFromEditedKeyName + "'";
    alert(warningMsg);
    return undefined;
  }

  //save new key to storage
  localStorage.setItem(editedKeyName, keyValue);

  //delete previous key name
  localStorage.removeItem(curKeyName);

  //provide info with change
  confirmationMsg = "Change Made:\n\n";
  confirmationMsg += " old-keyName: " + curKeyName + "\n";
  confirmationMsg += " new-keyName " + editedKeyName + "\n";
  confirmationMsg += " keyValue: " + keyValue;
  alert(confirmationMsg);

  //refresh storage view
  displayBrowserSave();
  return undefined;
}

function browser_save__delete_all_saved_data() {
  var clearStoragePrompt;
  
  //disabling typing of "clear it" confirmation during heavy design and development phase
  //clearStoragePrompt = prompt("\ntype 'clear it' to clear local storage", "");
  //if (clearStoragePrompt == "clear it") {
  //  localStorage.clear();
  //  alert("storage cleared");
  //} else {
  //  alert("storage NOT cleared");
  //}

  if ( confirm("\nDelete all saved browser data?\n\n\n") ) {

    localStorage.clear();

    if ( confirm("\nStorage cleared.\n\nRestart app?\n\n\n") ) {
      location.reload(true);
    }

  } else {

    alert("\nOperaton canceled. Storage NOT cleared.\n\n\n");

  }

  return undefined;
}

function browser_save__delete_row(keyName) {
  if ( confirm("\nDelete this row?\n\n\n") ) {
    localStorage.removeItem(keyName);
    displayBrowserSave();
  }
  return undefined;
}

function browser_save__edit_row(keyName) {
  var curKeyValue = localStorage.getItem(keyName);

  var editedKeyValue = prompt( "\nChange key value to:", getProcessedStringForTextView(curKeyValue) );

  if ( editedKeyValue == null ) {
    return undefined;
  }

  editedKeyValue = getProcessedStringForSave(editedKeyValue);

  localStorage.setItem(keyName, editedKeyValue);
  displayBrowserSave();
  return undefined;
}

function browser_save__return_to_game() {
  elem("dvBrowserSaveOuter").style.display = "none";
  startApp();
  return undefined;
}

function browser_save__refresh_view() {
  displayBrowserSave();
  return undefined;
}

function browser_save__view() {
  displayBrowserSave();
  return undefined;
}

function dev_editor__add_text_row() {
  var textOfRow = prompt("\nEnter the text for the new text-row:", "");

  if ( isBlank(textOfRow) ) {
    return undefined;
  }

  getAndMakeNewTr(APP.curPageObj, textOfRow);

  displayPage(APP.curPageObj);

  return undefined;
}

function dev_editor__add_to_location_inventory__do_add() {
  var itmName, codename, itmObj;

  itmName = elem("ipEditor_AddToLocInventory_ItmName").value;

  if ( ! isBlank(itmName) ) {
    itmObj = getAndMakeNewItm(codename, itmName, APP.curGameObj.codename, false)

    APP.curLocObj.receiveItmObj(itmObj);
    
    runCurGame();
  }

  return undefined;
}

function dev_editor__add_to_location_inventory__cancel_add() {
  displayPage(APP.curPageObj);
  return undefined;
}

function dev_editor__add_user_action__do_add() {
  var uaText = getElemVal("ipEditor_UaAdd_UaText");
  var uatype = getElemVal("selEditor_UaAdd_Uatype");
  var itmCodename, locCodename;

  if ( isBlank(uaText) ) {
    alert("\nPlease enter 'Name of Action'\n\n\n");
    return undefined;
  }

  if ( isBlank(uatype) ) {
    alert("\nPlease select 'Action Type'\n\n\n");
    return undefined;
  }

  switch(uatype) {

    case C_uatype_grabItm:
      itmCodename = getElemVal("selEditor_UaAdd_ItmCodename");
      if ( isBlank(itmCodename) ) {
        alert("\nPlease select 'Object'\n\n\n");
        return undefined;
      }
      break;

    case C_uatype_moveToLoc:
      locCodename = getElemVal("selEditor_UaAdd_LocCodename");
      if ( isBlank(locCodename) ) {
        alert("\nPlease select 'Location'\n\n\n");
        return undefined;
      }
      break;

  }
  
  getAndMakeNewUa(APP.curPageObj, uaText, uatype, itmCodename, locCodename);

  displayPage(APP.curPageObj);

  return undefined;
}

function dev_editor__add_user_action__cancel_add() {
  displayPage(APP.curPageObj);
  return undefined;
}

function dev_editor__create_new_page__do_add() {
  var name = getElemVal("ipEditor_PageAdd_Name");

  if ( isBlank(name) ) {
    alert("\nPlease enter 'Name of Page/Location'\n\n\n");
    return undefined;
  }

  APP.curPageObj = getAndMakeNewPage(null, name, APP.curGameObj.codename, null, true);

  APP.userEntObj.moveToLocCodename(APP.curPageObj.locCodename);

  displayPage(APP.curPageObj);

  return undefined;
}

function dev_editor__create_new_page__cancel_add() {
  displayPage(APP.curPageObj);
  return undefined;
}

function dev_editor__delete_text_row(trCodename) {
  var curTextOfRow, trObj;
  
  curTextOfRow = getFromBrowserSave_single(C_typecode_tr, trCodename, C_att_textOfRow);

  if ( confirm("\nPlease confirm that you want to delete this text-row\n\n\n") ) {
    trObj = APP.curPageObj.deleteTr(trCodename);
    displayPage(APP.curPageObj);
  }

  return undefined;
}

function dev_editor__delete_user_action__do_delete() {
  var uaObj;

  uaObj = APP.curPageObj.deleteUa(APP.editor_curUaCodename);
  displayPage(APP.curPageObj);
  
  APP.editor_curUaCodename = null;

  return undefined;
}

function dev_editor__delete_user_action__cancel_delete() {
  displayPage(APP.curPageObj);
  return undefined;
}

function dev_editor__edit_user_action__do_edit() {
  var newUaText, uaObj;

  newUaText = elem("ipEditor_UaEdit_uaText").value;

  if ( ! isBlank(newUaText) ) {
    uaObj = APP.curPageObj.getUaObj(APP.editor_curUaCodename, APP.curPageObj.gameCodename, APP.curPageObj.codename);
    uaObj.uaText = newUaText;
    uaObj.saveToBrowser();
    
    APP.editor_curUaCodename = null;

    displayPage(APP.curPageObj);
  }

  return undefined;
}

function dev_editor__edit_user_action__cancel_edit() {
  displayPage(APP.curPageObj);
  return undefined;
}

function dev_editor__edit_text_row(trCodename) {
  var curTextOfRow, newTextOfRow, trObj;
  
  curTextOfRow = getFromBrowserSave_single(C_typecode_tr, trCodename, C_att_textOfRow);

  newTextOfRow = prompt("\nEnter new text:", curTextOfRow);

  if ( isBlank(newTextOfRow) ) {
    return undefined;
  }

  trObj = APP.curPageObj.getTrObj(trCodename, APP.curPageObj.codename, APP.curPageObj.gameCodename);
  trObj.textOfRow = newTextOfRow;
  trObj.saveToBrowser();

  displayPage(APP.curPageObj);

  return undefined;
}

function dev_editor__goto__add_to_location_inventory() {
  displayEditor_locInventory_add();
  return undefined;
}

function dev_editor__goto__add_user_action() {
  displayEditor_uaAdd();
  return undefined;
}

function dev_editor__goto__create_new_page() {
  displayEditor_pageAdd();
  return undefined;
}

function dev_editor__goto__delete_user_action(uaCodename) {
  APP.editor_curUaCodename = uaCodename;
  displayEditor_uaDelete(uaCodename);
  return undefined;
}

function dev_editor__goto__edit_user_action(uaCodename) {
  APP.editor_curUaCodename = uaCodename;
  displayEditor_uaEdit(uaCodename);
  return undefined;
}

function dev_editor__hide_editor() {
  setAppSetting(C_appSetting_dev_hideEditor, "1")
  startApp();
  return undefined;
}

function dev_editor__rename_game() {
  var newName;
  
  newName = prompt("\nEnter new name:", APP.curGameObj.name);

  if ( isBlank(newName) ) {
    return undefined;
  }

  APP.curGameObj.name = newName;
  APP.curGameObj.saveToBrowser();

  runCurGame();

  return undefined;
}

function dev_editor__rename_page() {
  var newName;
  
  newName = prompt("\nEnter new name:", APP.curPageObj.name);

  if ( isBlank(newName) ) {
    return undefined;
  }

  APP.curPageObj.name = newName;
  APP.curPageObj.saveToBrowser();

  runCurGame();

  return undefined;
}

function dev_editor__show_editor() {
  setAppSetting(C_appSetting_dev_hideEditor, "0")
  startApp();
  return undefined;
}

function dev_editor__view_all_games() {
  return undefined;
}

function dev_editor__view_all_pages() {
  return undefined;
}

function do_action(uatype, uaVar1) {
  runUserAction(uatype, uaVar1);
  return undefined;
}

function return_from_user_inventory() {
  runCurGame();
}


// START APP (also runs the default game)

startApp();


</script>

</body>

</html>
