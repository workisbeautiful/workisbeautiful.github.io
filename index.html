<!DOCTYPE html>
<html>

<meta name="viewport" content="width=device-width, initial-scale=1">

<head>

<style>
a {color: blue; outline: 0}
a:link {text-decoration: none}
a:visited {text-decoration: none}
a:hover {text-decoration: underline}
a:focus {text-decoration: underline}
a:active {text-decoration: none}

body {font-size: 115%}
div {padding: 0; margin: 0}
hr {display: block; height: 0; border: 0; border-top: 1em solid white; border-bottom: 0.05em solid black; margin: 0; margin-bottom: 0.15em; padding: 0}

.divider {background-color: black}
.green {color: #00CC66}
</style>

<title>wib</title>

</head>

<body>

<div>
  <span id="spnAppNameAndVersion" style="font-weight: bold; font-size: 135%">wib v0.0</span>
  &nbsp;&nbsp;<a href="javascript:void show_dev_screen()"><span style="font-size: 80%"><nowrap>dev</nowrap></span></a>
</div>
<div style="height:1.2em"></div>

<div id="dvPage_BackupExport" style="display: none">
  <div style="display: inline-block">
    <div><a href="javascript:void return_home()">return home</a></div>
    <hr></hr>
  </div>
  <div style="height:0.8em"></div>
  <textarea id="taExportedBackupText" style="height: 50vh; width: 80vw; border: 1px black solid; padding: 10px" readonly></textarea>
  <div style="height:1em"></div>
</div>

<div id="dvPage_BackupImport" style="display: none">
  <div style="display: inline-block">
    <div><a href="javascript:void return_home()">return home</a></div>
    <hr></hr>
  </div>
  <div style="height:0.8em"></div>
  <div>Paste text-to-import below:</div>
  <div style="height:0.4em"></div>
  <textarea id="taBackupTextToImport" style="height: 50vh; width: 80vw; border: 1px black solid; padding: 10px"></textarea>
  <div style="height:0.8em"></div>
  <div><a href="javascript:void begin_import()">begin import</a></div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_Dev" style="display: none">
  <div style="display: inline-block">
    <div><a href="javascript:void return_home()">return home</a></div>
    <hr></hr>
  </div>
  <div style="height:0.8em"></div>
  <div><a href="javascript:void export_backup_text()">export backup text</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void import_backup_text()">import backup text</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void toggle_import_blocked()">toggle import-backup-text blocked (for this device)</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void toggle_dev()">toggle dev mode</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void toggle_app_narrow()">toggle app narrow mode</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void show_storage()">show storage</a></div>
  <div style="height:100em"></div>
  <div><a href="javascript:void clear_storage()">clear storage</a></div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_Home" style="display: none">
  <div style="display: inline-block">
    <div><a href="javascript:void make_new_list()">make new list</a></div>
    <hr></hr>
  </div>
  <div style="height:0.8em"></div>
  <div id="dvListOfLists"></div>
  <div style="height:0.6em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.8em"></div>
    <div><a href="javascript:void make_new_list()">make new list</a></div>
  </div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_ShowStorage" style="display: none">
  <div style="display: inline-block">
    <div><a href="javascript:void return_home_from_storage()">return home</a></div>
    <hr></hr>
  </div>
  <div style="height:0.8em"></div>
  <div id="dvStorage"></div>
  <div style="height:0.6em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.8em"></div>
    <div><a href="javascript:void return_home_from_storage()">return home</a></div>
  </div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_ViewItem" style="display: none">
  <div id="dvItemName" style="font-weight: bold"></div>
  <div style="height:0.3em"></div>
  <div id="dvListNameForItem"></div>
  <div style="height:1.2em"></div>
  <div id="dvPage_ViewItem_NotDone" style="display: none">
    <div><a href="javascript:void mark_item_as_done()">mark as done</a></div>
  </div>
  <div id="dvPage_ViewItem_Done" style="display: none">
    <div><span class="green">DONE</span>&nbsp;&nbsp;<a href="javascript:void unmark_item_as_done()">unmark as done</a></div>
  </div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void rename_item()">rename item</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void delete_item()">delete item</a></div>
  <div style="height:0.6em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.9em"></div>
    <div><a href="javascript:void return_to_list()">return to list</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript:void return_home()">return to home</a></div>
  </div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_ViewList" style="display: none">
  <div id="dvListName" style="font-weight: bold"></div>
  <div style="height:0.45em"></div>
  <div><a href="javascript:void rename_list()">rename list</a></div>
  <div style="height:1.2em"></div>
  <div style="display: inline-block">
    <div><a href="javascript:void make_new_item()">make new item</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript:void return_home()">return to home</a></div>
    <div style="height:0.2em"></div>
    <hr></hr>
  </div>
  <div style="height:0.7em"></div>
  <div id="dvItems"></div>
  <div style="height:0.4em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.9em"></div>
    <div><a href="javascript:void make_new_item()">make new item</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript:void return_home()">return to home</a></div>
  </div>
  <div style="height:1em"></div>
</div>

<script type="text/javascript">

const CONST_appVersion = "0.29";

const CONST_appNarrow = "app_narrow";
const CONST_devText1 = "devText1";
const CONST_importBlocked = "importBlocked";
const CONST_listOfAllLists = "list_of_all_lists";
const CONST_storedDataVersion = "stored_data_version";

const sD = "`"; // sD = storageDivider
const sD2 = "â‰¡"; // sD2 = storageDivider2, used for text formatting during backup

var pageLoaded = false;

var app = {};

/*

example list-of-all-lists in text format
>>>  KEY    =  list_of_all_lists
>>>  VALUE  =  1`2

example list in text format:
>>>  KEY    =  list_1
>>>  VALUE  =  test list 1

example list-items in text format:
>>>  KEY    =  listItems_1
>>>  VALUE  =  1`2`3`4

example list-item in text format:
>>>  KEY    =  L1i1
>>>  VALUE  =  test item 1

*/


function addToListOfAllLists(listIdToAdd) {
  app.listIds.push(listIdToAdd);
  saveListOfAllListsToStorage();
}

function changeItem(listId, itemId, newItemName, newDone) {
  saveItemToStorage(listId, itemId, newItemName, newDone)  
}

function changeList(listId, newListName) {
  saveListInfoToStorage(listId, newListName)  
}

function createItemInfoString(itemName, done) {
  var itemInfoString = itemName + sD;

  if ( isBlank(done) ) {
    itemInfoString += "0";
  } else {
    if ( done == "1" ) {
      itemInfoString += "1";
    } else {
      itemInfoString += "0";
    }
  }

  return itemInfoString;
}

function deleteFromDatastore(itemKey) {
  localStorage.removeItem(itemKey);
}

function deleteItem(listId, itemIdToBeDeleted) {
  var itemSaveKeyText, listItemsSaveKeyText, curText_itemsIds, curArray_itemsIds, i, curArrayItemId, newText_itemIds = "";

  //delete the item from storage
  itemSaveKeyText = getSaveKeyText_Item(listId, itemIdToBeDeleted);
  deleteFromDatastore(itemSaveKeyText);

  //clear app-level current-item-id
  app.curItemId = null;

  //get current list-item values for list
  listItemsSaveKeyText = getSaveKeyText_ListItems(listId);
  curText_itemsIds = getFromDatastore(listItemsSaveKeyText);

  //convert current text-of-list-items to array
  curArray_itemsIds = curText_itemsIds.split(sD);

  //cycle through current list-items array
  for ( i = 0; i < curArray_itemsIds.length; i++) {
    curArrayItemId = curArray_itemsIds[i];
    
    //compare each existing list-item to the item-to-be-deleted
    if ( !isEqual(curArrayItemId, itemIdToBeDeleted) ) {

      //if match is not found, this is NOT our target list-item, so we can write to the current array item-id to the new text for list-items
      if ( !isBlank(newText_itemIds) ) newText_itemIds += sD
      newText_itemIds += curArrayItemId
    }
  }

  //save the edited text-of-list-items to storage
  saveToStorage(listItemsSaveKeyText, newText_itemIds);
}

function displayPage(pageName) {
  var itemInfoObject;

  elem("dvPage_Dev").style.display = "none";
  elem("dvPage_BackupExport").style.display = "none";
  elem("dvPage_BackupImport").style.display = "none";
  elem("dvPage_Home").style.display = "none";
  elem("dvPage_ShowStorage").style.display = "none";
  elem("dvPage_ViewItem").style.display = "none";
  elem("dvPage_ViewList").style.display = "none";

  elem("dvPage_" + pageName).style.display = "";

  switch (pageName) {

    case "BackupExport":
      writeBackupExport();
      break;

    case "BackupImport":
      elem("taBackupTextToImport").value = "";
      elem("taBackupTextToImport").focus();
      break;

    case "Home":
      writeListOfLists();  
      break;

    case "ViewItem":
      itemInfoObject = getItemInfoObjectFromStorage(app.curListId, app.curItemId);
      elem("dvItemName").innerHTML = itemInfoObject.itemName;
      elem("dvListNameForItem").innerHTML = "( " + getListNameFromStorage(app.curListId) + " )";
      if (itemInfoObject.done == "0") {
        elem("dvPage_ViewItem_NotDone").style.display = "";
        elem("dvPage_ViewItem_Done").style.display = "none";
      } else {
        elem("dvPage_ViewItem_NotDone").style.display = "none";
        elem("dvPage_ViewItem_Done").style.display = "";
      }

      break;

    case "ViewList":
      elem("dvListName").innerHTML = getListNameFromStorage(app.curListId);
      writeItems();
      break;

    case "ShowStorage":
      writeStorage();
      break;
  }
}

function elem(id) {
  return document.getElementById(id);
}

function getFromDatastore(itemKey) {
  var itemValue = localStorage.getItem(itemKey);
  return itemValue;
}

function getIdArray(text_ids){
  var array_ids;
  if (isBlank(text_ids)) return [];
  array_itemIds = text_ids.split(sD);
  return array_itemIds;
}

function getItemIdArrayForList(listId) {
  var listItemsSaveKeyText, text_itemIds;

  //get save-key-text for this list's list-items
  listItemsSaveKeyText = getSaveKeyText_ListItems(listId);

  //get text of list-item-ids from storage
  text_itemIds = getFromDatastore(listItemsSaveKeyText);

  //convert to array and return
  return getIdArray(text_itemIds);
}

function getItemInfoObjectFromStorage(listId, itemId) {
  var itemInfoObj, itemInfoString, itemInfoArray;

  //set item-info-object to a new object
  itemInfoObj = {};

  //get the item-info-string from storage
  itemInfoString = getItemInfoStringFromStorage(listId, itemId);

  //split the item-info-string into an array
  itemInfoArray = itemInfoString.split(sD);

  //set item-info-object's properties from the string
  itemInfoObj.itemName = itemInfoArray[0];
  itemInfoObj.done = itemInfoArray[1];

  //return the object that has been populated with item-info values
  return itemInfoObj;
}

function getItemInfoStringFromStorage(listId, itemId) {
  return getFromDatastore(getSaveKeyText_Item(listId, itemId));
}

function getListInfoStringFromStorage(listId) {
  return getFromDatastore(getSaveKeyText_List(listId));
}

function getListInfoObjectFromStorage(listId) {
  var listInfoObj, listInfoString, listInfoArray;

  //set list-info-object to a new object
  listInfoObj = {};

  //get the list-info-string from storage
  listInfoString = getListInfoStringFromStorage(listId);

  //split the list-info-string into an array
  listInfoArray = listInfoString.split(sD);

  //set list-info-object's properties from the string
  listInfoObj.listName = listInfoArray[0];

  //return the object that has been populated with list-info values
  return listInfoObj;
}

function getListNameFromStorage(listId) {
  listName = getFromDatastore(getSaveKeyText_List(listId));
  return listName;
}

function getMaxItemIdForList(listId) {
  var array_itemIds, i, curItemId, curMaxItemId = -1;

  array_itemIds = getItemIdArrayForList(listId);

  //grab max item-id
  for (i = 0; i < array_itemIds.length; i++) {
    curItemId = array_itemIds[i];
    if (curItemId > curMaxItemId) curMaxItemId = curItemId;
  }
  
  return curMaxItemId;
}

function getSaveKeyText_Item(listId, itemId) {
  return listId + "_" + itemId;
}

function getSaveKeyText_List(listId) {
  return "list_" + listId;
}

function getSaveKeyText_ListItems(listId) {
  return "listItems_" + listId;
}

function importBackupText(textToImport) {
  var i, keyValuePairs, keyName, keyValue;

  //split storage-keys from text-to-import string
  keyValuePairs = textToImport.split(sD2);

  //if we don't have an even number of items, there is a mismatch of key/value pairs
  if (keyValuePairs.length % 2 > 0) {
    alert("uneven number of key/value pairs, operation canceled");
    return;
  }

  //clear existing storage
  if ( !confirm("About to clear existing storage, in order to proceed with import. Continue?") ) {
    return
  }
  localStorage.clear();

  //do the import
  for (i = 0; i < keyValuePairs.length; i = i + 2) {
    keyName = keyValuePairs[i];
    keyValue = keyValuePairs[i+1];
//if(!confirm("would make:\nkeyName: "+keyName+"\nkeyValue: "+keyValue+"\n\nexisting keyValue: "+getFromDatastore(keyName)))return
    localStorage.setItem(keyName, keyValue);
//if(!confirm("just added:\nkeyName: "+keyName+"\n\nnow, when re-grabbed from localStorage it is: "+getFromDatastore(keyName)))return
  }

  alert("Import complete");

  //refresh app and go to home page
  loadAppData();
  displayPage("Home");
}

function isBlank(val) {
  if(val == undefined) return true;
  if(val == null) return true;
  if(val == "") return true;
  if(val == 0)return false;
  if(!val)return true;
  return false;
}

function isDev() {
  if ( getFromDatastore(CONST_devText1) == "1" ) {
    return true;
  } else {
    return false;
  }
}

function isEqual(val1, val2) {
  if ( isBlank(val1) && isBlank(val2) ) return true;
  if ( val1 == val2 ) return true;
  if ( Number(val1) == Number(val2) ) return true;
  return false;
}

function itemFactory(listId, itemName) {
  var curMaxItemId, newItemId, listItemsSaveKeyText, curText_itemsIds, newText_itemIds = "";

  //get new list-item-id and manage list-item-id counter
  curMaxItemId = getMaxItemIdForList(listId);
  newItemId = Number(curMaxItemId) + 1;

  //save item to storage
  saveItemToStorage(listId, newItemId, itemName, "0");

  //set new list item values for list
  listItemsSaveKeyText = getSaveKeyText_ListItems(listId);
  curText_itemsIds = getFromDatastore(listItemsSaveKeyText);
  if (isBlank(curText_itemsIds)) {
    newText_itemIds = newItemId;
  } else {
    newText_itemIds = curText_itemsIds + sD + newItemId;
  }
  saveToStorage(listItemsSaveKeyText, newText_itemIds);
}

function listFactory(listName) {
  var listId;

  //get new list-id and manage list-id counter
  app.maxListId++;
  listId = app.maxListId;

  //save list to storage
  saveListInfoToStorage(listId, listName);
  saveListItemIdsToStorage(listId, "");

  //change list-of-all-lists
  addToListOfAllLists(listId);
}

function makeNewItem(listId, itemName) {
  //confirm item name
  if (!itemName) itemName = prompt("new list item:","");
  if (!itemName) return;

  //create and save item
  itemFactory(listId, itemName);
}

function makeNewList(listName) {
  //confirm list name
  if (!listName) listName = prompt("new list name:","");
  if (!listName) return;

  //create and save list
  listFactory(listName);
}

function saveListInfoToStorage(listId, listName) {
  saveToStorage(getSaveKeyText_List(listId), listName);
}

function saveListItemIdsToStorage(listId, text_itemIds) {
  if (isBlank(text_itemIds)) {
    saveToStorage(getSaveKeyText_ListItems(listId), "");
  } else {
    saveToStorage(getSaveKeyText_ListItems(listId), text_itemIds);
  }
}

function saveItemToStorage(listId, itemId, itemName, done) {
  var itemInfoString = createItemInfoString(itemName, done);
  saveToStorage(getSaveKeyText_Item(listId, itemId), itemInfoString);
}

function saveListOfAllListsToStorage() {
  var textOfListOfAllLists = "", i, curListId;

  for (i = 0; i < app.listIds.length; i++) {
    if ( ! isBlank(textOfListOfAllLists) ) textOfListOfAllLists += sD;
    curListId = app.listIds[i];
    textOfListOfAllLists += curListId;
  }
  
  saveToStorage(CONST_listOfAllLists, textOfListOfAllLists);
}

function saveToStorage(itemKey, itemValue) {
  localStorage.setItem(itemKey, itemValue);
}

function writeBackupExport() {
  var i, keyName, txt = "";

  for (i = 0; i < localStorage.length; i++){
    keyName = localStorage.key(i);
    keyValue = localStorage.getItem(keyName);

    if (i > 0) txt += sD2;

    txt += keyName + sD2 + keyValue;
  }

  elem("taExportedBackupText").value = txt;
  elem("taExportedBackupText").select();
}

function writeItems() {
  var array_itemIds, i, html = "", curItemId, curItemInfoObj, addedDevHtml = "";

  //added dev html for debugging
  // if ( isDev() ) addedDevHtml = " style='border: 1px red solid'";

  //get array of item-ids for the current app-list
  array_itemIds = getItemIdArrayForList(app.curListId);

  //open html table
  html += "<table cellspacing=0 cellpadding=0>\n";

  //loop through array to write list in HTML
  for (i = 0; i < array_itemIds.length; i++){
    curItemId = array_itemIds[i];

    if (i > 0) {
      html += "<tr><td style='height: 1.2em'></td><td></td></tr>\n";
    }

    //call the function that grabs the current item's item-info from storage and returns it as a js-object
    curItemInfoObj = getItemInfoObjectFromStorage(app.curListId, curItemId);

    //set html based on item-info values stored as properties of the item-info-js-object
    html += "<tr><td>\n";
    html += " <table cellspacing=0 cellpadding=0>\n";
    html += " <tr style='height: 2px'><td></td></tr>\n";
    html += " <tr><td style='color: black; font-size: 125%'>&bull;</td></tr>\n";
    html += " </table\n";
    html += "</td><td style='width: 0.5em'></td><td><a" ;
    if (curItemInfoObj.done == "1") html += " class='green'";
    html += " href='javascript:void click_item(\"" + curItemId + "\")'>" + curItemInfoObj.itemName + "</a></td></tr>\n";
  }

  if (array_itemIds.length == 0) html = "<tr><td>(no items)</td></tr>";

  html += "</table\n";

  //write to screen
  elem("dvItems").innerHTML = html;
}

function writeListOfLists() {
  var i, html = "", curListId, curListName;

  for (i = 0; i < app.listIds.length; i++){
    if (i > 0) html += "<div style='height:1.2em'></div>\n"
    curListId = app.listIds[i];
    curListName = getListNameFromStorage(curListId);
    html += "<div style=''><a href='javascript:void click_list(\"" + curListId + "\")'>" + curListName + "</a></div>";
  }
  if (isBlank(html)) html = "(no lists)";
  elem("dvListOfLists").innerHTML = html;
}

function writeStorage() {
  var i, keyName, keyValue, html = "", curListId, curListName, appNarrow;

  appNarrow = getFromDatastore(CONST_appNarrow);

  html += "<div><a href='javascript:void add_storage_row()'>add</a></div>\n";
  html += "<div style='height:0.8em'></div>\n";
  html += "<table cellpadding=5 cellspacing=0 border=1>\n";

  if (localStorage.length <= 0) {
    html += "<tr><td>(no items in storage)</td></tr>\n";
  } else {
    if (appNarrow == "1") {
      html += "<tr><td></td><td>\n";
      html += "  <table cellpadding=0 cellspacing=0>\n";
      html += "  <tr><td><b>Key Name</b></td></tr>\n";
      html += "  <tr><td style='height: 3px'></td></tr>\n";
      html += "  <tr><td style='height: 1px; background-color: black'></td></tr>\n";
      html += "  <tr><td style='height: 3px'></td></tr>\n";
      html += "  <tr><td><b>Key Value</b></td></tr>\n";
      html += "  </table>\n";
      html += "</td></tr>\n";
    } else {
      html += "<tr><td></td><td><b>Key Name</b></td><td><b>Key Value</b></td></tr>\n";
    }
  }

  for (i = 0; i < localStorage.length; i++) {
    keyName = localStorage.key(i);
    keyValue = getFromDatastore(keyName);

    if (appNarrow == "1") {
      html += "<tr><td>\n";
      html += "  <table cellpadding=0 cellspacing=0>\n";
      html += "  <tr><td><a href='javascript:void edit_storage_row(\"" + keyName + "\")'>edit</a></td></tr>\n";
      html += "  <tr><td style='height: 15px'></td></tr>\n";
      html += "  <tr><td><a href='javascript:void change_storage_key_name(\"" + keyName + "\")'>change key</a></td></tr>\n";
      html += "  <tr><td style='height: 15px'></td></tr>\n";
      html += "  <tr><td><a href='javascript:void delete_storage_row(\"" + keyName + "\")'>delete</a></td></tr>\n";
      html += "  </table>\n";
      html += "</td>\n";
    } else {
      html += "<tr><td>&nbsp;<a href='javascript:void edit_storage_row(\"" + keyName + "\")'>edit</a>\n";
      html += "&nbsp;|&nbsp;&nbsp;<a href='javascript:void change_storage_key_name(\"" + keyName + "\")'>change key</a>\n";
      html += "&nbsp;|&nbsp;&nbsp;<a href='javascript:void delete_storage_row(\"" + keyName + "\")'>delete</a>&nbsp;&nbsp;</td>\n";
    }

    if (appNarrow == "1") {
      html += "<td>" + keyName + "</td></tr>\n";
      html += "<tr><td></td><td>" + keyValue + "</td></tr>\n";
    } else {
      html += "<td>" + keyName + "</td><td>" + keyValue + "</td></tr>\n";
    }
  }

  html += "</table>\n";
  html += "<div style='height:0.8em'></div>\n";
  html += "<div><a href='javascript:void add_storage_row()'>add</a></div>\n";

  elem("dvStorage").innerHTML = html;
}


///// FUNCTIONS FROM HTML PAGE

function add_storage_row() {
  var keyName = prompt("New key name:", "");
  var keyValue = prompt("New key value:", "");

  if ( isBlank(keyName) ) {
    return;
  }

  saveToStorage(keyName, keyValue);
  show_storage();
}

function begin_import() {
  var textToImport = elem("taBackupTextToImport").value;
  if ( isBlank(textToImport) ) return;
  importBackupText(textToImport);
}

function change_storage_key_name(curKeyName) {
  var editedKeyName, keyValue, keyValueFromEditedKeyName, warningMsg, confirmationMsg;

  //get new key name user requests
  editedKeyName = prompt("Change key name to:", curKeyName);

  //exit if user did not provide a new key name
  if ( isBlank(editedKeyName) ) {
    return;
  }

  //grab existing key value for current key name
  keyValue = getFromDatastore(curKeyName);

  //check to see if new requestd key name is already in use; if so, disallow
  keyValueFromEditedKeyName = getFromDatastore(editedKeyName);
  if ( !isBlank(keyValueFromEditedKeyName) ) {
    warningMsg = "*** OPERATION DISALLOWED ***\n";
    warningMsg += "You tried to change key with keyName='" + curKeyName + "'\n";
    warningMsg += "( keyValue='" + keyValue + "' )\n";
    warningMsg += "... to the new-keyName '" + editedKeyName + "'\n";
    warningMsg += "... but that new-keyName already exists, with existing-keyValue '" + keyValueFromEditedKeyName + "'";
    alert(warningMsg);
    return;
  }

  //save new key to storage
  saveToStorage(editedKeyName, keyValue);

  //delete previous key name
  deleteFromDatastore(curKeyName);

  //provide info with change
  confirmationMsg = "Change Made:\n\n";
  confirmationMsg += " old-keyName: " + curKeyName + "\n";
  confirmationMsg += " new-keyName " + editedKeyName + "\n";
  confirmationMsg += " keyValue: " + keyValue;
  alert(confirmationMsg);

  //refresh storage view
  show_storage();
}

function clear_storage() {
  var clearStoragePrompt;
  
  clearStoragePrompt = prompt("type 'clear it' to clear local storage", "");

  if (clearStoragePrompt == "clear it") {
    localStorage.clear();
    alert("storage cleared");
    loadAppData();
    displayPage("Home");
  } else {
    alert("storage NOT cleared");
  }
}

function click_item(itemId) {
  go_to_item(itemId);
}

function click_list(listId) {
  go_to_list(listId);
}

function delete_item() {
  if ( confirm("Delete this item?") ) {
    deleteItem(app.curListId, app.curItemId);
    go_to_list(app.curListId);
  }
}

function delete_storage_row(keyName) {
  if ( confirm("Delete this row?") ) {
    deleteFromDatastore(keyName);
    show_storage();
  }
}

function edit_storage_row(keyName) {
  var curKeyValue = getFromDatastore(keyName);
  var editedKeyValue = prompt("Change key value to:", curKeyValue);

  if ( isBlank(editedKeyValue) ) {
    return;
  }

  saveToStorage(keyName, editedKeyValue);
  show_storage();
}

function export_backup_text() {
  displayPage("BackupExport");
}

function go_to_item(itemId) {
  app.curItemId = itemId;
  displayPage("ViewItem");
}

function go_to_list(listId) {
  app.curListId = listId;
  displayPage("ViewList");
}

function import_backup_text() {
  if ( getFromDatastore(CONST_importBlocked) == "1" ) {
    alert("OPERATION DISALLOWED\n\nImporting of text has been blocked on this device");
    return;
  }
  displayPage("BackupImport");
}

function mark_item_as_done() {
  var curItemObj = getItemInfoObjectFromStorage(app.curListId, app.curItemId);
  changeItem(app.curListId, app.curItemId, curItemObj.itemName, "1");
  go_to_item(app.curItemId);
}

function make_new_item() {
  makeNewItem(app.curListId);
  writeItems();
}

function make_new_list() {
  makeNewList();
  writeListOfLists();
}

function rename_item() {
  var curItemObj = getItemInfoObjectFromStorage(app.curListId, app.curItemId);
  var editedItemName = prompt("Change item name to:", curItemObj.itemName);
  if ( isBlank(editedItemName)) return;
  changeItem(app.curListId, app.curItemId, editedItemName, curItemObj.done);
  go_to_item(app.curItemId);
}

function rename_list() {
  var curListObj = getListInfoObjectFromStorage(app.curListId);
  var editedListName = prompt("Change list name to:", curListObj.listName);
  if ( isBlank(editedListName)) return;
  changeList(app.curListId, editedListName);
  go_to_list(app.curListId);
}

function return_home() {
  displayPage("Home");
}

function return_home_from_storage() {
  loadAppData();
  displayPage("Home");
}

function return_to_list() {
  go_to_list(app.curListId);
}

function show_dev_screen() {
  displayPage("Dev");
}

function show_storage() {
  displayPage("ShowStorage");
}

function toggle_app_narrow() {
  var curAppNarrow, newAppNarrow;

  curAppNarrow = getFromDatastore(CONST_appNarrow);

  if ( curAppNarrow == "1" ) {
    newAppNarrow = "0";
  } else {
    newAppNarrow = "1";
  }

  saveToStorage(CONST_appNarrow, newAppNarrow);

  alert("app_narrow set to " + newAppNarrow);
}

function toggle_import_blocked() {
  var curImportBlocked, newImportBlocked;

  curImportBlocked = getFromDatastore(CONST_importBlocked);

  if ( curImportBlocked == "1" ) {
    newImportBlocked = "0";
  } else {
    newImportBlocked = "1";
  }

  saveToStorage(CONST_importBlocked, newImportBlocked);

  alert("importBlocked set to " + newImportBlocked);
}

function toggle_dev() {
  var curDevText1, newDevText1;

  curDevText1 = getFromDatastore(CONST_devText1);

  if ( curDevText1 == "1" ) {
    newDevText1 = "0";
  } else {
    newDevText1 = "1";
  }

  saveToStorage(CONST_devText1, newDevText1);

  alert("devText1 set to " + newDevText1);
}

function unmark_item_as_done() {
  var curItemObj = getItemInfoObjectFromStorage(app.curListId, app.curItemId);
  changeItem(app.curListId, app.curItemId, curItemObj.itemName, "0");
  go_to_item(app.curItemId);
}


///// TEMP ---- seed storage with a list
/*
localStorage.clear();
saveToStorage(CONST_listOfAllLists, "1");
saveToStorage(getSaveKeyText_List(1), "main");
saveToStorage(getSaveKeyText_ListItems(1), "1");
saveToStorage(getSaveKeyText_Item(1, 1), "wib list functional");
*/


///// LOAD APP-LEVEL DATA FROM STORAGE
function loadAppData() {
  var text_listOfAllLists, curListId, i;

  //reset to starting values for app-level variables
  app.listIds = null
  app.maxListId = -1;
  app.curListId = null;
  app.curItemId = null;

  //set version# on screen
  elem("spnAppNameAndVersion").innerHTML = "wib v" + CONST_appVersion;

  //grab text of list-of-all-lists from storage
  text_listOfAllLists = getFromDatastore(CONST_listOfAllLists);

  if ( isBlank(text_listOfAllLists) ) {

    //if text list-of-all-lists DOES NOT exist, set the app-level list-of-all-lists array to an empty array
    app.listIds = [];

  } else {

    //if text list-of-all-lists DOES exist ... 

    // ... (1) populate the app-level list-of-all-lists array by splitting the list-of-all-lists text that was pulled from storage  
    app.listIds = text_listOfAllLists.split(sD);

    // ... (2) cycle through the new array and set app.maxListId
    for (i = 0; i < app.listIds.length; i++) {
      curListId = app.listIds[i];
      if (curListId > app.maxListId) app.maxListId = curListId;
    }
  }

  //update stored-data
  upgradeStoredData();
}

function upgradeStoredData() {
  var appVersion_array, appVersion_major, appVersion_minor;
  var storedDataVersion_text, storedDataVersion_array, storedDataVersion_major, storedDataVersion_minor;

  //split app-version into major and minor
  appVersion_array = CONST_appVersion.split(".");
  appVersion_major = Number(appVersion_array[0]);
  appVersion_minor = Number(appVersion_array[1]);

  //establish existing version of the stored data
  storedDataVersion_text = getFromDatastore(CONST_storedDataVersion);
  if ( isBlank(storedDataVersion_text) ) storedDataVersion_text = "0.0";
  
  //split stored-data-version into major and minor
  storedDataVersion_array = storedDataVersion_text.split(".");
  storedDataVersion_major =  Number(storedDataVersion_array[0]);
  storedDataVersion_minor =  Number(storedDataVersion_array[1]);

  //warning if major version differs
  if ( !isEqual(appVersion_major, storedDataVersion_major) ) {
    alert("WARNING: app version is " + appVersion_major + ", stored data version is " + storedDataVersion_major + " ... no automatic data update available yet for major version upgrades");
    return;
  }

  if (appVersion_minor >= 15 && storedDataVersion_minor < 15) {
    //upgrade from pre-0.15 to 0.15
    upgradeStoredData_0_15();
  }
}

function upgradeStoredData_0_15() {
  var i, j, curListId, curItemIds, curItemId, curItemInfoString, newItemInfoString, curItemSaveKeyText;

  //cycle through each list
  for (i = 0; i < app.listIds.length; i++) {
    curListId = app.listIds[i];
    
    //get array of item-ids for the current list
    curItemIds = getItemIdArrayForList(curListId);

    //loop through array of item-ids to upgrade each item's stored-data
    for (j = 0; j < curItemIds.length; j++){
      curItemId = curItemIds[j];

      //get existing item-info-string (which will be just itemName)
      curItemInfoString = getItemInfoStringFromStorage(curListId, curItemId);

      //add the 'done' value of '0' to the string
      newItemInfoString = curItemInfoString + sD + "0";

      //save the revised string to storage
      curItemSaveKeyText = getSaveKeyText_Item(curListId, curItemId);
      saveToStorage(curItemSaveKeyText, newItemInfoString);
    }
  }

  //update the stored-data's version to 0.15
  saveToStorage(CONST_storedDataVersion, "0.15");
}

loadAppData();


///// LOAD HOME PAGE

displayPage("Home");

pageLoaded = true;

</script>

</body>
</html>
