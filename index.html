<!DOCTYPE html>
<html>

<meta name="viewport" content="width=device-width, initial-scale=1">

<head>

<style>
* {box-sizing: border-box}

a {color: blue; outline: 0}
a:link {text-decoration: none}
a:visited {text-decoration: none}
a:hover {text-decoration: underline}
a:focus {text-decoration: underline}
a:active {text-decoration: none}

body {font-size: 110%; font-family: Helvetica}
div {padding: 0; margin: 0}
input {font-size: 100%; font-family: Helvetica; background-color: #f9f9f9; padding-left: 2px; padding-right: 2px}
select {font-size: 100%; font-family: Helvetica; background-color: #f9f9f9; padding-left: 2px; padding-right: 2px}
table {}

.grid1 {display: grid; grid-template-columns: auto auto auto; padding: 0.5em; padding-right: 0.75em; padding-bottom: 0.65em}
.grid1Cell {/* border: 1px solid red */}
.gc1Header {grid-column: 1/4; padding-bottom: 0.5em; border-bottom: 1px gray solid; text-align: center}
.gc1VertSpace1 {grid-column: 1/4; padding-bottom: 1em}
.gc1VertSpace2 {grid-column: 1/4; padding-bottom: 1em}
.gc1Text {white-space: nowrap; padding-right: 0.8em; padding-top: 3px; text-align: right}
.gc1TextForCheckbox {grid-column: 1/3; padding-right: 0.8em; text-align: right}
.gc1Input {grid-column: 2/4}
.gc1Select {grid-column: 2/4}
.gc1Checkbox {padding-top: 0px /* 2px top padding looked even on PC, but not on Android */}
.gc1CheckboxFirst {padding-right: 4em}
.gc1Footer {grid-column: 1/4; text-align: center}

.grid2 {display: inline-grid; grid-template-columns: auto auto}
.grid2Cell {/* border: 1px red solid */}
.gc2Header {grid-column: 1/3; padding-bottom: 0.5em; border-bottom: 1px gray solid; text-align: left}
.gc2VertSpace1 {grid-column: 1/3; padding-bottom: 0.6em}
.gc2VertSpace2 {grid-column: 1/3; padding-bottom: 0.6em}
.gc2TextLeft {white-space: nowrap; padding-right: 0.8em; /* padding-top: 3px; */ text-align: right}
.gc2TextLeftForCheckbox {grid-column: 1/3; padding-right: 0.8em; text-align: right}
.gc2TextRight {white-space: nowrap}
.gc2Input {}
.gc2Select {}
.gc2Checkbox {padding-top: 0px /* vertical alignment with left-hand cell was slightly above/beloweven on PC vs. Android, so leaving at 0 for now */}
.gc2CheckboxFirst {padding-right: 4em}
.gc2Footer {grid-column: 1/3; text-align: left}

.green {color: #00CC66}




input.timeX (background-color: yellow}
/*
input.timeX (width: 2em; padding-top: 2px; text-align: center}
*/





</style>

<title>wib</title>

</head>

<body>

<div id="dvMainViewOverlay">

<div>
  <span id="spnAppNameAndVersion" style="font-weight: bold; font-size: 135%">wib v0.0</span>
  &nbsp;&nbsp;<a href="javascript:void show_dev_screen()"><span style="font-size: 80%"><nowrap>dev</nowrap></span></a>
</div>
<div style="height:1.2em"></div>

<div id="dvPage_BackupExport" style="display: none">
  <div style="display: inline-block">
    <div><a href="javascript:void return_home()">return home</a></div>
    <div style="height:1em"></div>
    <table cellspacing=0 cellpadding=0>
    <tr><td style="height: 20px; background-color: red"></td></tr>
    </table>
    <div style="height:1em"></div>
  </div>
  <div style="height:0.8em"></div>
  <textarea id="taExportedBackupText" style="height: 50vh; width: 80vw; border: 1px black solid; padding: 10px"></textarea>
  <div style="height:0.8em"></div>
  <div><a href="javascript:void copy_imported_text_to_clipboard()">copy to clipboard</a></div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_BackupImport" style="display: none">
  <div style="display: inline-block">
    <div><a href="javascript:void return_home()">return home</a></div>
    <div style="height:1em"></div>
    <table cellspacing=0 cellpadding=0">
    <tr><td class="divider"></td></tr>
    </table>
    <div style="height:1em"></div>
  </div>
  <div style="height:0.8em"></div>
  <div>Paste text-to-import below:</div>
  <div style="height:0.4em"></div>
  <textarea id="taBackupTextToImport" style="height: 50vh; width: 80vw; border: 1px black solid; padding: 10px"></textarea>
  <div style="height:0.8em"></div>
  <div><a href="javascript:void begin_import()">begin import</a></div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_Dev" style="display: none">
  <div style="display: inline-block">
    <div><a href="javascript:void return_home()">return home</a></div>
    <div style="height:1em"></div>
    <table cellspacing=0 cellpadding=0">
    <tr><td class="divider"></td></tr>
    </table>
    <div style="height:1em"></div>
  </div>
  <div style="height:0.8em"></div>
  <div><a href="javascript:void export_backup_text()">export backup text</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void import_backup_text()">import backup text</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void toggle_import_blocked()">toggle import-backup-text blocked (for this device)</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void toggle_dev()">toggle dev mode</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void toggle_app_narrow()">toggle app narrow mode</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void show_storage()">show storage</a></div>
  <div style="height:100em"></div>
  <div><a href="javascript:void clear_storage()">clear storage</a></div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_GrabbingMove" style="display: none">
  <div><i>from list:</i>&nbsp;&nbsp;&nbsp;<span id="spnGrabbingMove_FromList"></span></div>
  <div style="height:1.5em"></div>
  <div><i>moving these items:</i></div>
  <div style="height:0.8em"></div>
  <div style="display: inline-block">
    <div style="border-bottom: 1px black solid"></div>
    <div style="height:1em"></div>
    <div id="dvGrabbingMove_Items"></div>
    <div style="height:1em"></div>
    <div style="border-bottom: 1px black solid"></div>
  </div>
  <div style="height:1.5em"></div>
  <div><i>to which list?</i>&nbsp;&nbsp;&nbsp;<a href="javascript:void cancel_move()"><nowrap>cancel</nowrap></a></div>
  <div style="height:0.8em"></div>
  <div style="display: inline-block">
    <div style="border-bottom: 1px black solid"></div>
    <div style="height:1em"></div>
    <div id="dvGrabbingMove_ListOptions"></div>
    <div style="height:1em"></div>
    <div style="border-bottom: 1px black solid"></div>
  </div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_Home" style="display: none">
  <div style="font-weight: bold">Home</div>
  <div style="height:0.8em"></div>
  <div>
    <a href="javascript:void make_new_list()" style="white-space: nowrap">make new list</a>
    &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript:void show_types()" style="white-space: nowrap">show types</a>
  </div>
  <div style="height: 1em"></div>
  <div style="height: 5px; border: 2px solid #AAAAAA">
    <div style="height: 1px; background-color: #DDDDDD"></div>
  </div>
  <div style="height: 1.4em"></div>
  <div id="dvHome_Items"></div>
  <div style="height: 0.4em"></div>
  <div style="height: 5px; border: 2px solid #AAAAAA">
    <div style="height: 1px; background-color: #DDDDDD"></div>
  </div>
  <div style="height: 1em"></div>
  <div><a href="javascript:void make_new_list()">make new list</a></div>
  <div style="height: 1em"></div>
</div>

<div id="dvPage_ShowStorage" style="display: none">
  <div style="display: inline-block">
    <div><a href="javascript:void return_home_from_storage()">return home</a></div>
    <hr></hr>
  </div>
  <div style="height:0.8em"></div>
  <div id="dvStorage"></div>
  <div style="height:0.6em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.8em"></div>
    <div><a href="javascript:void return_home_from_storage()">return home</a></div>
  </div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_WibTypes" style="display: none">
  <div style="font-weight: bold; color: red">Types</div>
  <div style="height: 0.8em"></div>
  <div>
    <a href="javascript:void make_new_type()" style="white-space: nowrap">make new type</a>
    &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript:void return_home()" style="white-space: nowrap">home</a>
  </div>
  <div style="height: 1em"></div>
  <div style="height: 5px; border: 2px solid #AAAAAA">
    <div style="height: 1px; background-color: #DDDDDD"></div>
  </div>
  <div style="height: 1.4em"></div>
    <div id="dvWibTypes_Items"></div>
  <div style="height: 0.4em"></div>
  <div style="height: 5px; border: 2px solid #AAAAAA">
    <div style="height: 1px; background-color: #DDDDDD"></div>
  </div>
  <div style="height: 1em"></div>
  <div>
    <a href="javascript:void make_new_type()" style="white-space: nowrap">make new type</a>
    &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript:void return_home()" style="white-space: nowrap">home</a>
  </div>
  <div style="height: 1em"></div>
</div>

<div id="dvPage_ViewItem" style="display: none">
  <div id="dvItemName" style="font-weight: bold"></div>
  <div id="dvPage_ViewItem_JoinedListsArea" style="display: none">
    <div style="height: 0.3em"></div>
    <div id="dvListNameForItem"></div>
  </div>
  <div style="height: 0.95em"></div>
  <div style="height: 5px; border: 2px solid #AAAAAA">
    <div style="height: 1px; background-color: #DDDDDD"></div>
  </div>
  <div style="height: 0.95em"></div>
  <div><a href="javascript:void add_connected_item()" style="white-space: nowrap">add connected item</a></div>
  <div style="height: 0.95em"></div>
  <div id="dvViewItem_ConnectedItems_Items"></div>
  <div style="height: 0.95em"></div>
  <div style="height: 5px; border: 2px solid #AAAAAA">
    <div style="height: 1px; background-color: #DDDDDD"></div>
  </div>
  <div style="height: 0.95em"></div>
  <div>
    <div>
      <span id="spnPage_ViewItem_NotDone"><a href="javascript:void mark_item_as_done()" style="white-space: nowrap">mark done</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;</span>
      <span id="spnPage_ViewItem_Done"><span class="green">DONE</span>&nbsp;&nbsp;<a href="javascript:void unmark_item_as_done()" style="white-space: nowrap">unmark</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;</span>
      <span id="spnMoveToDifferentList" style="display: none">
        <a id="aMoveToDifferentList" href="javascript:void move_to_different_list()" style="white-space: nowrap">move</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;
      </span>
      <span id="spnViewItem_ShowWibTypes">
        <a href="javascript:void show_types()" style="white-space: nowrap">back to types</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;
      </span>
      <a href="javascript:void return_home()" style="white-space: nowrap">home</a>
    </div>
    <div style="height: 1.4em"></div>
    <div>
      <a href="javascript:void rename_item()"><nowrap>rename</nowrap></a>
      <span id="spnViewItem_Delete">
        &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript:void delete_item()"><nowrap>delete</nowrap></a>
      </span>
      <span id="spnViewItem_Notes_No" style="display: none">
        &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript:void add_notes()"><nowrap>add notes</nowrap></a>
      </span>
    </div>
  </div>
  <div id="dvViewItem_Notes_Yes" style="display: none">
    <div style="height: 0.95em"></div>
    <div style="height: 5px; border: 2px solid #AAAAAA">
      <div style="height: 1px; background-color: #DDDDDD"></div>
    </div>
    <div style="height: 0.95em"></div>
    <div id="dvViewItem_Notes"></div>
    <div style="height: 0.2em"></div>
    <div>
      <a style="white-space: nowrap" href="javascript:void edit_notes()">edit notes</a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a style="white-space: nowrap" href="javascript:void delete_notes()">delete notes</a>
    </div>
  </div>
  <div id="dvViewItem_WibTypes" style="display: none">
    <div style="height: 0.95em"></div>
    <div style="height: 5px; border: 2px solid #AAAAAA">
      <div style="height: 1px; background-color: #DDDDDD"></div>
    </div>
    <div style="height: 0.95em"></div>
    <div><a href="javascript:void assign_item_to_type()" style="white-space: nowrap">assign this item to a type</a></div>
    <div style="height: 0.95em"></div>
    <div id="dvViewItem_WibTypes_Items"></div>
  </div>
  <div id="dvViewItem_WibTypeInfoFieldInfo" style="display: none">
    <div style="height: 0.95em"></div>
    <div style="height: 5px; border: 2px solid #AAAAAA">
      <div style="height: 1px; background-color: #DDDDDD"></div>
    </div>
    <div style="height: 0.95em"></div>
    <div class="grid2">
      <div class="grid2Cell gc2Header">Info Field Info:&nbsp;&nbsp;<a style="white-space: nowrap" href="javascript:void edit_info_field_info()">edit</a></div>
      <div class="grid2Cell gc2VertSpace1"></div>
      <div class="grid2Cell gc2TextLeft">Data Type:</div>
      <div class="grid2Cell gc2TextRight"><span id="spn_ViewItem_WibTypeInfoFieldInfo_WibDataType"></span></div>
    </div>
  </div>
  <div id="dvViewItem_ListMembers_No" style="display: none">
    <div style="height: 0.95em"></div>
    <div style="height: 5px; border: 2px solid #AAAAAA">
      <div style="height: 1px; background-color: #DDDDDD"></div>
    </div>
    <div style="height: 0.95em"></div>
    <div><a href="javascript:void make_into_a_list()">make into a list</a></div>
  </div>
  <div id="dvViewItem_ListMembers_Yes" style="display: none">
    <div style="height: 0.95em"></div>
    <div style="height: 5px; border: 2px solid #AAAAAA">
      <div style="height: 1px; background-color: #DDDDDD"></div>
    </div>
    <div style="height: 0.95em"></div>
    <div>
      <span id="spnViewItem_MakeNewItem1">
        <a href="javascript:void make_new_item()" style="white-space: nowrap">new item</a>
      </span>
      <span id="spnViewItem_MakeNewField1">
        <a href="javascript:void make_new_type_info_field()" style="white-space: nowrap">new field</a>
      </span>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id="aReorder1" style="white-space: nowrap" href="javascript:void toggle_reorder()">reorder</a>
      <span id="spnViewItem_More1">
        &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id="aMoreOptions1" style="white-space: nowrap" href="javascript:void toggle_more_options()">more...</a>
      </span>
    </div>
    <div id="dvMoreOptions1" style="display: none">
      <div style="height: 1.4em"></div>
      <div>
        <a style="white-space: nowrap" href="javascript:void mark_all()">mark all</a>
        &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id='aGrabItems1' style="white-space: nowrap" href="javascript:void grab_items()">grab</a>
      </div>
    </div>
    <div style="height: 1em"></div>
    <div style="display: inline-block">
      <div style="border-bottom: 2px solid #BBBBBB"></div>
      <div style="height: 1.2em"></div>
      <div id="dvViewItem_ListMembers_Items"></div>
      <div style="height: 0.3em"></div>
      <div style="border-bottom: 2px solid #BBBBBB"></div>
    </div>
    <div style="height: 1em"></div>
    <div>
      <span id="spnViewItem_MakeNewItem2">
        <a href="javascript:void make_new_item()" style="white-space: nowrap">new item</a>
      </span>
      <span id="spnViewItem_MakeNewField2">
        <a href="javascript:void make_new_type_info_field()" style="white-space: nowrap">new field</a>
      </span>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id="aReorder2" style="white-space: nowrap" href="javascript:void toggle_reorder()">reorder</a>
      <span id="spnViewItem_More2">
        &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id="aMoreOptions2" style="white-space: nowrap" href="javascript:void toggle_more_options()">more...</a>
      </span>
    </div>
    <div id="dvMoreOptions2" style="display: none">
      <div style="height: 1.4em"></div>
      <div>
        <a style="white-space: nowrap" href="javascript:void mark_all()">mark all</a>
        &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id='aGrabItems2' style="white-space: nowrap" href="javascript:void grab_items()">grab</a>
      </div>
    </div>
  </div>
  <div style="height:1em"></div>
</div>

</div>

<div id="dvPopUp" style="display: none; border: 2px black solid">

  <div class="grid1" id="dvPopUp_MakeNewItem" style="display: none">
    <div class="grid1Cell gc1Header"><b>Make New Item</b></div>
    <div class="grid1Cell gc1VertSpace1"></div>
    <div class="grid1Cell gc1Text" style="padding-left: 2em">Item Name:</div>
    <div class="grid1Cell gc1Input"><input id="ipMakeNewItem_ItemName" style="width: 11em" /></div>
    <div class="grid1Cell gc1VertSpace2"></div>
    <div class="grid1Cell gc1TextForCheckbox">add to top of list:</div>
    <div class="grid1Cell gc1Checkbox gc1CheckboxFirst"><input id="ipMakeNewItem_TopOfList" type="checkbox" /></div>
    <div class="grid1Cell gc1VertSpace2"></div>
    <div class="grid1Cell gc1TextForCheckbox">remain on list view:</div>
    <div class="grid1Cell gc1Checkbox"><input id="ipMakeNewItem_StayListView" type="checkbox" /></div>
    <div class="grid1Cell gc1VertSpace2"></div>
    <div class="grid1Cell gc1TextForCheckbox">add additional items:</div>
    <div class="grid1Cell gc1Checkbox"><input id="ipMakeNewItem_AddMoreItems" type="checkbox" /></div>
    <div class="grid1Cell gc1VertSpace2"></div>
    <div class="grid1Cell gc1TextForCheckbox">do time tracking:</div>
    <div class="grid1Cell gc1Checkbox"><input id="ipMakeNewItem_DoTimeTracking" onclick="doCheckboxClickAction('ipMakeNewItem_DoTimeTracking')" type="checkbox" /></div>
    <div class="grid1Cell gc1VertSpace2 gc1Group1"></div>
    <div class="grid1Cell gc1Text gc1Group1">Y / M / D:</div>
    <div class="grid1Cell gc1Input gc1Group1">
      <input id="ipMakeNewItem_Year" style="width: 4em" />
      &nbsp;/&nbsp;&nbsp;<input id="ipMakeNewItem_Month" style="width: 2em" />
      &nbsp;/&nbsp;&nbsp;<input id="ipMakeNewItem_Day" style="width: 2em" />
    </div>
    <div class="grid1Cell gc1VertSpace2 gc1Group1"></div>
    <div class="grid1Cell gc1Text gc1Group1">Time:</div>
    <div class="grid1Cell gc1Input gc1Group1">
      <input id="ipMakeNewItem_Hour" class="timeX" style="width: 2em" />
      : <input id="ipMakeNewItem_Minute" style="width: 2em; text-align: center" />
    </div>
    <div class="grid1Cell gc1VertSpace2 gc1Group1"></div>
    <div class="grid1Cell gc1Text gc1Group1">Mins Tracked:</div>
    <div class="grid1Cell gc1Input gc1Group1"><input id="ipMakeNewItem_MinutesTracked" style="width: 3em" /></div>
    <div class="grid1Cell gc1VertSpace2"></div>
    <div class="grid1Cell gc1Footer" style="">
      <a style="white-space: nowrap" href="javascript:void do_make_new_item()">make</a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id="" style="white-space: nowrap" href="javascript:void cancel_make_new_item()">cancel</a>
    </div>
  </div>

  <div class="grid1" id="dvPopUp_MakeNewWibType" style="display: none">
    <div class="grid1Cell gc1Header" style="color: red"><b>Make New Type</b></div>
    <div class="grid1Cell gc1VertSpace1"></div>
    <div class="grid1Cell gc1Text">Type Name:</div>
    <div class="grid1Cell gc1Input"><input id="ipMakeNewWibType_WibTypeName" style="width: 12em" /></div>
    <div class="grid1Cell gc1VertSpace2"></div>
    <div class="grid1Cell gc1Footer" style="">
      <a style="white-space: nowrap" href="javascript:void do_make_new_type()">make</a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript:void cancel_make_new_type()">cancel</a>
    </div>
  </div>

  <div class="grid1" id="dvPopUp_MakeNewWibTypeInfoField" style="display: none">
    <div class="grid1Cell gc1Header" style="color: red"><b>Make New Info-Field</b></div>
    <div class="grid1Cell gc1VertSpace1"></div>
    <div class="grid1Cell gc1Text">Type Name:</div>
    <div class="grid1Cell gc1Text"><span id="spnMakeNewWibTypeInfoField_WibTypeName"></span></div>
    <div class="grid1Cell gc1VertSpace1"></div>
    <div class="grid1Cell gc1Text">Info-Field Name:</div>
    <div class="grid1Cell gc1Input"><input id="ipMakeNewWibTypeInfoField_WibTypeInfoFieldName" style="width: 11em" /></div>
    <div class="grid1Cell gc1VertSpace1"></div>
    <div class="grid1Cell gc1Text">Data Type:</div>
    <div class="grid1Cell gc1Select"><span id="spnMakeNewWibTypeInfoField_WibDataTypeId"></span></div>
    <div class="grid1Cell gc1VertSpace2"></div>
    <div class="grid1Cell gc1Footer" style="">
      <a style="white-space: nowrap" href="javascript:void do_make_new_type_info_field()">make</a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript:void cancel_make_new_type_info_field()">cancel</a>
    </div>
  </div>

</div>

<script type="text/javascript">

"use strict";

const CONST_appNarrow = "app_narrow";
const CONST_appVersion = "0.56";
const CONST_devText1 = "devText1";
const CONST_importBlocked = "importBlocked";
const CONST_stringOfAllItemIds = "string_of_all_item_ids";
const CONST_listName_homePage = "home_page_list";
const CONST_listName_wibTypes = "types";
const CONST_propName_sortPosition = "sortPosition";
const CONST_propName_itemId = "itemId";
const CONST_storedDataVersion = "stored_data_version";
const CONST_wibDataType_dateTime_name = "date & time";
const CONST_wibDataType_dateTime_id = 2;
const CONST_wibDataType_text_name = "text";
const CONST_wibDataType_text_id = 1;

const sD = "`"; // sD = storageDivider
const sD2 = "≡"; // sD2 = storageDivider2, used for text formatting during backup

var app = {};
app.activatedItemId = null;
app.grabbing_itemId1 = null;
app.grabbing_itemId2 = null;
app.grabbing_itemIdArray = [];
app.grabbingEnabled = false;
app.makeNewItem_TopOfList = "0";
app.makeNewItem_StayListView = "1";
app.makeNewItem_AddMoreItems = "0";
app.moreOptionsEnabled = false;
app.reorderEnabled = false;
app.reorderItemId = null;


///// REGULAR FUNCTIONS

function activateItem(itemId) {
  app.activatedItemId = itemId;
  elem(getHtml_trActivated(itemId)).style.display = "" ;
  elem(getHtml_tblReorderChoices(itemId)).style.display = "";
  elem(getHtml_dvReorderItemInstructions(itemId)).style.display = "none";
}

function html_displayAllElementsOfClass(className) {
  html_toggleDisplayAllElementsOfClass(className, true);
}

function html_hideAllElementsOfClass(className) {
  html_toggleDisplayAllElementsOfClass(className, false);
}

function html_toggleDisplayAllElementsOfClass(className, doShow) {
  var ay = document.querySelectorAll("." + className);
  ay.forEach( function(theElem, idx) {
    if (doShow) {
      theElem.style.display = "";
    } else {
      theElem.style.display = "none";
    }
  } );
}

function doCheckboxClickAction(elemId) {
  var checkboxIsChecked = false;
  if ( elem(elemId).checked ) {
    checkboxIsChecked = true;
  }

  switch (elemId) {
    case "ipMakeNewItem_DoTimeTracking":
      if (checkboxIsChecked) {
        html_displayAllElementsOfClass("gc1Group1")
      } else {
        html_hideAllElementsOfClass("gc1Group1")
      }
      break;
  }
}

function createItemInfoString(itemName, done, displayCode, isList, notes, isWibType, isWibTypeInfoField) {
  var itemInfoString = itemName + sD;

  if ( isBlank(done) ) {
    itemInfoString += "0";
  } else {
    if ( done == "1" ) {
      itemInfoString += "1";
    } else {
      itemInfoString += "0";
    }
  }

  itemInfoString = itemInfoString + sD;
  if ( isBlank(displayCode) ) {
    itemInfoString += "1";
  } else {
    itemInfoString += displayCode
  }

  itemInfoString = itemInfoString + sD;
  if ( isBlank(isList) ) {
    itemInfoString += "0";
  } else {
    itemInfoString += isList
  }

  itemInfoString = itemInfoString + sD;
  if ( isBlank(notes) ) {
    itemInfoString += "";
  } else {
    itemInfoString += notes
  }

  itemInfoString = itemInfoString + sD;
  if (isWibType == "1") {
    itemInfoString += "1";
  } else {
    itemInfoString += "0";
  }

  itemInfoString = itemInfoString + sD;
  if (isWibTypeInfoField == "1") {
    itemInfoString += "1";
  } else {
    itemInfoString += "0";
  }

  return itemInfoString;
}

function createListMemberDataObj(itemId, sortPosition) {
  var curListMemberDataObj = {};

  curListMemberDataObj.itemId = itemId;
  curListMemberDataObj.sortPosition = sortPosition;

  return curListMemberDataObj;
}

function createWibTypeInfoFieldInfoString(wibDataTypeId) {
  var itemInfoString = wibDataTypeId;
  return itemInfoString;
}

function da(text) {
  alert(text);
}

function deactivateItem(itemId) {
  app.activatedItemId = null;
  elem(getHtml_trActivated(itemId)).style.display = "none" ;
}

function deleteFromDatastore(itemKey) {
  localStorage.removeItem(itemKey);
}

function deleteItem(itemIdToDelete) {
  var itemObjToDelete, returnValue, successBoolean = false;

  itemObjToDelete = grabItemObj(itemIdToDelete);

  returnValue = itemObjToDelete.doDeletion() ;

  if ( ! isBlank(returnValue) && ! returnValue === false ) {
    successBoolean = true;
    setAppItemObj(grabItemObj(returnValue));
  }

  return successBoolean;
}

function disableGrabbing() {
  app.grabbing_itemId1 = null;
  app.grabbing_itemId2 = null;
  app.grabbing_itemIdArray = [];
  app.grabbingEnabled = false;
}

function displayPage(pageName) {
  elem("dvPage_Dev").style.display = "none";
  elem("dvPage_BackupExport").style.display = "none";
  elem("dvPage_BackupImport").style.display = "none";
  elem("dvPage_GrabbingMove").style.display = "none";
  elem("dvPage_Home").style.display = "none";
  elem("dvPage_ShowStorage").style.display = "none";
  elem("dvPage_WibTypes").style.display = "none";
  elem("dvPage_ViewItem").style.display = "none";

  elem("dvPage_" + pageName).style.display = "inline-grid";

  switch (pageName) {

    case "BackupExport":
      writeBackupExport();
      break;

    case "BackupImport":
      elem("taBackupTextToImport").value = "";
      elem("taBackupTextToImport").focus();
      break;

    case "GrabbingMove":
      if ( !isBlank(app.grabbing_itemId1) && isBlank(app.grabbing_itemId2) ) {
        //single-item-grab
        elem("spnGrabbingMove_FromList").innerHTML = grabItemObj(app.itemObj.displayedOnList_itemId).itemName;
      } else {
        elem("spnGrabbingMove_FromList").innerHTML = app.itemObj.itemName;
      }

      elem("dvGrabbingMove_Items").innerHTML = writeHtml_GrabbingMove_Items();
      elem("dvGrabbingMove_ListOptions").innerHTML = writeHtml_GrabbingMove_ListOptions();
      break;

    case "Home":
      if (!app.itemObj) {
        setAppItemObj(grabItemObjByName(CONST_listName_homePage));
      }
      elem("dvHome_Items").innerHTML = writeHtml_Items();
      break;

    case "WibTypes":
      setAppItemObj(grabItemObj(app.wibTypes_itemId));
      elem("dvWibTypes_Items").innerHTML = writeHtml_Items();
      break;

    case "ViewItem":
      {
        let i, hasDisplayedLists = false, displayListItemObj,  hasConnectedItems = false, hasWibTypes = false;

        if (app.itemObj.isWibType == "1") {
          elem("dvItemName").innerHTML = "<div style='color: red'><i>[this is a type]</i></div><div style='height: 8px'></div>" + app.itemObj.itemName;
        } else {
          elem("dvItemName").innerHTML = app.itemObj.itemName;
        }

        //TO-DO: display multiple list names, if this item is a member of 2+
        
        elem("dvListNameForItem").innerHTML = "";

        if (app.itemObj.isWibType == "0") {
          for (i = 0; i < app.itemObj.joinedLists_itemIds.length; i++) {
            let curItemObjForLoop = grabItemObj(app.itemObj.joinedLists_itemIds[0])

            if (curItemObjForLoop.displayCode == "1") {
              elem("dvListNameForItem").innerHTML = "&nbsp;&nbsp;&nbsp;member of list:&nbsp;&nbsp;<a href='javascript:void go_to_list(\"" + curItemObjForLoop.itemId + "\")'>" + curItemObjForLoop.itemName + "</a>";
              elem("spnMoveToDifferentList").style.display = "";
              hasDisplayedLists = true;
              app.itemObj.displayedOnList_itemId = curItemObjForLoop.itemId;

              displayListItemObj = curItemObjForLoop;
              if (displayListItemObj.isWibType == "1") {
                elem("dvListNameForItem").innerHTML = "&nbsp;&nbsp;&nbsp;<span style='color: red'><b>info-field for type:</b></span>&nbsp;&nbsp;<a href='javascript:void go_to_list(\"" + displayListItemObj.itemId + "\")'>" + displayListItemObj.itemName + "</a>";
              } else {
                elem("dvListNameForItem").innerHTML = "&nbsp;&nbsp;&nbsp;member of list:&nbsp;&nbsp;<a href='javascript:void go_to_list(\"" + displayListItemObj.itemId + "\")'>" + displayListItemObj.itemName + "</a>";
              }
              break;
            }
          }

          if (hasDisplayedLists) {
            elem("dvPage_ViewItem_JoinedListsArea").style.display = "";
          } else {
            elem("dvPage_ViewItem_JoinedListsArea").style.display = "none";
          }
        }

        if (hasConnectedItems) {
          elem("dvViewItem_ConnectedItems_Items").innerHTML = "(connected items would go here)";
        } else {
          elem("dvViewItem_ConnectedItems_Items").innerHTML = "connected items: <i>none</i>";
        }

        if (app.itemObj.isWibType == "1") {
          elem("spnMoveToDifferentList").style.display = "none";
          elem("spnViewItem_ShowWibTypes").style.display = "";
          elem("spnViewItem_Delete").style.display = "none";
        } else if (app.itemObj.isWibTypeInfoField == "1") {
          elem("spnMoveToDifferentList").style.display = "none";
          elem("spnViewItem_ShowWibTypes").style.display = "none";
          elem("spnViewItem_Delete").style.display = "none";
        } else {
          elem("spnViewItem_ShowWibTypes").style.display = "none";
          elem("spnViewItem_Delete").style.display = "";
        }

        if (app.itemObj.isWibType == "1" || app.itemObj.isWibTypeInfoField == "1") {
          elem("spnPage_ViewItem_NotDone").style.display = "none";
          elem("spnPage_ViewItem_Done").style.display = "none";
        } else if (app.itemObj.done == "0") {
          elem("spnPage_ViewItem_NotDone").style.display = "";
          elem("spnPage_ViewItem_Done").style.display = "none";
        } else {
          elem("spnPage_ViewItem_NotDone").style.display = "none";
          elem("spnPage_ViewItem_Done").style.display = "";
        }

        if ( isBlank(app.itemObj.notes) ) {
          elem("dvViewItem_Notes_Yes").style.display = "none";
          elem("spnViewItem_Notes_No").style.display = "";
          elem("dvViewItem_Notes").innerHTML = "";
        } else {
          elem("dvViewItem_Notes_Yes").style.display = "";
          elem("spnViewItem_Notes_No").style.display = "none";
          elem("dvViewItem_Notes").innerHTML = app.itemObj.notes;
        }

        if (app.itemObj.isWibType == "1" || app.itemObj.isWibTypeInfoField == "1") {
          elem("dvViewItem_WibTypes").style.display = "none";
        } else {
          elem("dvViewItem_WibTypes").style.display = "";
          if (hasWibTypes) {
            elem("dvViewItem_WibTypes_Items").innerHTML = "(types would go here)";
          } else {
            elem("dvViewItem_WibTypes_Items").innerHTML = "types: <i>none</i>";
          }
        }

        if (app.itemObj.isWibTypeInfoField == "1") {
          elem("dvViewItem_WibTypeInfoFieldInfo").style.display = "";
          elem("spn_ViewItem_WibTypeInfoFieldInfo_WibDataType").innerHTML = getWibDataTypeNameFromId(app.itemObj.wibDataTypeId);
        } else {
          elem("dvViewItem_WibTypeInfoFieldInfo").style.display = "none";
        }

        if (app.itemObj.isWibType == "1") {
          elem("dvViewItem_ListMembers_Yes").style.display = "";
          elem("dvViewItem_ListMembers_No").style.display = "none";
          elem("spnViewItem_MakeNewItem1").style.display = "none";
          elem("spnViewItem_MakeNewItem2").style.display = "none";
          elem("spnViewItem_MakeNewField1").style.display = "";
          elem("spnViewItem_MakeNewField2").style.display = "";
          elem("spnViewItem_More1").style.display = "none";
          elem("spnViewItem_More2").style.display = "none";
          elem("dvViewItem_ListMembers_Items").innerHTML = writeHtml_Items();
        } else if (app.itemObj.isWibTypeInfoField == "1") {
          elem("dvViewItem_ListMembers_No").style.display = "none";
          elem("dvViewItem_ListMembers_Yes").style.display = "none";
          elem("dvViewItem_ListMembers_Items").innerHTML = "";
        } else {
          elem("spnViewItem_MakeNewItem1").style.display = "";
          elem("spnViewItem_MakeNewItem2").style.display = "";
          elem("spnViewItem_MakeNewField1").style.display = "none";
          elem("spnViewItem_MakeNewField2").style.display = "none";
          elem("spnViewItem_More1").style.display = "";
          elem("spnViewItem_More2").style.display = "";
          if (app.itemObj.isList == "1") {
            elem("dvViewItem_ListMembers_Yes").style.display = "";
            elem("dvViewItem_ListMembers_No").style.display = "none";
            elem("dvViewItem_ListMembers_Items").innerHTML = writeHtml_Items();
          } else {
            elem("dvViewItem_ListMembers_Yes").style.display = "none";
            elem("dvViewItem_ListMembers_No").style.display = "";
            elem("dvViewItem_ListMembers_Items").innerHTML = "";
          }
        }
      }
      break;

    case "ShowStorage":
      writeStorage();
      break;
  }
}

function elem(elemId) {
  return document.getElementById(elemId);
}

function getElemVal(elemId) {
  var theElem, elemType, elemVal;

  theElem = elem(elemId);
  elemType = theElem.type;

  switch (elemType) {
    case "checkbox":
      if (elemVal = theElem.checked) {
        elemVal = "1";
      } else {
        elemVal = "0";
      }
      //console.log("getElemVal(), elemId="+elemId+", elemType="+elemType+", elemVal="+elemVal)
      break;

    default:
      elemVal = theElem.value;
  }

  return elemVal;
}

function getFromDatastore(itemKey) {
  var itemValue = localStorage.getItem(itemKey);
  return itemValue;
}

function getHtml_aItem(itemId) {
  return "aItem_" + itemId;
}

function getHtml_dvReorderItemInstructions(itemId) {
  return "dvReorderItemInstructions_" + itemId;
}

function getHtml_selectElem(selectElemId, includeBlank, theArray, defValue, theStyle, onChange, blankDisplay, isDisabled) {
  var i, html;

  html = "<select id='" + selectElemId + "'";

  if (  !isBlank(theStyle) ) {
    html += " style='" + theStyle + "'";
  }

  if ( !isBlank(onChange) ) {
    html += " onchange='javascript:void " + onChange + "'";
  }

  if (isDisabled) {
    html += " disabled";
  }

  html += ">\n";

  if (includeBlank) {
    html += "<option value=''";
    if ( isBlank(defValue) ) html += " selected";
      html += ">";
    if (blankDisplay) {
      html += blankDisplay + "</option>\n";
    } else {
      html += " </option>\n";
    }
  }


  for (i = 0; i < theArray.length; i++ ) {
    let curOptionId, curOptionDisplay;
    curOptionId = theArray[i].optionId;
    curOptionDisplay = theArray[i].optionDisplay;
    html += "<option value='" + curOptionId + "'";
    if ( isEqual(defValue, curOptionId) ) html += " selected";
    html += ">" + curOptionDisplay + "</option>\n";
  }

  html += "</select>\n";

  return html;
}

function getHtml_tblReorderChoices(itemId) {
  return "tblReorderChoices_" + itemId;
}

function getHtml_trActivated(itemId) {
  return "trActivated_" + itemId;
}

function getIdArray(string_ids){
  var array_ids;
  if (isBlank(string_ids)) return [];
  array_ids = string_ids.split(sD);
  return array_ids;
}

function getIdString(array_ids){
  var string_ids = array_ids.join(sD);
  return string_ids;
}

function getObjArrayAsString(theArray, propName1, propName2) {
  var i, str = "";
  for (i = 0; i < theArray.length; i++ ){
    str += propName1 + ": " + theArray[i][propName1];
    if ( !isBlank(propName2) ) str += ", " + propName2 + ": " + theArray[i][propName2];
    str += "\n";
  }
  return str;
}

function getObjArrayWithoutElem(theArray, propName, propValueToExclude) {
  var revisedArray;

  revisedArray = theArray.filter(function (arrayElem) {
    var returnValue = true;
    if ( isEqual(arrayElem[propName], propValueToExclude) ) {
      returnValue = false;
    }
    return returnValue;
  });

  return revisedArray;
}

function getObjArrayWithoutElem_old(theArray, propNameToMatch, propValueToMatch) {
  var i, curArrayElem, revisedArray = [];

  for (i = 0; i < theArray.length; i++) {
    curArrayElem = theArray[i];
    if ( !isEqual(curArrayElem[propNameToMatch], propValueToMatch) ) {
      revisedArray.push(curArrayElem);
    }
  }

  return revisedArray;
}

function getSaveKeyText_item(itemId) {
  return "i_" + itemId;
}

function getSaveKeyText_joinedLists_ofItem(itemId) {
  return "iJL_" + itemId;
}

function getSaveKeyText_listMembers_ofItem(itemId) {
  return "iLM_" + itemId;
}

function getSaveKeyText_wibTypeInfoFieldInfo_ofItem(itemId) {
  return "iWTIFI_" + itemId;
}

function getSelectArrayElem(optionId, optionDisplay) {
  var theObj = {};

  theObj.optionId = optionId;

  if (optionDisplay === undefined) {
    theObj.optionDisplay = optionId;
  } else {
    theObj.optionDisplay = optionDisplay;
  }

  return theObj;
}

function getValArrayWithoutElem(theArray, valToExclude) {
  var revisedArray;

  revisedArray = theArray.filter(function (arrayElem) {
    var returnValue = true;
    if ( isEqual(arrayElem, valToExclude) ) {
      returnValue = false;
    }
    return returnValue;
  });

  return revisedArray;
}

function getWibDataTypeNameFromId(wibDataTypeId) {
  switch (parseInt(wibDataTypeId)) {
    case parseInt(CONST_wibDataType_text_id):
      return CONST_wibDataType_text_name;
    case parseInt(CONST_wibDataType_dateTime_id):
      return CONST_wibDataType_dateTime_name;
  }
}

function getWibDataTypesAsArray() {
  var anObj;
  var theArray = [];

  //WibDataType = "text"
  anObj = getSelectArrayElem(CONST_wibDataType_text_id, CONST_wibDataType_text_name);
  anObj.wibDataTypeId = CONST_wibDataType_text_id;
  anObj.wibDataTypeName = CONST_wibDataType_text_name;
  theArray.push(anObj);

  //WibDataType = "date & time"
  anObj = getSelectArrayElem(CONST_wibDataType_dateTime_id, CONST_wibDataType_dateTime_name);
  anObj.wibDataTypeId = CONST_wibDataType_dateTime_id;
  anObj.wibDataTypeName = CONST_wibDataType_dateTime_name;
  theArray.push(anObj);

  return theArray;
}

function goToItemView(itemId, maintainActivatedItem) {
  if ( !isBlank(itemId) ) {
    setAppItemObj(grabItemObj(itemId));
  }
  if (!maintainActivatedItem) {
    app.activatedItemId = null;
  }

  displayPage("ViewItem");
  stopGrabbingItems();

  if ( !isBlank(app.reorderItemId) ) {
    app.reorderItemId = null;
  }
}

function goToGrabbingMove() {
  displayPage("GrabbingMove");
}

function grabItemObj(itemId) {
  var saveKeyText_item, itemObj, itemInfoString, itemDataArray;

  //get the item-data-string from the datastore
  saveKeyText_item = getSaveKeyText_item(itemId);
  itemInfoString = getFromDatastore(saveKeyText_item);

  //this function assumes only existing items will be requested; so, if the item-data-string is blank, the item does not exist, and we must throw an error
  if ( isBlank(itemInfoString) ) {
    throw("ERROR: item with itemId=" + itemId + " does not exist in data storage");
  }

  //create an item-object
  itemObj = itemObjFactory();

  //set the item-object's properties from the retrieved item-data
  itemDataArray = itemInfoString.split(sD);
  itemObj.itemId = itemId;
  itemObj.itemName = itemDataArray[0];
  itemObj.done = itemDataArray[1];
  itemObj.displayCode = itemDataArray[2];
  itemObj.isList = itemDataArray[3];
  itemObj.notes = itemDataArray[4];
  itemObj.isWibType = itemDataArray[5];
  itemObj.isWibTypeInfoField = itemDataArray[6];

  //set joined-lists array, if any
  if (itemObj.isList) {
    let saveKeyText_joinedLists_ofItem = getSaveKeyText_joinedLists_ofItem(itemObj.itemId);
    let joinedLists_itemIds_string = getFromDatastore(saveKeyText_joinedLists_ofItem);
    itemObj.joinedLists_itemIds = getIdArray(joinedLists_itemIds_string);
  }

  //if this is a wib-type-info-field, set wibTypeInfo for this item-object
  if (itemObj.isWibTypeInfoField == "1") {
    let saveKeyText_wibTypeInfoFieldInfo_ofItem = getSaveKeyText_wibTypeInfoFieldInfo_ofItem(itemObj.itemId);
    let wibTypeInfoFieldInfo_string = getFromDatastore(saveKeyText_wibTypeInfoFieldInfo_ofItem);
    let wibTypeInfoFieldInfo_array = wibTypeInfoFieldInfo_string.split(sD);
    let wibDataTypeId = wibTypeInfoFieldInfo_array[0];
    itemObj.setWibTypeInfo(wibDataTypeId, false);
  }

  //return the item-object
  return itemObj;
}

function grabItemObjByName(itemName) {
  var allItemIds_string, allItemIds_array, i, curItemId, curItemObj;
  
  allItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
  allItemIds_array = getIdArray(allItemIds_string);
  
  for (i = 0; i < allItemIds_array.length; i++) {
    curItemId = allItemIds_array[i];
    curItemObj = grabItemObj(curItemId)

    if ( isEqual(itemName, curItemObj.itemName) ) {
      return curItemObj;
    }
  }

  return false;
}

function hidePopUp(popUpCode) {
  elem("dvMainViewOverlay").style.display = "";
  elem("dvPopUp").style.display = "none";
  elem("dvPopUp_" + popUpCode).style.display = "none";
}

function importBackupText(textToImport) {
  var i, keyValuePairs, keyName, keyValue;

  //split storage-keys from text-to-import string
  keyValuePairs = textToImport.split(sD2);

  //if we don't have an even number of items, there is a mismatch of key/value pairs
  if (keyValuePairs.length % 2 > 0) {
    alert("uneven number of key/value pairs, operation canceled");
    return;
  }

  //clear existing storage
  if ( !confirm("About to clear existing storage, in order to proceed with import. Continue?") ) {
    return
  }
  localStorage.clear();

  //do the import
  for (i = 0; i < keyValuePairs.length; i = i + 2) {
    keyName = keyValuePairs[i];
    keyValue = keyValuePairs[i+1];
//if(!confirm("would make:\nkeyName: "+keyName+"\nkeyValue: "+keyValue+"\n\nexisting keyValue: "+getFromDatastore(keyName)))return
    localStorage.setItem(keyName, keyValue);
//if(!confirm("just added:\nkeyName: "+keyName+"\n\nnow, when re-grabbed from localStorage it is: "+getFromDatastore(keyName)))return
  }

  alert("Import complete");

  //refresh app and go to home page
  loadAppData();
  displayPage("Home");
}

function isBlank(val) {
  if(val == undefined) return true;
  if(val == null) return true;
  if(val == "0")return false;
  if(parseInt(val) == 0)return false;
  if(val == "") return true;
  if(!val)return true;
  return false;
}

function isDev() {
  if ( getFromDatastore(CONST_devText1) == "1" ) {
    return true;
  } else {
    return false;
  }
}

function isEqual(val1, val2) {
  if ( isBlank(val1) && isBlank(val2) ) return true;
  if ( val1 == val2 ) return true;
  if ( Number(val1) == Number(val2) ) return true;
  return false;
}

function isMemberOfList(memberItemId, listItemId) {
  var listItemObj, listMemberDataObjs, i;

  listItemObj = grabItemObj(listItemId);
  listMemberDataObjs = listItemObj.getListMemberDataObjs();
  
  for (i = 0; i < listMemberDataObjs.length; i++) {
    if ( isEqual(listMemberDataObjs[i].itemId, listItemId) ) {
      return true;
    }
  }

  return false;
}

function itemNameIsAllowed(itemName) {
  var disallowedName = false;

  if ( isEqual(itemName, CONST_listName_homePage) ) {
    disallowedName = true;
  } else if ( isEqual(itemName, CONST_listName_wibTypes) ) {
    disallowedName = true;
  }
  if (disallowedName) {
    alert("Item Name '" + itemName + "' is not allowed, as it is reserved by the app");
    return false;
  }

  return true;
}

function itemObjFactory() {
  var itemObj = {};

  itemObj.itemId = null;
  itemObj.itemName = "";
  itemObj.done = "0";
  itemObj.displayCode = "1";
  itemObj.isList = "0";
  itemObj.notes = "";
  itemObj.joinedLists_itemIds = [];
  itemObj.isWibType = "0";
  itemObj.isWibTypeInfoField = "0";

  itemObj.addItemToListMembers = function(itemIdToAdd) {
    var listMemberDataObjs, curMaxSortPosition, sortPositionToUse, newListMemberDataObj;

    //grab current list-members for this list 
    listMemberDataObjs = this.getListMemberDataObjs();

    //set the new sortPosition value
    if (listMemberDataObjs.length == 0) {
      curMaxSortPosition = -1;
    } else {
      curMaxSortPosition = listMemberDataObjs[listMemberDataObjs.length - 1].sortPosition;
    }
    sortPositionToUse = parseInt(curMaxSortPosition) + 1

    //create a new list-member-data-object, and add it to the current array
    newListMemberDataObj = createListMemberDataObj(itemIdToAdd, sortPositionToUse);
    listMemberDataObjs.push(newListMemberDataObj);
    
    //save the revised list-members-array to datastore
    this.saveListMembersToDatastore(listMemberDataObjs);
  };

  itemObj.changeItem = function(itemName, done, displayCode, isList, notes) {
    if ( !isBlank(itemName) ) this.itemName = itemName;
    if ( !isBlank(done) ) this.done = done;
    if ( !isBlank(displayCode) ) this.displayCode = displayCode;
    if ( !isBlank(isList) ) this.isList = isList;
    if ( notes !== null ) this.notes = notes;
    this.saveItemInfoToDatastore();
    return true;
  };

  itemObj.doDeletion = function() {
    var firstListItemId = null, saveKeyText_listMembers_ofItem, i, curAllItemIds_string, curAllItemIds_array, newAllItemIds_string = "";

    //check if this is a list with list-members
    if (this.isList == "1") {
      if ( this.hasListMembers() ) {
        alert("Can't delete something that has list members");
        return false;
      }
    }

    //remove from joined-lists
    for (i = 0; i < this.joinedLists_itemIds.length; i++) {
      let joinedList_itemId = this.joinedLists_itemIds[i];
      let joinedList_itemObj = grabItemObj(joinedList_itemId);
      if ( firstListItemId == null ) firstListItemId = joinedList_itemId
      joinedList_itemObj.removeListMember(this.itemId);
    }

    //delete joined-list-info for this item
    deleteFromDatastore(getSaveKeyText_joinedLists_ofItem(this.itemId));

    //delete list-members entry for this item
    deleteFromDatastore(saveKeyText_listMembers_ofItem);

    //remove from all-items array
    curAllItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
    curAllItemIds_array = getIdArray(curAllItemIds_string);
    for (i = 0; i < curAllItemIds_array.length; i++) {
      if ( !isEqual(curAllItemIds_array[i], this.itemId) ) {
        if ( !isBlank(newAllItemIds_string) ) newAllItemIds_string += sD;
        newAllItemIds_string += curAllItemIds_array[i];
      }
    }
    saveToDatastore(CONST_stringOfAllItemIds, newAllItemIds_string);

    //delete item-info from datastore
    deleteFromDatastore(getSaveKeyText_item(this.itemId));

    //clear app-level current-item-id
    setAppItemObj(null);

    //return the the item-id of the first joined-list, so the calling functions can move to that item in the UI
    return firstListItemId;
  };

  itemObj.getListMemberDataObjs = function() {
    var saveKeyText_listMembers_ofItem, listMembers_string, listMembers_array, i, curListMemberDataObj, listMemberDataObjs = [];

    saveKeyText_listMembers_ofItem = getSaveKeyText_listMembers_ofItem(this.itemId);
    listMembers_string = getFromDatastore(saveKeyText_listMembers_ofItem);
    listMembers_array = getIdArray(listMembers_string);

    for (i = 0; i < listMembers_array.length; i = i + 2) {
      curListMemberDataObj = createListMemberDataObj(listMembers_array[i], listMembers_array[i + 1]);
      listMemberDataObjs.push(curListMemberDataObj);
    }

    //for now, we will sort the array by sortPosition every time; in the future, this could be provided as a separate function
    listMemberDataObjs.sort(sortingObjects(CONST_propName_sortPosition));

    return listMemberDataObjs;
  };

  itemObj.hasListMembers = function() {
    var saveKeyText_listMembers_ofItem, listMembers_string;

    saveKeyText_listMembers_ofItem = getSaveKeyText_listMembers_ofItem(this.itemId);
    listMembers_string = getFromDatastore(saveKeyText_listMembers_ofItem);

    if ( isBlank(listMembers_string) ) return false;

    if (listMembers_string.length > 0) {
      return true;
    } else {
      return false;
    }
  };

  itemObj.joinList = function(listToJoin_itemId) {
    var listToJoin_itemObj;

    //grab item-object for the list-to-join
    listToJoin_itemObj = grabItemObj(listToJoin_itemId);

    //call function on list-to-join's item-object, in order to be added to the list-members for that list-to-join 
    listToJoin_itemObj.addItemToListMembers(this.itemId);

    //add the list-to-join's itemId to this list's array of joined-lists
    this.joinedLists_itemIds.push(listToJoin_itemId);

    //save joined-lists to datastore
    this.saveJoinedListsToDatastore();
  };

  itemObj.leaveList = function(listToLeave_itemId) {
    var listToLeave_itemObj;

    //remove the list-to-leave's itemId from this list's array of joined-lists
    this.joinedLists_itemIds = getValArrayWithoutElem(this.joinedLists_itemIds, listToLeave_itemId);

    //save joined-lists to datastore
    this.saveJoinedListsToDatastore();

    //grab item-object for the list-to-join
    listToLeave_itemObj = grabItemObj(listToLeave_itemId);

    //call function on list-to-leave's item-object, in order to be removed from its list-members
    listToLeave_itemObj.removeListMember(this.itemId);
  };

  itemObj.makeIntoAList = function() {
    var saveKeyText_itemListMembers;

    if (this.isList == "1") {
      //no action needed
    } else {
      this.isList = "1";
      this.saveItemInfoToDatastore();
    }

    saveKeyText_itemListMembers = getSaveKeyText_listMembers_ofItem(this.itemId);
    saveToDatastore(saveKeyText_itemListMembers, "");
  };

  itemObj.markAllListMembers = function(markDirectionIsDone, listMemberDataObjs) {
    var i;

    for (i = 0; i < listMemberDataObjs.length; i++) {
      let curItemObj = grabItemObj(listMemberDataObjs[i].itemId);
      
      if (markDirectionIsDone) {
        if (curItemObj.done == "0") {
          curItemObj.changeItem(null, "1", null, null, null);
        }
      } else {
        if (curItemObj.done == "1") {
          curItemObj.changeItem(null, "0", null, null, null);
        }
      }
    }
  };

  itemObj.removeListMember = function(itemIdToRemove) {
    var oldListMemberDataObjs, newListMemberDataObjs;

    oldListMemberDataObjs = this.getListMemberDataObjs();
    newListMemberDataObjs = getObjArrayWithoutElem(oldListMemberDataObjs, CONST_propName_itemId, itemIdToRemove)

    this.saveListMembersToDatastore(newListMemberDataObjs);
  };

  itemObj.saveItemInfoToDatastore = function() {
    var itemInfoString = createItemInfoString(this.itemName, this.done, this.displayCode, this.isList, this.notes, this.isWibType, this.isWibTypeInfoField)
    saveToDatastore(getSaveKeyText_item(this.itemId), itemInfoString);
  };

  itemObj.saveJoinedListsToDatastore = function() {
    var joinedLists_itemIds_string = getIdString(this.joinedLists_itemIds);
    saveToDatastore(getSaveKeyText_joinedLists_ofItem(this.itemId), joinedLists_itemIds_string);
  };

  itemObj.saveListMembersToDatastore = function(listMemberDataObjs) {
    var saveKeyText_itemListMembers, i, curListMemberDataObj, listMemberDataObjs_string = ""; 

    saveKeyText_itemListMembers = getSaveKeyText_listMembers_ofItem(this.itemId);
    
    for (i = 0; i < listMemberDataObjs.length; i++) {
      curListMemberDataObj = listMemberDataObjs[i];
      if ( !isBlank(listMemberDataObjs_string) ) listMemberDataObjs_string += sD;
      listMemberDataObjs_string += curListMemberDataObj.itemId + sD + curListMemberDataObj.sortPosition;
    }

    saveToDatastore(saveKeyText_itemListMembers, listMemberDataObjs_string);
  };

  itemObj.saveWibTypeInfoFieldInfoToDatastore = function() {
    var wibTypeInfoFieldInfoString = createWibTypeInfoFieldInfoString(this.wibDataTypeId);
    saveToDatastore(getSaveKeyText_wibTypeInfoFieldInfo_ofItem(this.itemId), wibTypeInfoFieldInfoString);
  };

  itemObj.setWibTypeInfo = function(wibDataTypeId, saveToDatastore) {
    this.wibDataTypeId = wibDataTypeId;
    if (saveToDatastore) {
      this.saveWibTypeInfoFieldInfoToDatastore();
    }
  };

  return itemObj;
}

function makeNewItem(isWibTypeInfoField, isWibType, overrideDisallowName, itemName, itemNamePrompt, displayCode, isList, addToList_itemId) {
  var newItemObj, allItemIds_string, allItemIds_array, i, itemId_toCheck, maxItemId;

  //if not passed, get item name
  if ( isBlank(itemName) ) {
    if ( isBlank(itemNamePrompt) ) itemNamePrompt = "new item:";
    itemName = prompt(itemNamePrompt, "");
    if ( isBlank(itemName) ) return false;
  }

  if (!overrideDisallowName) {
    if ( !itemNameIsAllowed(itemName) ) {
      return false;
    }
  }

  //create item-object
  newItemObj = itemObjFactory();

  //generate new itemId
  allItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
  allItemIds_array = getIdArray(allItemIds_string);
  maxItemId = -1;
  for (i = 0; i < allItemIds_array.length; i++) {
    itemId_toCheck = allItemIds_array[i];
    if (parseInt(itemId_toCheck) > parseInt(maxItemId)) maxItemId = parseInt(itemId_toCheck);
  }
  newItemObj.itemId = parseInt(maxItemId) + 1;

  //save item-info to datastore
  if ( isWibTypeInfoField == "1") {
    newItemObj.isWibTypeInfoField = "1";
  } else {
    newItemObj.isWibTypeInfoField = "0";
  }
  if ( isWibType == "1") {
    newItemObj.isWibType = "1";
  } else {
    newItemObj.isWibType = "0";
  }
  newItemObj.itemName = itemName;
  if ( !isBlank(displayCode) ) newItemObj.displayCode = displayCode;
  if ( !isBlank(isList) ) newItemObj.isList = isList;
  newItemObj.notes = "";
  newItemObj.saveItemInfoToDatastore();

  //if is-list, make into a list
  if (isList == "1") {
    newItemObj.makeIntoAList();
  }

  //add item to list-of-all-items
  if ( isBlank(allItemIds_string) ) {
    allItemIds_string = "";
  } else {
    allItemIds_string = allItemIds_string + sD;
  }
  allItemIds_string = allItemIds_string + newItemObj.itemId;
  saveToDatastore(CONST_stringOfAllItemIds, allItemIds_string);

  //if requested, add this item to a list
  if ( !isBlank(addToList_itemId) ) {
    newItemObj.joinList(addToList_itemId);
  }

  return newItemObj;
}

function reorderItemToOtherItem(otherItemId) {
  if ( walkSortPosition(app.itemObj, app.reorderItemId, null, false, false, otherItemId) ) {
    goToItemView(null, true);
  }
}

function resetElemVal(elemId) {
  var theElem, elemType, elemVal;

  theElem = elem(elemId);
  elemType = theElem.type;

  switch (elemType) {
    case "checkbox":
      theElem.checked = false;
      break;

    default:
      theElem.value = "";
  }
}

function saveToDatastore(itemKey, itemValue) {
  localStorage.setItem(itemKey, itemValue);
}

function setAppItemObj(itemObj) {
  app.itemObj = itemObj;
  if ( app.itemObj ) {
    app.itemObj.displayedOnList_itemId = null;
  }
}

function setElemVal(elemId, elemVal) {
  var theElem, elemType;

  theElem = elem(elemId);
  elemType = theElem.type;

  switch (elemType) {
    case "checkbox":
      if (elemVal == "1") {
        theElem.checked = true;
      } else {
        theElem.checked = false;
      }
      break;

    default:
      theElem.value = elemVal;
  }
}

function setGrabItem(itemId) {
  elem(getHtml_aItem(itemId)).style.color = "red";
  if ( isBlank(app.grabbing_itemId1) ) {
    app.grabbing_itemId1 = itemId;
  } else {
    app.grabbing_itemId2 = itemId;
    goToGrabbingMove();
  }
}

function showPopUp(popUpCode, popUpFocusElem) {
  elem("dvPopUp_MakeNewItem").style.display = "none";
  elem("dvPopUp_MakeNewWibType").style.display = "none";
  elem("dvPopUp_MakeNewWibTypeInfoField").style.display = "none";

  switch (popUpCode) {

    case "MakeNewItem":
      resetElemVal("ipMakeNewItem_ItemName");
      setElemVal("ipMakeNewItem_TopOfList", app.makeNewItem_TopOfList);
      setElemVal("ipMakeNewItem_StayListView", app.makeNewItem_StayListView);
      setElemVal("ipMakeNewItem_AddMoreItems", app.makeNewItem_AddMoreItems);

      doCheckboxClickAction("ipMakeNewItem_DoTimeTracking");
      break;

    case "MakeNewWibType":
      resetElemVal("ipMakeNewWibType_WibTypeName");
      break;

    case "MakeNewWibTypeInfoField":
      {
        let wibDataTypesArray = getWibDataTypesAsArray(true);
        let wibDataTypeSelectHtml = getHtml_selectElem("selMakeNewWibTypeInfoField_WibDataTypeId", true, wibDataTypesArray, null, "width: 11em", null, null, false);
    
        elem("spnMakeNewWibTypeInfoField_WibDataTypeId").innerHTML = wibDataTypeSelectHtml;
      
        resetElemVal("ipMakeNewWibTypeInfoField_WibTypeInfoFieldName");
        resetElemVal("selMakeNewWibTypeInfoField_WibDataTypeId");
        break;
      }
  }

  elem("dvMainViewOverlay").style.display = "none";
  elem("dvPopUp").style.display = "inline-flex";
  elem("dvPopUp_" + popUpCode).style.display = "grid";
  if ( !isBlank(popUpFocusElem) ) {
    elem(popUpFocusElem).focus();
  }
}

function sortingObjects(propNameToSortBy) {
  return function(objA, objB) {
    var comparisonCode;

    if ( parseInt(objA[propNameToSortBy]) < parseInt(objB[propNameToSortBy]) ) {
      comparisonCode = -1;
    } else if ( parseInt(objA[propNameToSortBy]) > parseInt(objB[propNameToSortBy]) ) {
      comparisonCode = 1;
    } else {
      comparisonCode = 0;
    }

    return comparisonCode;
  };
}

function startGrabbingItems() {
  app.grabbing_itemId1 = null;
  app.grabbing_itemId2 = null;
  app.grabbing_itemIdArray = [];

  elem("aGrabItems1").style.color = "red";
  elem("aGrabItems2").style.color = "red";

  app.grabbingEnabled = true;
}

function stopGrabbingItems() {
  elem("aGrabItems1").style.color = "";
  elem("aGrabItems2").style.color = "";

  if ( !isBlank(app.grabbing_itemId1) ) {
    elem(getHtml_aItem(app.grabbing_itemId1)).style.color = "";
  }

  disableGrabbing();
}

function swapSortPosition(itemId, moveUp, moveAmt) {
  var listItemObj, memberItemObj, list_memberDataObjs, i = null;
  
  listItemObj = app.itemObj;
  memberItemObj = grabItemObj(itemId);
  list_memberDataObjs = listItemObj.getListMemberDataObjs();

  for (i = 0; i < list_memberDataObjs.length; i++) {
    let requestedNewIndex, memberItemDataObj, memberItemDataObj_toSwapWith, member_oldSortPosition;

    if ( isEqual(list_memberDataObjs[i].itemId, memberItemObj.itemId) ) {
      memberItemDataObj = list_memberDataObjs[i];

      if (moveUp) {
        requestedNewIndex = i - parseInt(moveAmt);
        if (requestedNewIndex < 0) return false;
      } else {
        requestedNewIndex = i + parseInt(moveAmt);
        if (requestedNewIndex >= list_memberDataObjs.length) return false;
      }

      memberItemDataObj_toSwapWith = list_memberDataObjs[requestedNewIndex];

      member_oldSortPosition = memberItemDataObj.sortPosition;
      memberItemDataObj.sortPosition = memberItemDataObj_toSwapWith.sortPosition;
      memberItemDataObj_toSwapWith.sortPosition = member_oldSortPosition;
  
      listItemObj.saveListMembersToDatastore(list_memberDataObjs);

      return true;
    }
  }

  return false;
}

function transferItems(oldListObj, newListObj, memberItems_idArray) {
  var i;

  for (i = 0; i < memberItems_idArray.length; i++) {
    let curItemObj = grabItemObj(memberItems_idArray[i]);

    curItemObj.joinList(newListObj.itemId);
    curItemObj.leaveList(oldListObj.itemId);
  }
}

function walkSortPosition(listItemObj, itemId, moveAmt, moveToTop, moveToEnd, moveToItemId) {
  var memberItemObj, list_memberDataObjs, i, movedAtLeastOneSpot = false;

  //grab item-object for the item-being-walked, and the array of list-member-data-objects for the list
  memberItemObj = grabItemObj(itemId);
  list_memberDataObjs = listItemObj.getListMemberDataObjs();

  //cycle through all list-member-data-objects for the list, until we find our item that is being walked
  for (i = 0; i < list_memberDataObjs.length; i++) {

    let memberItemDataObj, requestedNewIndex = null, curSortIndex, reachedNewIndex = false;

    if ( isEqual(list_memberDataObjs[i].itemId, memberItemObj.itemId) ) {

      //found the item that is being walked
      memberItemDataObj = list_memberDataObjs[i];

      //calculate the requested new index when the walk will be complete
      if ( Number.isInteger(moveAmt) ) {
        //a negative moveAmt sends us towards the top of the list; positive moveAmt sends us towards the end
        requestedNewIndex = i + parseInt(moveAmt);
      } else if (moveToTop) {
        requestedNewIndex = 0;
      } else if (moveToEnd) {
        requestedNewIndex = list_memberDataObjs.length - 1;
      } else if ( !isBlank(moveToItemId) ) {
        //need to grab the current index of the requested item-to-move-to
        for (let j = 0; j < list_memberDataObjs.length; j++) {
          let memberDataObj_toCheck = list_memberDataObjs[j];
          if ( isEqual(memberDataObj_toCheck.itemId, moveToItemId) ) {
            //found the requested item-to-move-to
            requestedNewIndex = j;
          }
        }
      } else {
        //this occurs if none of the "move" function parameters were set in a valid fashion
        return false;
      }

      //if there was a problem finding the requested item or spot to walk to, return false
      if ( isBlank(requestedNewIndex) || !Number.isInteger(parseInt(requestedNewIndex)) ) {
        return false;
      }

      //don't walk past the top or end of the list
      if (requestedNewIndex < 0) requestedNewIndex = 0;
      if (requestedNewIndex >= list_memberDataObjs.length) requestedNewIndex = list_memberDataObjs.length - 1;

//da("requestedNewIndex="+requestedNewIndex)
      //check if the item-being-walked is already at the requested new index
      curSortIndex = i;
      if ( parseInt(curSortIndex) == parseInt(requestedNewIndex) ) {
        reachedNewIndex = true;
      }

      //while we have not yet reached the requested new index, walk one step at a time in its direction
      while(!reachedNewIndex) {
        let memberItemDataObj_toSwapWith, member_oldSortPosition;

        //determine which direction to walk
        if (curSortIndex > requestedNewIndex) {
          curSortIndex = curSortIndex - 1;
        } else {
          curSortIndex = parseInt(curSortIndex) + 1;
        }
//da("curSortIndex="+curSortIndex) 
        //grab the item-object for the item that our walk has brought us to
        memberItemDataObj_toSwapWith = list_memberDataObjs[curSortIndex];

        //save the current sortPosition value for the item-being-walked
        // (sortPosition is not always the same as list-index: example #1, if an item has been removed from the list); example #2, if items have swapped position)
        member_oldSortPosition = memberItemDataObj.sortPosition;

        //set the sortPosition value for the item-being-walked, to the sortPosition value of the list-member that was already at this index
        memberItemDataObj.sortPosition = memberItemDataObj_toSwapWith.sortPosition;

        ///... and give the old sortPosition of the item-to-be-walked, to the list-member that was already at this index
        memberItemDataObj_toSwapWith.sortPosition = member_oldSortPosition;

        //mark that we moved at least one spot
        if (!movedAtLeastOneSpot) movedAtLeastOneSpot = true;

        //check if we have reached our requested index for the walk
        if ( parseInt(curSortIndex) == parseInt(requestedNewIndex) ) {
          reachedNewIndex = true;
        }
      }

      //if we moved at least one spot, save the member-data-objects for the the list
      if (movedAtLeastOneSpot) {
//da("ready to save list changes\n\n"+getObjArrayAsString(list_memberDataObjs,"itemId","sortPosition"))
        listItemObj.saveListMembersToDatastore(list_memberDataObjs);
      }

      //exit this for-loop -- was only being used to find the item-being-walked
      break;
    }
  }

  return movedAtLeastOneSpot;
}

function writeBackupExport() {
  var i, keyName, keyValue, txt = "";

  for (i = 0; i < localStorage.length; i++){
    keyName = localStorage.key(i);
    keyValue = localStorage.getItem(keyName);

    if (i > 0) txt += sD2;

    txt += keyName + sD2 + keyValue;
  }

  elem("taExportedBackupText").value = txt;
  elem("taExportedBackupText").select();
}

function writeHtml_GrabbingMove_Items() {
  var singleItemGrab, displayList_itemObj, curList_listMemberDataObjs, html, i, firstGrabbingItemId = null, secondGrabbingItemId = null, firstWas1 = false, firstWas2 = false, wroteFirstHtmlRow = false;

  if ( !isBlank(app.grabbing_itemId1) && isBlank(app.grabbing_itemId2) ) {
    singleItemGrab = true;
    displayList_itemObj = grabItemObj(app.itemObj.displayedOnList_itemId);
  } else {
    singleItemGrab = false;
    displayList_itemObj = app.itemObj;
  }

  html = "<table cellspacing=0 cellpadding=0>\n";
  app.grabbing_itemIdArray = [];

  curList_listMemberDataObjs = displayList_itemObj.getListMemberDataObjs();

  for (i = 0; i < curList_listMemberDataObjs.length; i++){
    let curItemId, curItemObj, writeCurItem = false;

    curItemId = curList_listMemberDataObjs[i].itemId;

    if ( firstGrabbingItemId == null ) {
      
      //we HAVE NOT found the earliest-sort-position grabbed-item yet

      if ( isEqual(curItemId, app.grabbing_itemId1) ) {
        //the current item matches grab-item-1

        //... set info about first-grabbed-item found
        firstGrabbingItemId = app.grabbing_itemId1;
        firstWas1 = true;

        //... mark that we should write the current item
        writeCurItem = true;
      }

      if ( isEqual(curItemId, app.grabbing_itemId2) ) {
        //the current item matches grab-item-2

        //... set info about first-grabbed-item found
        firstGrabbingItemId = app.grabbing_itemId2;
        firstWas2 = true;

        //... mark that we should write the current item
        writeCurItem = true;
      }

    } else {

      //we HAVE found the earliest-sort-position grabbed-item yet

      //... NOTE: this ELSE section does not apply to single-item-grab, as we will exit this loop on the pass when firstGrabbingItemId is filled with the single-item, above

      //we should always write the current item now, because firstGrabbingItem is filled (non-null)
      writeCurItem = true;

      if (firstWas1) {

        //the earliest-sort-position grabbed-item was 1, so check 2 to see if we're done after the current item
        if ( isEqual(curItemId, app.grabbing_itemId2) ) {

          //the current item matches grab-item-2, so mark it as the second-grabbed-item found
          secondGrabbingItemId = app.grabbing_itemId2;
        }

      } else {

        //the earliest-sort-position grabbed-item was 2, so check 1 to see if we're done after the current item
        if ( isEqual(curItemId, app.grabbing_itemId1) ) {

          //the current item matches grab-item-1, so mark it as the second-grabbed-item found
          secondGrabbingItemId = app.grabbing_itemId1;
        }

      }

    }

    //check if we've gotten to the earliest-sort-position grabbed-item yet; if so, we can write HTML
    if (writeCurItem) {
      curItemObj = grabItemObj(curItemId);

      //save the item in an array, for use in the next step
      app.grabbing_itemIdArray.push(curItemId);

      if (wroteFirstHtmlRow) {
        html += "<tr style='height: 0.8em'><td></td><td></td></tr>\n";
      }

      html += "<tr><td>\n";
      html += " <table cellspacing=0 cellpadding=0>\n";
      html += " <tr style='height: 2px'><td></td></tr>\n";
      html += " <tr><td style='color: black; font-size: 125%'>&bull;</td></tr>\n";
      html += " </table>\n";
      html += "</td><td style='width: 0.5em'></td><td>" + curItemObj.itemName + "</td></tr>\n";

      wroteFirstHtmlRow = true;

      //always break for single-item-grab, after this one row is written
      if (singleItemGrab) {
        break;
      }
    }

    //if first-grabbed-item and second-grabbed-item are filled, we can now exit this loop
    if ( firstGrabbingItemId !== null && secondGrabbingItemId !== null ) {
      break;
    }
  }

  html += "</table>\n";

  return html;
}

function writeHtml_GrabbingMove_ListOptions() {
  var singleItemGrab, displayList_itemId, allItemIds_string, allItemIds_array, html = "", i, wroteFirstHtmlRow = false;

  if ( !isBlank(app.grabbing_itemId1) && isBlank(app.grabbing_itemId2) ) {
    singleItemGrab = true;
    displayList_itemId = app.itemObj.displayedOnList_itemId;
  } else {
    singleItemGrab = false;
    displayList_itemId = app.itemObj.itemId;
  }

  allItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
  allItemIds_array = getIdArray(allItemIds_string);
  
  html += "<table cellspacing=0 cellpadding=0>\n";

  for (i = 0; i < allItemIds_array.length; i++) {
    let j, skipThisItem = false;
    let curItemId = allItemIds_array[i];
    let curItemObj = grabItemObj(curItemId)

    //don't write the display-list that holds the grabbed-items:
    if ( isEqual(displayList_itemId, curItemId) ) {
      continue;
    }

    //don't write non-list items:
    if (curItemObj.isList == "0") {
      continue;
    }

    //don't write items without displayCode 1:
    if ( !isEqual(curItemObj.displayCode, "1") ) {
      continue;
    }

    //don't write items from the list of grabbed-items
    for (j = 0; j < app.grabbing_itemIdArray.length; j++) {
      if ( isEqual(app.grabbing_itemIdArray[j], curItemId) ) {
        skipThisItem = true;
        continue;
      }
    }
    if (skipThisItem) {
      continue;
    }

    //everything else is okay to write as an available list to move the grabbed-items to
    if (wroteFirstHtmlRow) {
        html += "<tr style='height: 1.6em'><td></td><td></td></tr>\n";
    }

    html += "<tr><td>\n";
    html += " <table cellspacing=0 cellpadding=0>\n";
    html += " <tr style='height: 2px'><td></td></tr>\n";
    html += " <tr><td style='color: black; font-size: 125%'>&bull;</td></tr>\n";
    html += " </table>\n";
    html += "</td><td style='width: 0.5em'></td><td><a href='javascript:void choose_target_list(\"" + curItemId + "\")'>" + curItemObj.itemName + "</a></td></tr>\n";

    wroteFirstHtmlRow = true;
  }

  if (!wroteFirstHtmlRow) html += "<tr><td>(no other lists are available)</td></tr>";

  html += "</table>\n";

  return html;
}

function writeHtml_Items(mainItemObj) {
  var listMemberDataObjs, html = "", i;

  if ( isBlank(mainItemObj) ) {
    mainItemObj = app.itemObj;
  }

  if (mainItemObj.isList) {
    //get array of list-member-item-ids
    listMemberDataObjs = mainItemObj.getListMemberDataObjs();

    //open html table
    html += "<table cellspacing=0 cellpadding=0>\n";

    //loop through array to write list in HTML
    for (i = 0; i < listMemberDataObjs.length; i++){
      let curItemId, curItemObj, addAsterisk, itemNameDisplay;

      curItemId = listMemberDataObjs[i].itemId;

      if (i > 0) {
        html += "<tr style='height: 1.4em'><td></td><td></td></tr>\n";
      }

      //call the function that grabs the current item's item-info from storage and returns it as a js-object
      curItemObj = grabItemObj(curItemId);

      //add asterisk to item-name if it has notes or list-members
      addAsterisk = false;

      if ( !isBlank(curItemObj.notes) ) {
        addAsterisk = true;
      } else {
        if ( curItemObj.hasListMembers() ) {
          addAsterisk = true;
        }
      }

      if (addAsterisk) {
        itemNameDisplay = curItemObj.itemName + " *";
      } else {
        itemNameDisplay = curItemObj.itemName;
      }

      //set html based on item-info values stored as properties of the item-info-js-object
      html += "<tr><td>\n";
      html += " <table cellspacing=0 cellpadding=0>\n";
      html += " <tr style='height: 2px'><td></td></tr>\n";
      html += " <tr><td style='color: black; font-size: 125%'>&bull;</td></tr>\n";
      html += " </table>\n";
      html += "</td><td style='width: 0.5em'></td><td><a id='" + getHtml_aItem(curItemId) + "'" ;
      if (curItemObj.done == "1") html += " class='green'";
      html += " href='javascript:void click_item(\"" + curItemId + "\")'>" + itemNameDisplay + "</a></td></tr>\n";
      html += "<tr style='height: 0.8em'><td colspan=3></td></tr>\n"
      html += "<tr id='" + getHtml_trActivated(curItemId) + "' style='display: "
      if ( ! isEqual(curItemId, app.activatedItemId) ) html += "none";
      html += "'><td style='height: 1em' colspan=2></td><td>\n";
      html += " <table id='" + getHtml_tblReorderChoices(curItemId) + "' cellspacing=0 cellpadding=0>\n";
      html += " <tr><td>&nbsp;&nbsp;&nbsp;</td><td>";
      html += "  <a href='javascript:void move_item_to_other_item(\"" + curItemId + "\")'>move to other item</a>\n";
      html += " </td></tr>\n";
      html += " <tr style='height: 1em'><td colspan=2></td></tr>";
      html += " <tr><td>&nbsp;&nbsp;&nbsp;</td><td>";
      html += "  <a href='javascript:void move_item_up(\"" + curItemId + "\", 1)'>up 1</a>\n";
      html += "  &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href='javascript:void move_item_down(\"" + curItemId + "\", 1)'>down 1</a>\n";
      html += " </td></tr>\n";
      html += " <tr style='height: 1em'><td colspan=2></td></tr>";
      html += " <tr><td>&nbsp;&nbsp;&nbsp;</td><td>";
      html += "  <a href='javascript:void move_item_up(\"" + curItemId + "\", 5)'>up 5</a>\n";
      html += "  &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href='javascript:void move_item_down(\"" + curItemId + "\", 5)'>down 5</a>\n";
      html += " </td></tr>\n";
      html += " <tr style='height: 1em'><td colspan=2></td></tr>";
      html += " <tr><td>&nbsp;&nbsp;&nbsp;</td><td>";
      html += "  <a href='javascript:void move_item_up(\"" + curItemId + "\", 10)'>up 10</a>\n";
      html += "  &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href='javascript:void move_item_down(\"" + curItemId + "\", 10)'>down 10</a>\n";
      html += " </td></tr>\n";
      html += " <tr style='height: 1em'><td colspan=2></td></tr>";
      html += " <tr><td>&nbsp;&nbsp;&nbsp;</td><td>";
      html += "  <a href='javascript:void move_item_to_top(\"" + curItemId + "\")'>to top</a>\n";
      html += "  &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href='javascript:void move_item_to_end(\"" + curItemId + "\")'>to end</a>\n";
      html += " </td></tr>\n";
      html += " </table>\n";
      html += " <div id='" + getHtml_dvReorderItemInstructions(curItemId) + "' style='display: none'><i>now click the other item</i></div>\n";
      html += "</td></tr>\n";
    }

    if (listMemberDataObjs.length == 0) {
      if (mainItemObj.isWibType == "1") {
        html += "<tr'><td>(no info-fields yet for this Type)</td></tr>";
      } else {
        html += "<tr'><td>(no items)</td></tr>";
      }
      html += "<tr style='height: 0.85em'><td></td></tr>";
    }

    html += "</table>\n";
  }

//elem("taDev1").value = html;
  return html;
}

function writeStorage() {
  var i, keyName, keyValue, html = "", curListId, curListName, appNarrow;

  appNarrow = getFromDatastore(CONST_appNarrow);

  html += "<div><a href='javascript:void add_storage_row()'>add</a></div>\n";
  html += "<div style='height:0.8em'></div>\n";
  html += "<table cellpadding=5 cellspacing=0 border=1>\n";

  if (localStorage.length <= 0) {
    html += "<tr><td>(no items in storage)</td></tr>\n";
  } else {
    if (appNarrow == "1") {
      html += "<tr><td></td><td>\n";
      html += "  <table cellpadding=0 cellspacing=0>\n";
      html += "  <tr><td><b>Key Name</b></td></tr>\n";
      html += "  <tr><td style='height: 3px'></td></tr>\n";
      html += "  <tr><td style='height: 1px; background-color: black'></td></tr>\n";
      html += "  <tr><td style='height: 3px'></td></tr>\n";
      html += "  <tr><td><b>Key Value</b></td></tr>\n";
      html += "  </table>\n";
      html += "</td></tr>\n";
    } else {
      html += "<tr><td></td><td><b>Key Name</b></td><td><b>Key Value</b></td></tr>\n";
    }
  }

  for (i = 0; i < localStorage.length; i++) {
    keyName = localStorage.key(i);
    keyValue = getFromDatastore(keyName);

    if (appNarrow == "1") {
      html += "<tr><td>\n";
      html += "  <table cellpadding=0 cellspacing=0>\n";
      html += "  <tr><td><a href='javascript:void edit_storage_row(\"" + keyName + "\")'>edit</a></td></tr>\n";
      html += "  <tr><td style='height: 15px'></td></tr>\n";
      html += "  <tr><td><a href='javascript:void change_storage_key_name(\"" + keyName + "\")'>change key</a></td></tr>\n";
      html += "  <tr><td style='height: 15px'></td></tr>\n";
      html += "  <tr><td><a href='javascript:void delete_storage_row(\"" + keyName + "\")'>delete</a></td></tr>\n";
      html += "  </table>\n";
      html += "</td>\n";
    } else {
      html += "<tr><td style='white-space: nowrap'>&nbsp;<a href='javascript:void edit_storage_row(\"" + keyName + "\")'>edit</a>\n";
      html += "&nbsp;|&nbsp;&nbsp;<a href='javascript:void change_storage_key_name(\"" + keyName + "\")'>change key</a>\n";
      html += "&nbsp;|&nbsp;&nbsp;<a href='javascript:void delete_storage_row(\"" + keyName + "\")'>delete</a>&nbsp;&nbsp;</td>\n";
    }

    if (appNarrow == "1") {
      html += "<td>" + keyName + "</td></tr>\n";
      html += "<tr><td></td><td>" + keyValue + "</td></tr>\n";
    } else {
      html += "<td>" + keyName + "</td><td>" + keyValue + "</td></tr>\n";
    }
  }

  html += "</table>\n";
  html += "<div style='height:0.8em'></div>\n";
  html += "<div><a href='javascript:void add_storage_row()'>add</a></div>\n";

  elem("dvStorage").innerHTML = html;
}


///// USER-CLICKABLE FUNCTIONS

function add_notes() {
  var newNotes = prompt("Notes:", "");
  if ( isBlank(newNotes) ) return;
  app.itemObj.changeItem(null, null, null, null, newNotes);
  goToItemView(null, true);
}

function add_storage_row() {
  var keyName = prompt("New key name:", "");
  var keyValue = prompt("New key value:", "");

  if ( isBlank(keyName) ) {
    return;
  }

  saveToDatastore(keyName, keyValue);
  show_storage();
}

function begin_import() {
  var textToImport = elem("taBackupTextToImport").value;
  if ( isBlank(textToImport) ) return;
  importBackupText(textToImport);
}

function cancel_make_new_item() {
  hidePopUp("MakeNewItem");
}

function cancel_make_new_type() {
  hidePopUp("MakeNewWibType");
}

function cancel_make_new_type_info_field() {
  hidePopUp("MakeNewWibTypeInfoField");
}

function cancel_move() {
  disableGrabbing();
  goToItemView(null, false);
}

function change_storage_key_name(curKeyName) {
  var editedKeyName, keyValue, keyValueFromEditedKeyName, warningMsg, confirmationMsg;

  //get new key name user requests
  editedKeyName = prompt("Change key name to:", curKeyName);

  //exit if user did not provide a new key name
  if ( isBlank(editedKeyName) ) {
    return;
  }

  //grab existing key value for current key name
  keyValue = getFromDatastore(curKeyName);

  //check to see if new requestd key name is already in use; if so, disallow
  keyValueFromEditedKeyName = getFromDatastore(editedKeyName);
  if ( !isBlank(keyValueFromEditedKeyName) ) {
    warningMsg = "*** OPERATION DISALLOWED ***\n";
    warningMsg += "You tried to change key with keyName='" + curKeyName + "'\n";
    warningMsg += "( keyValue='" + keyValue + "' )\n";
    warningMsg += "... to the new-keyName '" + editedKeyName + "'\n";
    warningMsg += "... but that new-keyName already exists, with existing-keyValue '" + keyValueFromEditedKeyName + "'";
    alert(warningMsg);
    return;
  }

  //save new key to storage
  saveToDatastore(editedKeyName, keyValue);

  //delete previous key name
  deleteFromDatastore(curKeyName);

  //provide info with change
  confirmationMsg = "Change Made:\n\n";
  confirmationMsg += " old-keyName: " + curKeyName + "\n";
  confirmationMsg += " new-keyName " + editedKeyName + "\n";
  confirmationMsg += " keyValue: " + keyValue;
  alert(confirmationMsg);

  //refresh storage view
  show_storage();
}

function choose_target_list(newList_itemId) {
  var singleItemGrab, oldList_itemObj, newList_itemObj;

  if ( !isBlank(app.grabbing_itemId1) && isBlank(app.grabbing_itemId2) ) {
    singleItemGrab = true;
    oldList_itemObj = grabItemObj(app.itemObj.displayedOnList_itemId);
  } else {
    singleItemGrab = false;
    oldList_itemObj = app.itemObj;
  }

  newList_itemObj = grabItemObj(newList_itemId);
  transferItems(oldList_itemObj, newList_itemObj, app.grabbing_itemIdArray);

  disableGrabbing();

  if (singleItemGrab) {
    //reset the display-item-object -- still is correct itemId-property in app.itemObj, but list-membership change means we need to reset the app.itemObj by re-passing in its item-id
    goToItemView(app.itemObj.itemId, false);
  } else {
    //display the item-object for the list where the grabbed-items where transferred to
    goToItemView(newList_itemId, false);
  }
}

function clear_storage() {
  var clearStoragePrompt;
  
  clearStoragePrompt = prompt("type 'clear it' to clear local storage", "");

  if (clearStoragePrompt == "clear it") {
    localStorage.clear();
    alert("storage cleared");
    loadAppData();
    displayPage("Home");
  } else {
    alert("storage NOT cleared");
  }
}

function click_item(itemId) {
  if (app.grabbingEnabled) {
    setGrabItem(itemId);
    return;
  }

  if (app.reorderEnabled) {

    if ( !isBlank(app.reorderItemId) ) {
      reorderItemToOtherItem(itemId);      
    } else if ( isBlank(app.activatedItemId) ) {
      activateItem(itemId);
    } else {
      if ( isEqual(itemId, app.activatedItemId) ) {
        goToItemView(itemId, false);
      } else {
        deactivateItem(app.activatedItemId);
        activateItem(itemId);
      }
    }

  } else {

    goToItemView(itemId, false);

  }
}

function copy_imported_text_to_clipboard() {
  elem("taExportedBackupText").select();  
  document.execCommand("copy")
  alert("backup text copied to clipboard");
}

function delete_item() {
  if ( confirm("Delete this item?\n\nItem Name: " + app.itemObj.itemName) ) {
    if ( deleteItem(app.itemObj.itemId) ) {
      if ( !isBlank(app.itemObj) ) {
        goToItemView(null, false);
      } else {
        return_home();
      }
    }
  }
}

function delete_notes() {
  if ( confirm("Delete all Notes for this item?\n\nItem Name: " + app.itemObj.itemName + "\n\nNotes: " + app.itemObj.notes) ) {
    app.itemObj.changeItem(null, null, null, null, "");
    goToItemView(null, true);
  }
}

function delete_storage_row(keyName) {
  if ( confirm("Delete this row?") ) {
    deleteFromDatastore(keyName);
    show_storage();
  }
}

function do_make_new_item() {
  var itemName, topOfList, stayListView, addMoreItems, newItemObj;

  itemName = getElemVal("ipMakeNewItem_ItemName");

  if ( !itemNameIsAllowed(itemName) ) {
    return;
  }

  topOfList = getElemVal("ipMakeNewItem_TopOfList");
  app.makeNewItem_TopOfList = topOfList;

  stayListView = getElemVal("ipMakeNewItem_StayListView");
  app.makeNewItem_StayListView = stayListView;

  addMoreItems = getElemVal("ipMakeNewItem_AddMoreItems");
  app.makeNewItem_AddMoreItems = addMoreItems;

  if ( isBlank(itemName) ) {
    alert("Item Name is required");
    return;
  }

  newItemObj = makeNewItem("0", "0", false, itemName, null, null, "0", app.itemObj.itemId);
  if ( newItemObj ) {

    if (topOfList == "1") {
      walkSortPosition(app.itemObj, newItemObj.itemId, null, true, false, null);
    }

    if (stayListView == "0" && addMoreItems == "0") {
      setAppItemObj(newItemObj);
    }

    hidePopUp("MakeNewItem");
    displayPage("ViewItem");

    if (addMoreItems == "1") {
      showPopUp("MakeNewItem", "ipMakeNewItem_ItemName");
    }
  }
}

function do_make_new_type() {
  var itemName, newItemObj;

  itemName = getElemVal("ipMakeNewWibType_WibTypeName");

  if ( !itemNameIsAllowed(itemName) ) {
    return;
  }

  if ( isBlank(itemName) ) {
    alert("Type Name is required");
    return;
  }

  newItemObj = makeNewItem("0", "1", false, itemName, null, null, "1", app.itemObj.itemId);
  if ( newItemObj ) {
    hidePopUp("MakeNewWibType");
    displayPage("WibTypes");
  }
}

function do_make_new_type_info_field() {
  var itemName, wibDataTypeId, newItemObj;

  itemName = getElemVal("ipMakeNewWibTypeInfoField_WibTypeInfoFieldName");
  wibDataTypeId = getElemVal("selMakeNewWibTypeInfoField_WibDataTypeId");

  if ( !itemNameIsAllowed(itemName) ) {
    return;
  }

  if ( isBlank(itemName) ) {
    alert("Info-Field Name is required");
    return;
  }

  if ( isBlank(wibDataTypeId) ) {
    alert("Data Type is required");
    return;
  }

  newItemObj = makeNewItem("1", "0", false, itemName, null, null, "0", app.itemObj.itemId);
  if ( newItemObj ) {
    hidePopUp("MakeNewWibTypeInfoField");
    newItemObj.setWibTypeInfo(wibDataTypeId, true);
    displayPage("ViewItem");
  }
}

function edit_notes() {
  var editedNotes = prompt("Notes:", app.itemObj.notes);
  if ( isBlank(editedNotes)) {
    alert("Edit canceled because a blank Notes entry was received\n\n(click 'delete notes' if you want to remove all notes for this item)");
    return;
  }
  app.itemObj.changeItem(null, null, null, null, editedNotes);
  goToItemView(null, true);
}

function edit_storage_row(keyName) {
  var curKeyValue = getFromDatastore(keyName);

  if (curKeyValue.length > 999) {
    throw ("curKeyValue.length > 999, so not sure if javascript prompt box will work => exiting with error");
  }

  var editedKeyValue = prompt("Change key value to:", curKeyValue);

  if ( editedKeyValue == null ) {
    return;
  }

  saveToDatastore(keyName, editedKeyValue);
  show_storage();
}

function export_backup_text() {
  displayPage("BackupExport");
}

function go_to_list(itemId) {
  goToItemView(itemId, false);
}

function grab_items() {
  if (app.grabbingEnabled) {
    stopGrabbingItems();
  } else {
    startGrabbingItems();
  }
}

function import_backup_text() {
  if ( getFromDatastore(CONST_importBlocked) == "1" ) {
    alert("OPERATION DISALLOWED\n\nImporting of text has been blocked on this device");
    return;
  }
  displayPage("BackupImport");
}

function mark_item_as_done() {
  app.itemObj.changeItem(null, "1", null, null, null);

  if ( isBlank(app.itemObj.displayedOnList_itemId) ) {
    goToItemView(null, false);
  } else {
    goToItemView(app.itemObj.displayedOnList_itemId, false);
  }
}

function make_into_a_list() {
  app.itemObj.makeIntoAList();
  goToItemView(null, false);
}

function make_new_item() {
  showPopUp("MakeNewItem", "ipMakeNewItem_ItemName");
}

function make_new_list() {
  var newItemObj;

  newItemObj = makeNewItem("0", "0", false, null, "new list name:", null, "1", app.homePageList_itemId);
  if ( newItemObj ) {
    setAppItemObj(newItemObj);
    displayPage("ViewItem");
  }
}

function make_new_type() {
  showPopUp("MakeNewWibType", "ipMakeNewWibType_WibTypeName");
}

function make_new_type_info_field() {
  elem("spnMakeNewWibTypeInfoField_WibTypeName").innerHTML = app.itemObj.itemName;

  showPopUp("MakeNewWibTypeInfoField", "ipMakeNewWibTypeInfoField_WibTypeInfoFieldName");
}

function mark_all() {
  var markDirectionIsDone = false, listMemberDataObjs, i, confirmText;
  
  listMemberDataObjs = app.itemObj.getListMemberDataObjs();

  for (i = 0; i < listMemberDataObjs.length; i++) {
    let curItemObj = grabItemObj(listMemberDataObjs[i].itemId);

    //if we find at least one that is not-done, that mark-all direction will be towards Done
    if (curItemObj.done == "0") {
      markDirectionIsDone = true;
      break;
    }
  }

  confirmText = "mark all items on this list as";
  if (markDirectionIsDone) {
    confirmText += " done?";
  } else {
    confirmText += " not done?";
  }

  if ( !confirm(confirmText) ) {
    return;
  }

  app.itemObj.markAllListMembers(markDirectionIsDone, listMemberDataObjs);

  goToItemView(null, true);
}

function move_item_down(itemId, amount) {
  if ( walkSortPosition(app.itemObj, itemId, Math.abs(amount), false, false, null) ) {
    goToItemView(null, true);
  }
}

function move_item_to_end(itemId) {
  if ( walkSortPosition(app.itemObj, itemId, null, false, true, null) ) {
    goToItemView(null, true);
  }
}

function move_item_to_other_item(itemId) {
  app.reorderItemId = itemId;
  elem(getHtml_tblReorderChoices(itemId)).style.display = "none";
  elem(getHtml_dvReorderItemInstructions(itemId)).style.display = "";
}

function move_item_to_top(itemId) {
  if ( walkSortPosition(app.itemObj, itemId, null, true, false, null) ) {
    goToItemView(null, true);
  }
}

function move_item_up(itemId, amount) {
  if ( walkSortPosition(app.itemObj, itemId, Math.abs(amount) * -1, false, false, null) ) {
    goToItemView(null, true);
  }
}

function move_to_different_list() {
  app.grabbing_itemId1 = app.itemObj.itemId;
  app.grabbing_itemId2 = null;
  goToGrabbingMove();
}

function rename_item() {
  var editedItemName = prompt("Change item name to:", app.itemObj.itemName);
  if ( isBlank(editedItemName)) return;
  app.itemObj.changeItem(editedItemName, null, null, null, null);
  goToItemView(null, true);
}

function return_home() {
  setAppItemObj(grabItemObjByName(CONST_listName_homePage));
  displayPage("Home");
}

function return_home_from_storage() {
  loadAppData();
  displayPage("Home");
}

function show_dev_screen() {
  displayPage("Dev");
}

function show_storage() {
  displayPage("ShowStorage");
}

function show_types() {
  displayPage("WibTypes");
}

function toggle_app_narrow() {
  var curAppNarrow, newAppNarrow;

  curAppNarrow = getFromDatastore(CONST_appNarrow);

  if ( curAppNarrow == "1" ) {
    newAppNarrow = "0";
  } else {
    newAppNarrow = "1";
  }

  saveToDatastore(CONST_appNarrow, newAppNarrow);

  alert("app_narrow set to " + newAppNarrow);
}

function toggle_dev() {
  var curDevText1, newDevText1;

  curDevText1 = getFromDatastore(CONST_devText1);

  if (curDevText1 == "1") {
    newDevText1 = "0";
  } else {
    newDevText1 = "1";
  }

  saveToDatastore(CONST_devText1, newDevText1);

  alert("devText1 set to " + newDevText1);
}

function toggle_import_blocked() {
  var curImportBlocked, newImportBlocked;

  curImportBlocked = getFromDatastore(CONST_importBlocked);

  if ( curImportBlocked == "1" ) {
    newImportBlocked = "0";
  } else {
    newImportBlocked = "1";
  }

  saveToDatastore(CONST_importBlocked, newImportBlocked);

  alert("importBlocked set to " + newImportBlocked);
}

function toggle_more_options() {
  if (app.moreOptionsEnabled) {
    elem("dvMoreOptions1").style.display = "none";
    elem("dvMoreOptions2").style.display = "none";
    elem("aMoreOptions1").innerHTML = "more...";
    elem("aMoreOptions2").innerHTML = "more...";
    app.moreOptionsEnabled = false;
  } else {
    elem("dvMoreOptions1").style.display = "";
    elem("dvMoreOptions2").style.display = "";
    elem("aMoreOptions1").innerHTML = "less...";
    elem("aMoreOptions2").innerHTML = "less...";
    app.moreOptionsEnabled = true;
  }
}

function toggle_reorder() {
  if (app.reorderEnabled) {
    app.reorderEnabled = false;
    app.reorderItemId = null;
    elem("aReorder1").style.color = "";
    elem("aReorder2").style.color = "";
    if ( !isBlank(app.activatedItemId) ) {
      deactivateItem(app.activatedItemId);
    }
  } else {
    app.reorderEnabled = true;
    app.reorderItemId = null;
    elem("aReorder1").style.color = "red";
    elem("aReorder2").style.color = "red";
  }
}

function unmark_item_as_done() {
  app.itemObj.changeItem(null, "0", null, null, null);
  goToItemView(null, true);
}


///// FUNCTIONS TO LOAD & UPGRADE APP-LEVEL DATA FROM STORAGE

function loadAppData() {
  var homePageListItemObj, wibTypesItemObj;

  //set success-flag to false
  app.dataLoadedSuccessfully = false;

  //if it does not exist, create a home-page-list item
  homePageListItemObj = grabItemObjByName(CONST_listName_homePage);
  if ( !homePageListItemObj ) {
    homePageListItemObj = makeNewItem("0", "0", true, CONST_listName_homePage, null, "0", "1", null)
  }

  //set home-page-list item-id
  app.homePageList_itemId = homePageListItemObj.itemId;

  //if it does not exist, create a wibTypes item
  wibTypesItemObj = grabItemObjByName(CONST_listName_wibTypes);
  if ( !wibTypesItemObj ) {
    wibTypesItemObj = makeNewItem("0", "0", true, CONST_listName_wibTypes, null, "0", "1", null)
  }

  //set wibTypes item-id
  app.wibTypes_itemId = wibTypesItemObj.itemId;

  //set app current-item to home-page-list
  setAppItemObj(homePageListItemObj);

  //update stored-data
  if ( ! upgradeStoredData() ) {
    return;
  }

  //set version# on screen
  elem("spnAppNameAndVersion").innerHTML = "wib v" + CONST_appVersion;

  app.dataLoadedSuccessfully = true;
}

function upgradeStoredData() {
  var appVersion_array, appVersion_major, appVersion_minor;
  var storedDataVersion_string, storedDataVersion_array, storedDataVersion_major, storedDataVersion_minor;

  //split app-version into major and minor
  appVersion_array = CONST_appVersion.split(".");
  appVersion_major = Number(appVersion_array[0]);
  appVersion_minor = Number(appVersion_array[1]);

  //establish existing version of the stored data
  storedDataVersion_string = getFromDatastore(CONST_storedDataVersion);
  if ( isBlank(storedDataVersion_string) ) storedDataVersion_string = "0.0";
  
  //split stored-data-version into major and minor
  storedDataVersion_array = storedDataVersion_string.split(".");
  storedDataVersion_major =  Number(storedDataVersion_array[0]);
  storedDataVersion_minor =  Number(storedDataVersion_array[1]);

  //warning if major version differs
  if ( !isEqual(appVersion_major, storedDataVersion_major) ) {
    alert("WARNING: app version is " + appVersion_major + ", stored data version is " + storedDataVersion_major + " ... no automatic data update available yet for major version upgrades");
    return false;
  }

  if (parseInt(appVersion_minor) >= 36 && parseInt(storedDataVersion_minor) < 36) {
    if ( upgradeStoredData_0_36() ) {
      // no action -- continue with function
    } else {
      return false;
    }
  }

  if (parseInt(appVersion_minor) >= 37 && parseInt(storedDataVersion_minor) < 37) {
    if ( upgradeStoredData_0_37() ) {
      // no action -- continue with function
    } else {
      return false;
    }
  }

  if (parseInt(appVersion_minor) >= 53 && parseInt(storedDataVersion_minor) < 53) {
    if ( upgradeStoredData_0_53() ) {
      // no action -- continue with function
    } else {
      return false;
    }
  }

  if (parseInt(appVersion_minor) >= 54 && parseInt(storedDataVersion_minor) < 54) {
    if ( upgradeStoredData_0_54() ) {
      // no action -- continue with function
    } else {
      return false;
    }
  }

  return true;
}

function upgradeStoredData_0_36() {
  var allItemIds_string, allItemIds_array, i, curItemId, saveKeyText_curItem, oldItemInfoString, newItemInfoString, storedDataVersion_string;

  allItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
  allItemIds_array = getIdArray(allItemIds_string);
 
  //cycle through all items, add blank Notes field for each
  for (i = 0; i < allItemIds_array.length; i++) {
    curItemId = allItemIds_array[i];
    saveKeyText_curItem = getSaveKeyText_item(curItemId);
    oldItemInfoString = getFromDatastore(saveKeyText_curItem);
    newItemInfoString = oldItemInfoString + sD;
    saveToDatastore(saveKeyText_curItem, newItemInfoString);
  }

  //update data's version-number to 0.36
  saveToDatastore(CONST_storedDataVersion, "0.36");

  //return success flag
  return true;
}

function upgradeStoredData_0_37() {
  var allItemIds_string, allItemIds_array, i, j;

  allItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
  allItemIds_array = getIdArray(allItemIds_string);
 
  //cycle through all items
  for (i = 0; i < allItemIds_array.length; i++) {
    let curItemId = allItemIds_array[i];
    let curItemObj = grabItemObj(curItemId);

    //for each item, if it is-list, cycle through list-members
    if (curItemObj.isList == "1") {
      let saveKeyText_listMembers_ofCurItem = getSaveKeyText_listMembers_ofItem(curItemId);
      let oldListMembers_string = getFromDatastore(saveKeyText_listMembers_ofCurItem);
      let oldListMembers_array = getIdArray(oldListMembers_string);
      let newListMembers_string = "";

      //add sort-position-number after each item-id
      for (j = 0; j < oldListMembers_array.length; j++) {
        if (newListMembers_string !== "") newListMembers_string += sD
        newListMembers_string += oldListMembers_array[j] + sD + String(j);
      }

      saveToDatastore(saveKeyText_listMembers_ofCurItem, newListMembers_string)
    }
  }

  //update data's version-number to 0.37
  saveToDatastore(CONST_storedDataVersion, "0.37");

  //return success flag
  return true;
}

function upgradeStoredData_0_53() {
  var allItemIds_string, allItemIds_array, i, curItemId, saveKeyText_curItem, oldItemInfoString, newItemInfoString, storedDataVersion_string;

  allItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
  allItemIds_array = getIdArray(allItemIds_string);
 
  //cycle through all items, add isWibType field for each
  // (isWibType == "0" for all existing items, as no wibTypes have been created yet)
  for (i = 0; i < allItemIds_array.length; i++) {
    curItemId = allItemIds_array[i];
    saveKeyText_curItem = getSaveKeyText_item(curItemId);
    oldItemInfoString = getFromDatastore(saveKeyText_curItem);
    newItemInfoString = oldItemInfoString + sD + "0";
    saveToDatastore(saveKeyText_curItem, newItemInfoString);
  }

  //update data's version-number to 0.53
  saveToDatastore(CONST_storedDataVersion, "0.53");

  //return success flag
  return true;
}

function upgradeStoredData_0_54() {
  var allItemIds_string, allItemIds_array, i, curItemId, saveKeyText_curItem, oldItemInfoString, newItemInfoString, storedDataVersion_string;

  allItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
  allItemIds_array = getIdArray(allItemIds_string);
 
  //cycle through all items, add isWibTypeInfoField field for each
  // (isWibTypeInfoField == "0" for all existing items, as no wibTypeInfoFields have been created yet)
  for (i = 0; i < allItemIds_array.length; i++) {
    curItemId = allItemIds_array[i];
    saveKeyText_curItem = getSaveKeyText_item(curItemId);
    oldItemInfoString = getFromDatastore(saveKeyText_curItem);
    newItemInfoString = oldItemInfoString + sD + "0";
    saveToDatastore(saveKeyText_curItem, newItemInfoString);
  }

  //update data's version-number to 0.54
  saveToDatastore(CONST_storedDataVersion, "0.54");

  //return success flag
  return true;
}


///// RUN APP-DATA-LOAD AND SHOW HOME PAGE

loadAppData();

//only show home page is appLevelData loaded successfully
if ( app.dataLoadedSuccessfully ) {
  displayPage("Home");
}


//// SAVED FROM PREVIOUS PROJECT, MIGHT USE LATER

/*
// MODULE-LEVEL ERROR HANDLING - TOP
try {

var DIRECTION_east = "east" ;
var DIRECTION_north = "north" ;
var DIRECTION_south = "south" ;
var DIRECTION_west = "west" ;

var KEY_NAME_alt = "alt" ;
var KEY_NAME_backspace = "backspace" ;
var KEY_NAME_ctrl = "ctrl" ;
var KEY_NAME_delete = "delete" ;
var KEY_NAME_down_arrow = "down arrow" ;
var KEY_NAME_end = "end" ;
var KEY_NAME_enter = "enter" ;
var KEY_NAME_esc = "esc" ;
var KEY_NAME_home = "home" ;
var KEY_NAME_left_arrow = "left arrow" ;
var KEY_NAME_page_down = "page down" ;
var KEY_NAME_page_up = "page up" ;
var KEY_NAME_right_arrow = "right arrow" ;
var KEY_NAME_shift = "shift" ;
var KEY_NAME_spacebar = "spacebar" ;
var KEY_NAME_tab = "tab" ;
var KEY_NAME_up_arrow = "up arrow" ;

var page_keyMonitoring = false ;
var page_pauseKeyInput = false ;
var page_sendKeyToCharacter = false ;

var page_escKeyJsFunc = "" ;

var page_curTheKeyDown = null ;
var page_curTheKeyPress = null ;

function getInputElem ( idName , width , defValue ) {
	try {
		var html = "<input id='" + idName + "' name='" + idName + "' type='text' class='input1' style='width: " + width + "' value='" + defValue + "'" ;
		html += " onfocus='keysAllow()' onblur='keysBlock()'/>" ;
		return html ;
	} catch ( e ) {
		throw ( handleAndReturnError ( e ) ) ;
	}
}

function getSelectElem ( idName , includeBlank , theArray , defValue , theStyle , onChange , blankDisplay , disabled ) {
	try {
		var i , html = "<select id='" + idName + "' name='" + idName + "' class='input1'" ;
		var arrayItem , id , display ;

		if ( theStyle ) {
			html += " style='" + theStyle + "'" ;
		}

		if ( onChange ) {
			html += " onchange='javascript:void " + onChange + "'" ;
		}

		if ( disabled ) {
			html += " disabled" ;
		}

		html += " onfocus='keysAllow()' onblur='keysBlock()'>\n" ;

		if ( includeBlank ) {
			html += "<option value=''" ;
			if ( ! defValue ) html += " selected" ;
				html += ">" ;
			if ( blankDisplay ) {
				html += blankDisplay + "</option>\n" ;
			} else {
				html += " </option>\n" ;
			}
		}

		for ( i = 0  ; i < theArray.length ; i++ ) {
			arrayItem = theArray[i] ;
			if ( arrayItem.isRow ) {
				id = arrayItem.id ;
				display = arrayItem.name ;
			} else {
				id = arrayItem ;
				display = arrayItem ;
			}

			html += "<option value='" + id + "'" ;
			if ( isSame(defValue,id) ) html += " selected" ;
			html += ">" + display + "</option>\n" ;
		}

		html += "</select>\n" ;

		return html ;
	} catch ( e ) {
		throw ( handleAndReturnError ( e ) ) ;
	}
}

function processKeyDown_master ( e ) {
	try {
		var eventObject = window.event ? event : e ;  // distinguish between IE's explicit event object (window.event) and Firefox's implicit
		var keyCode = eventObject.keyCode ;
		var keyDownName = "" ;

		if ( (keyCode >= 48 && keyCode <= 57) || (keyCode >= 65 && keyCode <= 90) ) {
			keyDownName = String.fromCharCode ( keyCode ) ;
		} else {
			switch ( keyCode ) {
				case 8 : keyDownName = KEY_NAME_backspace  ; break ;
				case 9 : keyDownName = KEY_NAME_tab ; break ;
				case 13 : keyDownName = KEY_NAME_enter ; break ;
				case 16 : keyDownName = KEY_NAME_shift ; break ;
				case 17 : keyDownName = KEY_NAME_ctrl  ; break ;
				case 18 : keyDownName = KEY_NAME_alt ; break ;
				case 27 : keyDownName = KEY_NAME_esc ; break ;
				case 32 : keyDownName = KEY_NAME_spacebar ; break ;
				case 33 : keyDownName = KEY_NAME_page_up ; break ;
				case 34 : keyDownName = KEY_NAME_page_down ; break ;
				case 35 : keyDownName = KEY_NAME_end ; break ;
				case 36 : keyDownName = KEY_NAME_home ; break ;
				case 37 : keyDownName = KEY_NAME_left_arrow  ; break ;
				case 38 : keyDownName = KEY_NAME_up_arrow ; break ;
				case 39 : keyDownName = KEY_NAME_right_arrow ; break ;
				case 40 : keyDownName = KEY_NAME_down_arrow ; break ;
				case 46 : keyDownName = KEY_NAME_delete ; break ;
				default:
					try {
						console.log ( "keyCode: " + keyCode ) ;
					} catch ( e_inside1 ) {
						// no action -- error is acceptable
					}
			}
		}

		page_curTheKeyDown = new TheKeyDown ( keyDownName , eventObject.ctrlKey , eventObject.altKey , eventObject.shiftKey , eventObject ) ;

		try {
			processKeyDown_page ( page_curTheKeyDown ) ;
		} catch ( e_inside2 ) {
			// no action, error is acceptable
		}
	} catch ( e ) {
		throw ( handleAndReturnError ( e ) ) ;
	}
}

function processKeyDown_page ( theKeyDown ) {
	try {
		var direction ;

		if ( 
		  theKeyDown.keyDownName == KEY_NAME_backspace
		  || theKeyDown.keyDownName == KEY_NAME_spacebar
		  || theKeyDown.keyDownName == KEY_NAME_down_arrow
		  || theKeyDown.keyDownName == KEY_NAME_left_arrow
		  || theKeyDown.keyDownName == KEY_NAME_right_arrow
		  || theKeyDown.keyDownName == KEY_NAME_up_arrow
		  || theKeyDown.keyDownName == KEY_NAME_page_down
		  || theKeyDown.keyDownName == KEY_NAME_page_up
		  || ( theKeyDown.keyDownName == "A" && theKeyDown.ctrl && ! showingLocalStorage )
		) {
			if ( ! control.allowKeys ) theKeyDown.stopEvent ( ) ;
		}

		if ( page_pauseKeyInput ) return ;

		if ( screens.curScreen ) {
			screens.curScreen.processKeyDown ( theKeyDown ) ;
			return ;
		}
	} catch ( e ) {
		throw ( handleAndReturnError ( e ) ) ;
	}
}

function processKeyPress_master ( e ) {
	try {
		var eventObject = window.event ? event : e ; // distinguish between IE's explicit event object (window.event) and Firefox's implicit
		var keyCode = eventObject.keyCode ;
		var charCode = eventObject.charCode ;
		var ctrlKey = eventObject.ctrlKey ;
		var altKey = eventObject.altKey ;
		var shiftKey = eventObject.shiftKey ;
		var keyPressName ;

		//alert("keyCode="+keyCode+" --- charCode="+charCode+" --- ctrlKey="+ctrlKey+" --- altKey="+altKey+" --- shiftKey="+shiftKey)

		if ( charCode ) {
			keyPressName = String.fromCharCode ( charCode ) ;
		} else {
			switch ( keyCode ) {
				case 8 : keyPressName = KEY_NAME_backspace  ; break ;
				case 9 : keyPressName = KEY_NAME_tab ; break ;
				case 13 : keyPressName = KEY_NAME_enter ; break ;
				case 27 : keyPressName = KEY_NAME_esc ; break ;
				case 32 : keyPressName = KEY_NAME_spacebar ; break ;
				case 33 : keyPressName = KEY_NAME_page_up ; break ;
				case 34 : keyPressName = KEY_NAME_page_down ; break ;
				case 35 : keyPressName = KEY_NAME_end ; break ;
				case 36 : keyPressName = KEY_NAME_home ; break ;
				case 37 : keyPressName = KEY_NAME_left_arrow  ; break ;
				case 38 : keyPressName = KEY_NAME_up_arrow ; break ;
				case 39 : keyPressName = KEY_NAME_right_arrow ; break ;
				case 40 : keyPressName = KEY_NAME_down_arrow ; break ;
				case 46 : keyPressName = KEY_NAME_delete ; break ;
				default:
					try {
						console.log ( "keyCode="+keyCode+" --- charCode="+charCode+" --- ctrlKey="+ctrlKey+" --- altKey="+altKey+" --- shiftKey="+shiftKey ) ;
					} catch ( e_inside1 ) {
						// no action -- error is acceptable
					}
			}
		}

		page_curTheKeyPress = new TheKeyPress ( keyPressName , ctrlKey , altKey , shiftKey ) ;
		try {
			processKeyPress_page ( page_curTheKeyPress ) ;
		} catch ( e_inside2 ) {
			// no action, error is acceptable
		}
	} catch ( e ) {
		throw ( handleAndReturnError ( e ) ) ;
	}
}

function processKeyPress_page ( theKeyPress ) {
	try {
		if ( page_pauseKeyInput ) return ;

		if ( screens.curScreen ) {
			screens.curScreen.processKeyPress ( theKeyPress ) ;
			return ;
		}
	} catch ( e ) {
		throw ( handleAndReturnError ( e ) ) ;
	}
}

function startKeyMonitoring ( ) {
	try {
		page_keyMonitoring = true ;
		page_sendKeyToCharacter = true ;
		document.onkeydown = processKeyDown_master ;
		document.onkeypress = processKeyPress_master ;
	} catch ( e ) {
		throw ( handleAndReturnError ( e ) ) ;
	}
}

function TheKeyDown ( keyDownName , ctrl , alt , shift , eventObject ) {
	try {
		this.keyDownName = String(keyDownName) ;
		this.ctrl = ctrl ;
		this.alt = alt ;
		this.shift = shift ;
		this.eventObject = eventObject ;
		
		this.stopEvent = function ( ) {
			this.eventObject.preventDefault ( ) ;
		}
	} catch ( e ) {
		throw ( handleAndReturnError ( e ) ) ;
	}
}

function TheKeyPress ( keyPressName , ctrlKey , altKey , shiftKey ) {
	try {
		this.keyPressName = keyPressName ;
		this.ctrlKey = ctrlKey ;
		this.altKey = altKey ;
		this.shiftKey = shiftKey ;
	} catch ( e ) {
		throw ( handleAndReturnError ( e ) ) ;
	}
}


startKeyMonitoring() ;


// MODULE-LEVEL ERROR HANDLING - BOTTOM
} catch ( e ) {
	throw ( handleAndReturnError ( e ) ) ;
}
*/


</script>

</body>
</html>
