<!DOCTYPE html>
<html>

<meta name="viewport" content="width=device-width, initial-scale=1">

<head>

<style>
a {color: blue; outline: 0}
a:link {text-decoration: none}
a:visited {text-decoration: none}
a:hover {text-decoration: underline}
a:focus {text-decoration: underline}
a:active {text-decoration: none}

body {font-size: 115%}
div {padding: 0; margin: 0}
table {}

<!--
div {padding: 0; margin: 0; height: 100%}
table {height: 100%}
-->

.green {color: #00CC66}
</style>

<title>wib</title>

</head>

<body>

<div>
  <span id="spnAppNameAndVersion" style="font-weight: bold; font-size: 135%">wib v0.0</span>
  &nbsp;&nbsp;<a href="javascript:void show_dev_screen()"><span style="font-size: 80%"><nowrap>dev</nowrap></span></a>
</div>
<div style="height:1.2em"></div>

<div id="dvPage_BackupExport" style="display: none">
  <div style="display: inline-block">
    <div><a href="javascript:void return_home()">return home</a></div>
    <div style="height:1em"></div>
    <table cellspacing=0 cellpadding=0>
    <tr><td style="height: 20px; background-color: red"></td></tr>
    </table>
    <div style="height:1em"></div>
  </div>
  <div style="height:0.8em"></div>
  <textarea id="taExportedBackupText" style="height: 50vh; width: 80vw; border: 1px black solid; padding: 10px"></textarea>
  <div style="height:0.8em"></div>
  <div><a href="javascript:void copy_imported_text_to_clipboard()">copy to clipboard</a></div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_BackupImport" style="display: none">
  <div style="display: inline-block">
    <div><a href="javascript:void return_home()">return home</a></div>
    <div style="height:1em"></div>
    <table cellspacing=0 cellpadding=0">
    <tr><td class="divider"></td></tr>
    </table>
    <div style="height:1em"></div>
  </div>
  <div style="height:0.8em"></div>
  <div>Paste text-to-import below:</div>
  <div style="height:0.4em"></div>
  <textarea id="taBackupTextToImport" style="height: 50vh; width: 80vw; border: 1px black solid; padding: 10px"></textarea>
  <div style="height:0.8em"></div>
  <div><a href="javascript:void begin_import()">begin import</a></div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_Dev" style="display: none">
  <div style="display: inline-block">
    <div><a href="javascript:void return_home()">return home</a></div>
    <div style="height:1em"></div>
    <table cellspacing=0 cellpadding=0">
    <tr><td class="divider"></td></tr>
    </table>
    <div style="height:1em"></div>
  </div>
  <div style="height:0.8em"></div>
  <div><a href="javascript:void export_backup_text()">export backup text</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void import_backup_text()">import backup text</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void toggle_import_blocked()">toggle import-backup-text blocked (for this device)</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void toggle_dev()">toggle dev mode</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void toggle_app_narrow()">toggle app narrow mode</a></div>
  <div style="height:1.7em"></div>
  <div><a href="javascript:void show_storage()">show storage</a></div>
  <div style="height:100em"></div>
  <div><a href="javascript:void clear_storage()">clear storage</a></div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_GrabbingMove" style="display: none">
  <div><i>from list:</i>&nbsp;&nbsp;&nbsp;<span id="spnGrabbingMove_FromList"></span></div>
  <div style="height:1.5em"></div>
  <div><i>moving these items:</i></div>
  <div style="height:0.8em"></div>
  <div style="display: inline-block">
    <div style="border-bottom: 1px black solid"></div>
    <div style="height:1em"></div>
    <div id="dvGrabbingMove_Items"></div>
    <div style="height:1em"></div>
    <div style="border-bottom: 1px black solid"></div>
  </div>
  <div style="height:1.5em"></div>
  <div><i>to which list?</i>&nbsp;&nbsp;&nbsp;<a href="javascript:void cancel_move()"><nowrap>cancel</nowrap></a></div>
  <div style="height:0.8em"></div>
  <div style="display: inline-block">
    <div style="border-bottom: 1px black solid"></div>
    <div style="height:1em"></div>
    <div id="dvGrabbingMove_ListOptions"></div>
    <div style="height:1em"></div>
    <div style="border-bottom: 1px black solid"></div>
  </div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_Home" style="display: none">
  <div style="font-weight: bold">Home</div>
  <div style="height:0.8em"></div>
  <div><a href="javascript:void make_new_list()">make new list</a></div>
  <div style="height:1em"></div>
  <div style="display: inline-block">
    <div style="border-bottom: 1px black solid"></div>
    <div style="height:1em"></div>
    <div id="dvHome_Items"></div>
    <div style="height:1em"></div>
    <div style="border-bottom: 1px black solid"></div>
  </div>
  <div style="height:0.8em"></div>
  <div><a href="javascript:void make_new_list()">make new list</a></div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_ShowStorage" style="display: none">
  <div style="display: inline-block">
    <div><a href="javascript:void return_home_from_storage()">return home</a></div>
    <hr></hr>
  </div>
  <div style="height:0.8em"></div>
  <div id="dvStorage"></div>
  <div style="height:0.6em"></div>
  <div style="display: inline-block">
    <hr></hr>
    <div style="height:0.8em"></div>
    <div><a href="javascript:void return_home_from_storage()">return home</a></div>
  </div>
  <div style="height:1em"></div>
</div>

<div id="dvPage_ViewItem" style="display: none">
  <div id="dvItemName" style="font-weight: bold"></div>
  <div id="dvPage_ViewItem_JoinedListsArea" style="display: none">
    <div style="height:0.3em"></div>
    <div id="dvListNameForItem"></div>
  </div>
  <div style="height:1.5em"></div>
  <div>
    <div>
      <span id="spnPage_ViewItem_NotDone"><a href="javascript:void mark_item_as_done()"><nowrap>mark done</nowrap></a></span>
      <span id="spnPage_ViewItem_Done"><span class="green">DONE</span>&nbsp;&nbsp;<a href="javascript:void unmark_item_as_done()"><nowrap>unmark done</nowrap></a></span>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript:void return_home()"><nowrap>home</nowrap></a>
      <span id="spnMoveToDifferentList" style="display: none">
        &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id="aMoveToDifferentList" href="javascript:void move_to_different_list()"><nowrap>move item</nowrap></a>
      </span>
    </div>
    <div style="height:1.7em"></div>
    <div>
      <a href="javascript:void rename_item()"><nowrap>rename</nowrap></a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript:void delete_item()"><nowrap>delete</nowrap></a>
      <span id="spnViewItem_Notes_No" style="display: none">
        &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript:void add_notes()"><nowrap>add notes</nowrap></a>
      </span>
    </div>
  </div>
  <div id="dvViewItem_Notes_Yes" style="display: none">
    <div style="height:1em"></div>
    <div id="dvViewItem_Notes"></div>
    <div style="height:0.2em"></div>
    <div>
      <a href="javascript:void edit_notes()"><nowrap>edit notes</nowrap></a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="javascript:void delete_notes()"><nowrap>delete notes</nowrap></a>
    </div>
  </div>
  <div style="height:1.7em"></div>
  <div id="dvViewItem_ListMembers_No" style="display: none">
    <div><a href="javascript:void make_into_a_list()">make into a list</a></div>
  </div>
  <div id="dvViewItem_ListMembers_Yes" style="display: none">
    <div>
      <a href="javascript:void make_new_item()"><nowrap>new item</nowrap></a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id="aReorder" style="white-space: nowrap" href="javascript:void toggle_reorder()">reorder</a>
      &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id="aMoreOptions" style="white-space: nowrap" href="javascript:void toggle_more_options()">more...</a>
    </div>
    <div id="dvMoreOptions" style="display: none">
      <div style="height:1.7em"></div>
      <div>
        <a style="white-space: nowrap" href="javascript:void mark_all()">mark all</a>
        &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id='aGrabItems' style="white-space: nowrap" href="javascript:void grab_items()">grab</a>
      </div>
    </div>
    <div style="height:1em"></div>
    <div style="display: inline-block">
      <div style="border-bottom: 1px black solid"></div>
      <div style="height:1.2em"></div>
      <div id="dvViewItem_ListMembers_Items"></div>
      <div style="height:0.7em"></div>
      <div style="border-bottom: 1px black solid"></div>
    </div>
    <div style="height:1em"></div>
    <div><a href="javascript:void make_new_item()">make new item</a></div>
  </div>
  <div style="height:1em"></div>
</div>

<script type="text/javascript">

"use strict";

const CONST_appNarrow = "app_narrow";
const CONST_appVersion = "0.40";
const CONST_devText1 = "devText1";
const CONST_importBlocked = "importBlocked";
const CONST_stringOfAllItemIds = "string_of_all_item_ids";
const CONST_homePageListName = "home_page_list";
const CONST_propName_sortPosition = "sortPosition";
const CONST_propName_itemId = "itemId";
const CONST_storedDataVersion = "stored_data_version";

const sD = "`"; // sD = storageDivider
const sD2 = "â‰¡"; // sD2 = storageDivider2, used for text formatting during backup

var app = {};
app.activatedItemId = null;
app.grabbing_itemId1 = null;
app.grabbing_itemId2 = null;
app.grabbing_itemIdArray = [];
app.grabbingEnabled = false;
app.moreOptionsEnabled = false;
app.reorderEnabled = false;

function activateItem(itemId) {
  app.activatedItemId = itemId;
  elem(getHtml_trActivated(itemId)).style.display = "" ;
}

function changeSortPosition(itemId, moveUp, moveAmt) {
  var listItemObj, memberItemObj, list_memberDataObjs, i = null;
  
  listItemObj = app.itemObj;
  memberItemObj = grabItemObj(itemId);
  list_memberDataObjs = listItemObj.getListMemberDataObjs();

  for (i = 0; i < list_memberDataObjs.length; i++) {
    let requestedNewSortIndex, memberItemDataObj, memberItemDataObj_toSwapWith, member_oldSortPosition;

    if ( isEqual(list_memberDataObjs[i].itemId, memberItemObj.itemId) ) {
      memberItemDataObj = list_memberDataObjs[i];

      if (moveUp) {
        requestedNewSortIndex = i - parseInt(moveAmt);
        if (requestedNewSortIndex < 0) return false;
      } else {
        requestedNewSortIndex = i + parseInt(moveAmt);
        if (requestedNewSortIndex >= list_memberDataObjs.length) return false;
      }

      memberItemDataObj_toSwapWith = list_memberDataObjs[requestedNewSortIndex];

      member_oldSortPosition = memberItemDataObj.sortPosition;
      memberItemDataObj.sortPosition = memberItemDataObj_toSwapWith.sortPosition;
      memberItemDataObj_toSwapWith.sortPosition = member_oldSortPosition;
  
      listItemObj.saveListMembersToDatastore(list_memberDataObjs);

      return true;
    }
  }

  return false;
}

function createItemInfoString(itemName, done, displayCode, isList, notes) {
  var itemInfoString = itemName + sD;

  if ( isBlank(done) ) {
    itemInfoString += "0";
  } else {
    if ( done == "1" ) {
      itemInfoString += "1";
    } else {
      itemInfoString += "0";
    }
  }

  itemInfoString = itemInfoString + sD;
  if ( isBlank(displayCode) ) {
    itemInfoString += "1";
  } else {
    itemInfoString += displayCode
  }

  itemInfoString = itemInfoString + sD;
  if ( isBlank(isList) ) {
    itemInfoString += "0";
  } else {
    itemInfoString += isList
  }

  itemInfoString = itemInfoString + sD;
  if ( isBlank(notes) ) {
    itemInfoString += "";
  } else {
    itemInfoString += notes
  }

  return itemInfoString;
}

function createListMemberDataObj(itemId, sortPosition) {
  var curListMemberDataObj = {};

  curListMemberDataObj.itemId = itemId;
  curListMemberDataObj.sortPosition = sortPosition;

  return curListMemberDataObj;
}

function da(text) {
  alert(text);
}

function deactivateItem(itemId) {
  app.activatedItemId = null;
  elem(getHtml_trActivated(itemId)).style.display = "none" ;
}

function deleteFromDatastore(itemKey) {
  localStorage.removeItem(itemKey);
}

function deleteItem(itemIdToDelete) {
  var itemObjToDelete, returnValue, successBoolean = false;

  itemObjToDelete = grabItemObj(itemIdToDelete);

  returnValue = itemObjToDelete.doDeletion() ;

  if ( ! isBlank(returnValue) && ! returnValue === false ) {
    successBoolean = true;
    setAppItemObj(grabItemObj(returnValue));
  }

  return successBoolean;
}

function disableGrabbing() {
  app.grabbing_itemId1 = null;
  app.grabbing_itemId2 = null;
  app.grabbing_itemIdArray = [];
  app.grabbingEnabled = false;
}

function displayPage(pageName) {
  elem("dvPage_Dev").style.display = "none";
  elem("dvPage_BackupExport").style.display = "none";
  elem("dvPage_BackupImport").style.display = "none";
  elem("dvPage_GrabbingMove").style.display = "none";
  elem("dvPage_Home").style.display = "none";
  elem("dvPage_ShowStorage").style.display = "none";
  elem("dvPage_ViewItem").style.display = "none";

  elem("dvPage_" + pageName).style.display = "";

  switch (pageName) {

    case "BackupExport":
      writeBackupExport();
      break;

    case "BackupImport":
      elem("taBackupTextToImport").value = "";
      elem("taBackupTextToImport").focus();
      break;

    case "GrabbingMove":
      if ( !isBlank(app.grabbing_itemId1) && isBlank(app.grabbing_itemId2) ) {
        //single-item-grab
        elem("spnGrabbingMove_FromList").innerHTML = grabItemObj(app.itemObj.displayedOnList_itemId).itemName;
      } else {
        elem("spnGrabbingMove_FromList").innerHTML = app.itemObj.itemName;
      }

      elem("dvGrabbingMove_Items").innerHTML = writeHtml_GrabbingMove_Items();
      elem("dvGrabbingMove_ListOptions").innerHTML = writeHtml_GrabbingMove_ListOptions();
      break;

    case "Home":
      if (!app.itemObj) {
        setAppItemObj(grabItemObjByName(CONST_homePageListName));
      }
      elem("dvHome_Items").innerHTML = writeHtml_ViewItem_Items(app.itemObj);
      break;

    case "ViewItem":
      var list_itemObj, hasDisplayedLists = false, i;

      elem("dvItemName").innerHTML = app.itemObj.itemName;

      //TO-DO: display multiple list names, if this item is a member of 2+
      
      elem("dvListNameForItem").innerHTML = "";

      for (i = 0; i < app.itemObj.joinedLists_itemIds.length; i++) {
        list_itemObj = grabItemObj(app.itemObj.joinedLists_itemIds[0])
        if (list_itemObj.displayCode == "1") {
          elem("dvListNameForItem").innerHTML = "&nbsp;&nbsp;&nbsp;member of list:&nbsp;&nbsp;<a href='javascript:void go_to_list(\"" + list_itemObj.itemId + "\")'>" + list_itemObj.itemName + "</a>";
          elem("spnMoveToDifferentList").style.display = "";
          hasDisplayedLists = true;
          app.itemObj.displayedOnList_itemId = list_itemObj.itemId;
          break;
        }
      }

      if (hasDisplayedLists) {
        elem("dvPage_ViewItem_JoinedListsArea").style.display = "";
      } else {
        elem("dvPage_ViewItem_JoinedListsArea").style.display = "none";
      }

      if (app.itemObj.done == "0") {
        elem("spnPage_ViewItem_NotDone").style.display = "";
        elem("spnPage_ViewItem_Done").style.display = "none";
      } else {
        elem("spnPage_ViewItem_NotDone").style.display = "none";
        elem("spnPage_ViewItem_Done").style.display = "";
      }

      if (app.itemObj.isList =="1") {
        elem("dvViewItem_ListMembers_Yes").style.display = "";
        elem("dvViewItem_ListMembers_No").style.display = "none";
        elem("dvViewItem_ListMembers_Items").innerHTML = writeHtml_ViewItem_Items(app.itemObj);
      } else {
        elem("dvViewItem_ListMembers_Yes").style.display = "none";
        elem("dvViewItem_ListMembers_No").style.display = "";
        elem("dvViewItem_ListMembers_Items").innerHTML = "";
      }

      if ( isBlank(app.itemObj.notes) ) {
        elem("dvViewItem_Notes_Yes").style.display = "none";
        elem("spnViewItem_Notes_No").style.display = "";
        elem("dvViewItem_Notes").innerHTML = "";
      } else {
        elem("dvViewItem_Notes_Yes").style.display = "";
        elem("spnViewItem_Notes_No").style.display = "none";
        elem("dvViewItem_Notes").innerHTML = app.itemObj.notes;
      }

      break;

    case "ShowStorage":
      writeStorage();
      break;
  }
}

function elem(id) {
  return document.getElementById(id);
}

function getFromDatastore(itemKey) {
  var itemValue = localStorage.getItem(itemKey);
  return itemValue;
}

function getHtml_aItem(itemId) {
  return "aItem_" + itemId;
}

function getHtml_trActivated(itemId) {
  return "trActivated_" + itemId;
}

function getIdArray(string_ids){
  var array_ids;
  if (isBlank(string_ids)) return [];
  array_ids = string_ids.split(sD);
  return array_ids;
}

function getIdString(array_ids){
  var string_ids = array_ids.join(sD);
  return string_ids;
}

function getObjArrayWithoutElem(theArray, propName, propValueToExclude) {
  var revisedArray;

  revisedArray = theArray.filter(function (arrayElem) {
    var returnValue = true;
    if ( isEqual(arrayElem[propName], propValueToExclude) ) {
      returnValue = false;
    }
    return returnValue;
  });

  return revisedArray;
}

function getObjArrayWithoutElem_old(theArray, propNameToMatch, propValueToMatch) {
  var i, curArrayElem, revisedArray = [];

  for (i = 0; i < theArray.length; i++) {
    curArrayElem = theArray[i];
    if ( !isEqual(curArrayElem[propNameToMatch], propValueToMatch) ) {
      revisedArray.push(curArrayElem);
    }
  }

  return revisedArray;
}

function getSaveKeyText_item(itemId) {
  return "i_" + itemId;
}

function getSaveKeyText_joinedLists_ofItem(itemId) {
  return "iJL_" + itemId;
}

function getSaveKeyText_listMembers_ofItem(itemId) {
  return "iLM_" + itemId;
}

function goToItemView(itemId, maintainActivatedItem) {
  if ( !isBlank(itemId) ) {
    setAppItemObj(grabItemObj(itemId));
  }
  if (!maintainActivatedItem) {
    app.activatedItemId = null;
  }

  displayPage("ViewItem");
  stopGrabbingItems();
}

function getValArrayWithoutElem(theArray, valToExclude) {
  var revisedArray;

  revisedArray = theArray.filter(function (arrayElem) {
    var returnValue = true;
    if ( isEqual(arrayElem, valToExclude) ) {
      returnValue = false;
    }
    return returnValue;
  });

  return revisedArray;
}

function goToGrabbingMove() {
  displayPage("GrabbingMove");
}

function grabItemObj(itemId) {
  var saveKeyText_item, itemObj, itemDataString, itemDataArray, saveKeyText_joinedLists_ofItem, joinedLists_itemIds_string;

  //get the item-data-string from the datastore
  saveKeyText_item = getSaveKeyText_item(itemId);
  itemDataString = getFromDatastore(saveKeyText_item);

  //this function assumes only existing items will be requested; so, if the item-data-string is blank, the item does not exist, and we must throw an error
  if ( isBlank(itemDataString) ) {
    throw("ERROR: item with itemId=" + itemId + " does not exist in data storage");
  }

  //create an item-object
  itemObj = itemObjFactory();

  //set the item-object's properties from the retrieved item-data
  itemDataArray = itemDataString.split(sD);
  itemObj.itemId = itemId;
  itemObj.itemName = itemDataArray[0];
  itemObj.done = itemDataArray[1];
  itemObj.displayCode = itemDataArray[2];
  itemObj.isList = itemDataArray[3];
  itemObj.notes = itemDataArray[4];

  //set joined-lists array, if any
  if (itemObj.isList) {
    saveKeyText_joinedLists_ofItem = getSaveKeyText_joinedLists_ofItem(itemObj.itemId);
    joinedLists_itemIds_string = getFromDatastore(saveKeyText_joinedLists_ofItem);
    itemObj.joinedLists_itemIds = getIdArray(joinedLists_itemIds_string);
  }

  //return the item-object
  return itemObj;
}

function grabItemObjByName(itemName) {
  var allItemIds_string, allItemIds_array, i, curItemId, curItemObj;
  
  allItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
  allItemIds_array = getIdArray(allItemIds_string);
  
  for (i = 0; i < allItemIds_array.length; i++) {
    curItemId = allItemIds_array[i];
    curItemObj = grabItemObj(curItemId)

    if ( isEqual(itemName, curItemObj.itemName) ) {
      return curItemObj;
    }
  }

  return false;
}

function importBackupText(textToImport) {
  var i, keyValuePairs, keyName, keyValue;

  //split storage-keys from text-to-import string
  keyValuePairs = textToImport.split(sD2);

  //if we don't have an even number of items, there is a mismatch of key/value pairs
  if (keyValuePairs.length % 2 > 0) {
    alert("uneven number of key/value pairs, operation canceled");
    return;
  }

  //clear existing storage
  if ( !confirm("About to clear existing storage, in order to proceed with import. Continue?") ) {
    return
  }
  localStorage.clear();

  //do the import
  for (i = 0; i < keyValuePairs.length; i = i + 2) {
    keyName = keyValuePairs[i];
    keyValue = keyValuePairs[i+1];
//if(!confirm("would make:\nkeyName: "+keyName+"\nkeyValue: "+keyValue+"\n\nexisting keyValue: "+getFromDatastore(keyName)))return
    localStorage.setItem(keyName, keyValue);
//if(!confirm("just added:\nkeyName: "+keyName+"\n\nnow, when re-grabbed from localStorage it is: "+getFromDatastore(keyName)))return
  }

  alert("Import complete");

  //refresh app and go to home page
  loadAppData();
  displayPage("Home");
}

function isBlank(val) {
  if(val == undefined) return true;
  if(val == null) return true;
  if(val == "0")return false;
  if(parseInt(val) == 0)return false;
  if(val == "") return true;
  if(!val)return true;
  return false;
}

function isDev() {
  if ( getFromDatastore(CONST_devText1) == "1" ) {
    return true;
  } else {
    return false;
  }
}

function isEqual(val1, val2) {
  if ( isBlank(val1) && isBlank(val2) ) return true;
  if ( val1 == val2 ) return true;
  if ( Number(val1) == Number(val2) ) return true;
  return false;
}

function itemObjFactory() {
  var itemObj = {};

  itemObj.itemId = null;
  itemObj.itemName = "";
  itemObj.done = "0";
  itemObj.displayCode = "1";
  itemObj.isList = "0";
  itemObj.notes = "";
  itemObj.joinedLists_itemIds = [];

  itemObj.addItemToListMembers = function(itemIdToAdd) {
    var listMemberDataObjs, curMaxSortPosition, sortPositionToUse, newListMemberDataObj;

    //grab current list-members for this list 
    listMemberDataObjs = this.getListMemberDataObjs();

    //set the new sortPosition value
    if (listMemberDataObjs.length == 0) {
      curMaxSortPosition = -1;
    } else {
      curMaxSortPosition = listMemberDataObjs[listMemberDataObjs.length - 1].sortPosition;
    }
    sortPositionToUse = parseInt(curMaxSortPosition) + 1

    //create a new list-member-data-object, and add it to the current array
    newListMemberDataObj = createListMemberDataObj(itemIdToAdd, sortPositionToUse);
    listMemberDataObjs.push(newListMemberDataObj);
    
    //save the revised list-members-array to datastore
    this.saveListMembersToDatastore(listMemberDataObjs);
  };

  itemObj.changeItem = function(itemName, done, displayCode, isList, notes) {
    if ( !isBlank(itemName) ) this.itemName = itemName;
    if ( !isBlank(done) ) this.done = done;
    if ( !isBlank(displayCode) ) this.displayCode = displayCode;
    if ( !isBlank(isList) ) this.isList = isList;
    if ( notes !== null ) this.notes = notes;
    this.saveItemInfoToDatastore();
    return true;
  };

  itemObj.doDeletion = function() {
    var firstListItemId = null, saveKeyText_listMembers_ofItem, i, curAllItemIds_string, curAllItemIds_array, newAllItemIds_string = "";

    //check if this is a list with list-members
    if (this.isList == "1") {
      if ( this.hasListMembers() ) {
        alert("Can't delete something that has list members");
        return false;
      }
    }

    //remove from joined-lists
    for (i = 0; i < this.joinedLists_itemIds.length; i++) {
      let joinedList_itemId = this.joinedLists_itemIds[i];
      let joinedList_itemObj = grabItemObj(joinedList_itemId);
      if ( firstListItemId == null ) firstListItemId = joinedList_itemId
      joinedList_itemObj.removeListMember(this.itemId);
    }

    //delete joined-list-info for this item
    deleteFromDatastore(getSaveKeyText_joinedLists_ofItem(this.itemId));

    //delete list-members entry for this item
    deleteFromDatastore(saveKeyText_listMembers_ofItem);

    //remove from all-items array
    curAllItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
    curAllItemIds_array = getIdArray(curAllItemIds_string);
    for (i = 0; i < curAllItemIds_array.length; i++) {
      if ( !isEqual(curAllItemIds_array[i], this.itemId) ) {
        if ( !isBlank(newAllItemIds_string) ) newAllItemIds_string += sD;
        newAllItemIds_string += curAllItemIds_array[i];
      }
    }
    saveToDatastore(CONST_stringOfAllItemIds, newAllItemIds_string);

    //delete item-info from datastore
    deleteFromDatastore(getSaveKeyText_item(this.itemId));

    //clear app-level current-item-id
    setAppItemObj(null);

    //return the the item-id of the first joined-list, so the calling functions can move to that item in the UI
    return firstListItemId;
  };

  itemObj.getListMemberDataObjs = function() {
    var saveKeyText_listMembers_ofItem, listMembers_string, listMembers_array, i, curListMemberDataObj, listMemberDataObjs = [];

    saveKeyText_listMembers_ofItem = getSaveKeyText_listMembers_ofItem(this.itemId);
    listMembers_string = getFromDatastore(saveKeyText_listMembers_ofItem);
    listMembers_array = getIdArray(listMembers_string);

    for (i = 0; i < listMembers_array.length; i = i + 2) {
      curListMemberDataObj = createListMemberDataObj(listMembers_array[i], listMembers_array[i + 1]);
      listMemberDataObjs.push(curListMemberDataObj);
    }

    //for now, we will sort the array by sortPosition every time; in the future, this could be provided as a separate function
    listMemberDataObjs.sort(sortingObjects(CONST_propName_sortPosition));

    return listMemberDataObjs;
  };

  itemObj.hasListMembers = function() {
    var saveKeyText_listMembers_ofItem, listMembers_string;

    saveKeyText_listMembers_ofItem = getSaveKeyText_listMembers_ofItem(this.itemId);
    listMembers_string = getFromDatastore(saveKeyText_listMembers_ofItem);

    if ( isBlank(listMembers_string) ) return false;

    if (listMembers_string.length > 0) {
      return true;
    } else {
      return false;
    }
  };

  itemObj.joinList = function(listToJoin_itemId) {
    var listToJoin_itemObj;

    //grab item-object for the list-to-join
    listToJoin_itemObj = grabItemObj(listToJoin_itemId);

    //call function on list-to-join's item-object, in order to be added to the list-members for that list-to-join 
    listToJoin_itemObj.addItemToListMembers(this.itemId);

    //add the list-to-join's itemId to this list's array of joined-lists
    this.joinedLists_itemIds.push(listToJoin_itemId);

    //save joined-lists to datastore
    this.saveJoinedListsToDatastore();
  };

  itemObj.leaveList = function(listToLeave_itemId) {
    var listToLeave_itemObj;

    //remove the list-to-leave's itemId from this list's array of joined-lists
    this.joinedLists_itemIds = getValArrayWithoutElem(this.joinedLists_itemIds, listToLeave_itemId);

    //save joined-lists to datastore
    this.saveJoinedListsToDatastore();

    //grab item-object for the list-to-join
    listToLeave_itemObj = grabItemObj(listToLeave_itemId);

    //call function on list-to-leave's item-object, in order to be removed from its list-members
    listToLeave_itemObj.removeListMember(this.itemId);
  };

  itemObj.makeIntoAList = function() {
    var saveKeyText_itemListMembers;

    if (this.isList == "1") {
      //no action needed
    } else {
      this.isList = "1";
      this.saveItemInfoToDatastore();
    }

    saveKeyText_itemListMembers = getSaveKeyText_listMembers_ofItem(this.itemId);
    saveToDatastore(saveKeyText_itemListMembers, "");
  };

  itemObj.markAllListMembers = function(markDirectionIsDone, listMemberDataObjs) {
    var i;

    for (i = 0; i < listMemberDataObjs.length; i++) {
      let curItemObj = grabItemObj(listMemberDataObjs[i].itemId);
      
      if (markDirectionIsDone) {
        if (curItemObj.done == "0") {
          curItemObj.changeItem(null, "1", null, null, null);
        }
      } else {
        if (curItemObj.done == "1") {
          curItemObj.changeItem(null, "0", null, null, null);
        }
      }
    }
  };

  itemObj.removeListMember = function(itemIdToRemove) {
    var oldListMemberDataObjs, newListMemberDataObjs;

    oldListMemberDataObjs = this.getListMemberDataObjs();
    newListMemberDataObjs = getObjArrayWithoutElem(oldListMemberDataObjs, CONST_propName_itemId, itemIdToRemove)

    this.saveListMembersToDatastore(newListMemberDataObjs);
  };

  itemObj.saveItemInfoToDatastore = function() {
    var itemInfoString;

    itemInfoString = createItemInfoString(this.itemName, this.done, this.displayCode, this.isList, this.notes)
    saveToDatastore(getSaveKeyText_item(this.itemId), itemInfoString);
  };

  itemObj.saveJoinedListsToDatastore = function() {
    var joinedLists_itemIds_string;

    joinedLists_itemIds_string = getIdString(this.joinedLists_itemIds);
    saveToDatastore(getSaveKeyText_joinedLists_ofItem(this.itemId), joinedLists_itemIds_string);
  };

  itemObj.saveListMembersToDatastore = function(listMemberDataObjs) {
    var saveKeyText_itemListMembers, i, curListMemberDataObj, listMemberDataObjs_string = ""; 

    saveKeyText_itemListMembers = getSaveKeyText_listMembers_ofItem(this.itemId);
    
    for (i = 0; i < listMemberDataObjs.length; i++) {
      curListMemberDataObj = listMemberDataObjs[i];
      if ( !isBlank(listMemberDataObjs_string) ) listMemberDataObjs_string += sD;
      listMemberDataObjs_string += curListMemberDataObj.itemId + sD + curListMemberDataObj.sortPosition;
    }

    saveToDatastore(saveKeyText_itemListMembers, listMemberDataObjs_string);
  };

  return itemObj;
}

function makeNewItem(itemName, itemNamePrompt, displayCode, isList, addToList_itemId) {
  var newItemObj, allItemIds_string, allItemIds_array, i, itemId_toCheck, maxItemId;

  //if not passed, get item name
  if ( isBlank(itemName) ) {
    if ( isBlank(itemNamePrompt) ) itemNamePrompt = "new item:";
    itemName = prompt(itemNamePrompt, "");
    if ( isBlank(itemName) ) return false;
  }

  //create item-object
  newItemObj = itemObjFactory();

  //generate new itemId
  allItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
  allItemIds_array = getIdArray(allItemIds_string);
  maxItemId = -1;
  for (i = 0; i < allItemIds_array.length; i++) {
    itemId_toCheck = allItemIds_array[i];
    if (parseInt(itemId_toCheck) > parseInt(maxItemId)) maxItemId = parseInt(itemId_toCheck);
  }
  newItemObj.itemId = parseInt(maxItemId) + 1;

  //save item-info to datastore
  newItemObj.itemName = itemName;
  if ( !isBlank(displayCode) ) newItemObj.displayCode = displayCode;
  if ( !isBlank(isList) ) newItemObj.isList = isList;
  newItemObj.notes = "";
  newItemObj.saveItemInfoToDatastore();

  //if is-list, make into a list
  if (isList == "1") {
    newItemObj.makeIntoAList();
  }

  //add item to list-of-all-items
  if ( isBlank(allItemIds_string) ) {
    allItemIds_string = "";
  } else {
    allItemIds_string = allItemIds_string + sD;
  }
  allItemIds_string = allItemIds_string + newItemObj.itemId;
  saveToDatastore(CONST_stringOfAllItemIds, allItemIds_string);

  //if requested, add this item to a list
  if ( !isBlank(addToList_itemId) ) {
    newItemObj.joinList(addToList_itemId);
  }

  return newItemObj;
}

function saveToDatastore(itemKey, itemValue) {
  localStorage.setItem(itemKey, itemValue);
}

function move_to_different_list() {
  app.grabbing_itemId1 = app.itemObj.itemId;
  app.grabbing_itemId2 = null;
  goToGrabbingMove();
}

function setAppItemObj(itemObj) {
  app.itemObj = itemObj;
  if ( app.itemObj ) {
    app.itemObj.displayedOnList_itemId = null;
  }
}

function setGrabItem(itemId) {
  elem(getHtml_aItem(itemId)).style.color = "red";
  if ( isBlank(app.grabbing_itemId1) ) {
    app.grabbing_itemId1 = itemId;
  } else {
    app.grabbing_itemId2 = itemId;
    goToGrabbingMove();
  }
}

function sortingObjects(propNameToSortBy) {
  return function(objA, objB) {
    var comparisonCode;

    if ( parseInt(objA[propNameToSortBy]) < parseInt(objB[propNameToSortBy]) ) {
      comparisonCode = -1;
    } else if ( parseInt(objA[propNameToSortBy]) > parseInt(objB[propNameToSortBy]) ) {
      comparisonCode = 1;
    } else {
      comparisonCode = 0;
    }

    return comparisonCode;
  };
}

function startGrabbingItems() {
  app.grabbing_itemId1 = null;
  app.grabbing_itemId2 = null;
  app.grabbing_itemIdArray = [];

  elem("aGrabItems").style.color = "red";

  app.grabbingEnabled = true;
}

function stopGrabbingItems() {
  elem("aGrabItems").style.color = "";

  if ( !isBlank(app.grabbing_itemId1) ) {
    elem(getHtml_aItem(app.grabbing_itemId1)).style.color = "";
  }

  disableGrabbing();
}

function transferItems(oldListObj, newListObj, memberItems_idArray) {
  var i;

  for (i = 0; i < memberItems_idArray.length; i++) {
    let curItemObj = grabItemObj(memberItems_idArray[i]);

    curItemObj.joinList(newListObj.itemId);
    curItemObj.leaveList(oldListObj.itemId);
  }
}

function writeBackupExport() {
  var i, keyName, keyValue, txt = "";

  for (i = 0; i < localStorage.length; i++){
    keyName = localStorage.key(i);
    keyValue = localStorage.getItem(keyName);

    if (i > 0) txt += sD2;

    txt += keyName + sD2 + keyValue;
  }

  elem("taExportedBackupText").value = txt;
  elem("taExportedBackupText").select();
}

function writeHtml_GrabbingMove_Items() {
  var singleItemGrab, displayList_itemObj, curList_listMemberDataObjs, html, i, firstGrabbingItemId = null, secondGrabbingItemId = null, firstWas1 = false, firstWas2 = false, wroteFirstHtmlRow = false;

  if ( !isBlank(app.grabbing_itemId1) && isBlank(app.grabbing_itemId2) ) {
    singleItemGrab = true;
    displayList_itemObj = grabItemObj(app.itemObj.displayedOnList_itemId);
  } else {
    singleItemGrab = false;
    displayList_itemObj = app.itemObj;
  }

  html = "<table cellspacing=0 cellpadding=0>\n";
  app.grabbing_itemIdArray = [];

  curList_listMemberDataObjs = displayList_itemObj.getListMemberDataObjs();

  for (i = 0; i < curList_listMemberDataObjs.length; i++){
    let curItemId, curItemObj, writeCurItem = false;

    curItemId = curList_listMemberDataObjs[i].itemId;

    if ( firstGrabbingItemId == null ) {
      
      //we HAVE NOT found the earliest-sort-position grabbed-item yet

      if ( isEqual(curItemId, app.grabbing_itemId1) ) {
        //the current item matches grab-item-1

        //... set info about first-grabbed-item found
        firstGrabbingItemId = app.grabbing_itemId1;
        firstWas1 = true;

        //... mark that we should write the current item
        writeCurItem = true;
      }

      if ( isEqual(curItemId, app.grabbing_itemId2) ) {
        //the current item matches grab-item-2

        //... set info about first-grabbed-item found
        firstGrabbingItemId = app.grabbing_itemId2;
        firstWas2 = true;

        //... mark that we should write the current item
        writeCurItem = true;
      }

    } else {

      //we HAVE found the earliest-sort-position grabbed-item yet

      //... NOTE: this ELSE section does not apply to single-item-grab, as we will exit this loop on the pass when firstGrabbingItemId is filled with the single-item, above

      //we should always write the current item now, because firstGrabbingItem is filled (non-null)
      writeCurItem = true;

      if (firstWas1) {

        //the earliest-sort-position grabbed-item was 1, so check 2 to see if we're done after the current item
        if ( isEqual(curItemId, app.grabbing_itemId2) ) {

          //the current item matches grab-item-2, so mark it as the second-grabbed-item found
          secondGrabbingItemId = app.grabbing_itemId2;
        }

      } else {

        //the earliest-sort-position grabbed-item was 2, so check 1 to see if we're done after the current item
        if ( isEqual(curItemId, app.grabbing_itemId1) ) {

          //the current item matches grab-item-1, so mark it as the second-grabbed-item found
          secondGrabbingItemId = app.grabbing_itemId1;
        }

      }

    }

    //check if we've gotten to the earliest-sort-position grabbed-item yet; if so, we can write HTML
    if (writeCurItem) {
      curItemObj = grabItemObj(curItemId);

      //save the item in an array, for use in the next step
      app.grabbing_itemIdArray.push(curItemId);

      if (wroteFirstHtmlRow) {
        html += "<tr style='height: 0.8em'><td></td><td></td></tr>\n";
      }

      html += "<tr><td>\n";
      html += " <table cellspacing=0 cellpadding=0>\n";
      html += " <tr style='height: 2px'><td></td></tr>\n";
      html += " <tr><td style='color: black; font-size: 125%'>&bull;</td></tr>\n";
      html += " </table\n";
      html += "</td><td style='width: 0.5em'></td><td>" + curItemObj.itemName + "</td></tr>\n";

      wroteFirstHtmlRow = true;

      //always break for single-item-grab, after this one row is written
      if (singleItemGrab) {
        break;
      }
    }

    //if first-grabbed-item and second-grabbed-item are filled, we can now exit this loop
    if ( firstGrabbingItemId !== null && secondGrabbingItemId !== null ) {
      break;
    }
  }

  html += "</table>\n";

  return html;
}

function writeHtml_GrabbingMove_ListOptions() {
  var singleItemGrab, displayList_itemId, allItemIds_string, allItemIds_array, html = "", i, wroteFirstHtmlRow = false;

  if ( !isBlank(app.grabbing_itemId1) && isBlank(app.grabbing_itemId2) ) {
    singleItemGrab = true;
    displayList_itemId = app.itemObj.displayedOnList_itemId;
  } else {
    singleItemGrab = false;
    displayList_itemId = app.itemObj.itemId;
  }

  allItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
  allItemIds_array = getIdArray(allItemIds_string);
  
  html += "<table cellspacing=0 cellpadding=0>\n";

  for (i = 0; i < allItemIds_array.length; i++) {
    let j, skipThisItem = false;
    let curItemId = allItemIds_array[i];
    let curItemObj = grabItemObj(curItemId)

    //don't write the display-list that holds the grabbed-items:
    if ( isEqual(displayList_itemId, curItemId) ) {
      continue;
    }

    //don't write non-list items:
    if (curItemObj.isList == "0") {
      continue;
    }

    //don't write items without displayCode 1:
    if ( !isEqual(curItemObj.displayCode, "1") ) {
      continue;
    }

    //don't write items from the list of grabbed-items
    for (j = 0; j < app.grabbing_itemIdArray.length; j++) {
      if ( isEqual(app.grabbing_itemIdArray[j], curItemId) ) {
        skipThisItem = true;
        continue;
      }
    }
    if (skipThisItem) {
      continue;
    }

    //everything else is okay to write as an available list to move the grabbed-items to
    if (wroteFirstHtmlRow) {
        html += "<tr style='height: 1.6em'><td></td><td></td></tr>\n";
    }

    html += "<tr><td>\n";
    html += " <table cellspacing=0 cellpadding=0>\n";
    html += " <tr style='height: 2px'><td></td></tr>\n";
    html += " <tr><td style='color: black; font-size: 125%'>&bull;</td></tr>\n";
    html += " </table\n";
    html += "</td><td style='width: 0.5em'></td><td><a href='javascript:void choose_target_list(\"" + curItemId + "\")'>" + curItemObj.itemName + "</a></td></tr>\n";

    wroteFirstHtmlRow = true;
  }

  if (!wroteFirstHtmlRow) html += "<tr><td>(no other lists are available)</td></tr>";

  html += "</table>\n";

  return html;
}

function writeHtml_ViewItem_Items(mainItemObj) {
  var listMemberDataObjs, html = "", i;

  if (mainItemObj.isList) {
    //get array of list-member-item-ids
    listMemberDataObjs = mainItemObj.getListMemberDataObjs();

    //open html table
    html += "<table cellspacing=0 cellpadding=0>\n";

    //loop through array to write list in HTML
    for (i = 0; i < listMemberDataObjs.length; i++){
      let curItemId, curItemObj, addAsterisk, itemNameDisplay;

      curItemId = listMemberDataObjs[i].itemId;

      if (i > 0) {
        html += "<tr style='height: 1.6em'><td></td><td></td></tr>\n";
      }

      //call the function that grabs the current item's item-info from storage and returns it as a js-object
      curItemObj = grabItemObj(curItemId);

      //add asterisk to item-name if it has notes or list-members
      addAsterisk = false;

      if ( !isBlank(curItemObj.notes) ) {
        addAsterisk = true;
      } else {
        if ( curItemObj.hasListMembers() ) {
          addAsterisk = true;
        }
      }

      if (addAsterisk) {
        itemNameDisplay = curItemObj.itemName + " *";
      } else {
        itemNameDisplay = curItemObj.itemName;
      }

      //set html based on item-info values stored as properties of the item-info-js-object
      html += "<tr><td>\n";
      html += " <table cellspacing=0 cellpadding=0>\n";
      html += " <tr style='height: 2px'><td></td></tr>\n";
      html += " <tr><td style='color: black; font-size: 125%'>&bull;</td></tr>\n";
      html += " </table\n";
      html += "</td><td style='width: 0.5em'></td><td><a id='" + getHtml_aItem(curItemId) + "'" ;
      if (curItemObj.done == "1") html += " class='green'";
      html += " href='javascript:void click_item(\"" + curItemId + "\")'>" + itemNameDisplay + "</a></td></tr>\n";
      html += "<tr style='height: 0.8em'><td colspan=3></td></tr>\n"
      html += "<tr id='" + getHtml_trActivated(curItemId) + "' style='display: "
      if ( ! isEqual(curItemId, app.activatedItemId) ) html += "none";
      html += "'><td style='height: 1em' colspan=2></td><td>\n";
      html += " <table cellspacing=0 cellpadding=0>\n";
      html += " <tr><td>&nbsp;&nbsp;&nbsp;</td><td>";
      html += "  <a href='javascript:void move_item_up(\"" + curItemId + "\")'>move up</a>\n";
      html += "  &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href='javascript:void move_item_down(\"" + curItemId + "\")'>move down</a>\n";
      html += " </td></tr>\n";
      html += " </table\n";
      html += "</td></tr>\n";


/*
      html += "'><td colspan=3>\n";
      html += " <table cellspacing=0 cellpadding=0>\n";
      html += " <tr style='height: 1em'><td></td><td></td></tr>\n";
      html += " <tr><td style='width: 2em'></td><td>\n";
      html += "  <a href='javascript:void move_item_up(\"" + curItemId + "\")'>move up</a>\n";
      html += "  &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href='javascript:void move_item_down(\"" + curItemId + "\")'>move down</a>\n";
      html += " </td></td></tr>\n";
      html += " </table\n";
      html += "</td></tr>\n";
*/
    }

    if (listMemberDataObjs.length == 0) html += "<tr><td>(no items)</td></tr>";

    html += "</table>\n";
  }

  return html;
}

function writeStorage() {
  var i, keyName, keyValue, html = "", curListId, curListName, appNarrow;

  appNarrow = getFromDatastore(CONST_appNarrow);

  html += "<div><a href='javascript:void add_storage_row()'>add</a></div>\n";
  html += "<div style='height:0.8em'></div>\n";
  html += "<table cellpadding=5 cellspacing=0 border=1>\n";

  if (localStorage.length <= 0) {
    html += "<tr><td>(no items in storage)</td></tr>\n";
  } else {
    if (appNarrow == "1") {
      html += "<tr><td></td><td>\n";
      html += "  <table cellpadding=0 cellspacing=0>\n";
      html += "  <tr><td><b>Key Name</b></td></tr>\n";
      html += "  <tr><td style='height: 3px'></td></tr>\n";
      html += "  <tr><td style='height: 1px; background-color: black'></td></tr>\n";
      html += "  <tr><td style='height: 3px'></td></tr>\n";
      html += "  <tr><td><b>Key Value</b></td></tr>\n";
      html += "  </table>\n";
      html += "</td></tr>\n";
    } else {
      html += "<tr><td></td><td><b>Key Name</b></td><td><b>Key Value</b></td></tr>\n";
    }
  }

  for (i = 0; i < localStorage.length; i++) {
    keyName = localStorage.key(i);
    keyValue = getFromDatastore(keyName);

    if (appNarrow == "1") {
      html += "<tr><td>\n";
      html += "  <table cellpadding=0 cellspacing=0>\n";
      html += "  <tr><td><a href='javascript:void edit_storage_row(\"" + keyName + "\")'>edit</a></td></tr>\n";
      html += "  <tr><td style='height: 15px'></td></tr>\n";
      html += "  <tr><td><a href='javascript:void change_storage_key_name(\"" + keyName + "\")'>change key</a></td></tr>\n";
      html += "  <tr><td style='height: 15px'></td></tr>\n";
      html += "  <tr><td><a href='javascript:void delete_storage_row(\"" + keyName + "\")'>delete</a></td></tr>\n";
      html += "  </table>\n";
      html += "</td>\n";
    } else {
      html += "<tr><td style='white-space: nowrap'>&nbsp;<a href='javascript:void edit_storage_row(\"" + keyName + "\")'>edit</a>\n";
      html += "&nbsp;|&nbsp;&nbsp;<a href='javascript:void change_storage_key_name(\"" + keyName + "\")'>change key</a>\n";
      html += "&nbsp;|&nbsp;&nbsp;<a href='javascript:void delete_storage_row(\"" + keyName + "\")'>delete</a>&nbsp;&nbsp;</td>\n";
    }

    if (appNarrow == "1") {
      html += "<td>" + keyName + "</td></tr>\n";
      html += "<tr><td></td><td>" + keyValue + "</td></tr>\n";
    } else {
      html += "<td>" + keyName + "</td><td>" + keyValue + "</td></tr>\n";
    }
  }

  html += "</table>\n";
  html += "<div style='height:0.8em'></div>\n";
  html += "<div><a href='javascript:void add_storage_row()'>add</a></div>\n";

  elem("dvStorage").innerHTML = html;
}


///// FUNCTIONS FROM HTML PAGE

function add_notes() {
  var newNotes = prompt("Notes:", "");
  if ( isBlank(newNotes) ) return;
  app.itemObj.changeItem(null, null, null, null, newNotes);
  goToItemView(null, true);
}

function add_storage_row() {
  var keyName = prompt("New key name:", "");
  var keyValue = prompt("New key value:", "");

  if ( isBlank(keyName) ) {
    return;
  }

  saveToDatastore(keyName, keyValue);
  show_storage();
}

function begin_import() {
  var textToImport = elem("taBackupTextToImport").value;
  if ( isBlank(textToImport) ) return;
  importBackupText(textToImport);
}

function cancel_move() {
  disableGrabbing();
  goToItemView(null, false);
}

function change_storage_key_name(curKeyName) {
  var editedKeyName, keyValue, keyValueFromEditedKeyName, warningMsg, confirmationMsg;

  //get new key name user requests
  editedKeyName = prompt("Change key name to:", curKeyName);

  //exit if user did not provide a new key name
  if ( isBlank(editedKeyName) ) {
    return;
  }

  //grab existing key value for current key name
  keyValue = getFromDatastore(curKeyName);

  //check to see if new requestd key name is already in use; if so, disallow
  keyValueFromEditedKeyName = getFromDatastore(editedKeyName);
  if ( !isBlank(keyValueFromEditedKeyName) ) {
    warningMsg = "*** OPERATION DISALLOWED ***\n";
    warningMsg += "You tried to change key with keyName='" + curKeyName + "'\n";
    warningMsg += "( keyValue='" + keyValue + "' )\n";
    warningMsg += "... to the new-keyName '" + editedKeyName + "'\n";
    warningMsg += "... but that new-keyName already exists, with existing-keyValue '" + keyValueFromEditedKeyName + "'";
    alert(warningMsg);
    return;
  }

  //save new key to storage
  saveToDatastore(editedKeyName, keyValue);

  //delete previous key name
  deleteFromDatastore(curKeyName);

  //provide info with change
  confirmationMsg = "Change Made:\n\n";
  confirmationMsg += " old-keyName: " + curKeyName + "\n";
  confirmationMsg += " new-keyName " + editedKeyName + "\n";
  confirmationMsg += " keyValue: " + keyValue;
  alert(confirmationMsg);

  //refresh storage view
  show_storage();
}

function choose_target_list(newList_itemId) {
  var singleItemGrab, oldList_itemObj, newList_itemObj;

  if ( !isBlank(app.grabbing_itemId1) && isBlank(app.grabbing_itemId2) ) {
    singleItemGrab = true;
    oldList_itemObj = grabItemObj(app.itemObj.displayedOnList_itemId);
  } else {
    singleItemGrab = false;
    oldList_itemObj = app.itemObj;
  }

  newList_itemObj = grabItemObj(newList_itemId);
  transferItems(oldList_itemObj, newList_itemObj, app.grabbing_itemIdArray);

  disableGrabbing();

  if (singleItemGrab) {
    //reset the display-item-object -- still is correct itemId-property in app.itemObj, but list-membership change means we need to reset the app.itemObj by re-passing in its item-id
    goToItemView(app.itemObj.itemId, false);
  } else {
    //display the item-object for the list where the grabbed-items where transferred to
    goToItemView(newList_itemId, false);
  }
}

function clear_storage() {
  var clearStoragePrompt;
  
  clearStoragePrompt = prompt("type 'clear it' to clear local storage", "");

  if (clearStoragePrompt == "clear it") {
    localStorage.clear();
    alert("storage cleared");
    loadAppData();
    displayPage("Home");
  } else {
    alert("storage NOT cleared");
  }
}

function click_item(itemId) {
  if (app.grabbingEnabled) {
    setGrabItem(itemId);
    return;
  }

  if (app.reorderEnabled) {
    if ( isBlank(app.activatedItemId) ) {
      activateItem(itemId);
    } else {
      if ( isEqual(itemId, app.activatedItemId) ) {
        goToItemView(itemId, false);
      } else {
        deactivateItem(app.activatedItemId);
        activateItem(itemId);
      }
    }
  } else {
    goToItemView(itemId, false);
  }
}

function copy_imported_text_to_clipboard() {
  elem("taExportedBackupText").select();  
  document.execCommand("copy")
  alert("backup text copied to clipboard");
}

function delete_item() {
  if ( confirm("Delete this item?\n\nItem Name: " + app.itemObj.itemName) ) {
    if ( deleteItem(app.itemObj.itemId) ) {
      if ( !isBlank(app.itemObj) ) {
        goToItemView(null, false);
      } else {
        return_home();
      }
    }
  }
}

function delete_notes() {
  if ( confirm("Delete all Notes for this item?\n\nItem Name: " + app.itemObj.itemName + "\n\nNotes: " + app.itemObj.notes) ) {
    app.itemObj.changeItem(null, null, null, null, "");
    goToItemView(null, true);
  }
}

function delete_storage_row(keyName) {
  if ( confirm("Delete this row?") ) {
    deleteFromDatastore(keyName);
    show_storage();
  }
}

function edit_notes() {
  var editedNotes = prompt("Notes:", app.itemObj.notes);
  if ( isBlank(editedNotes)) {
    alert("Edit canceled because a blank Notes entry was received\n\n(click 'delete notes' if you want to remove all notes for this item)");
    return;
  }
  app.itemObj.changeItem(null, null, null, null, editedNotes);
  goToItemView(null, true);
}

function edit_storage_row(keyName) {
  var curKeyValue = getFromDatastore(keyName);
  var editedKeyValue = prompt("Change key value to:", curKeyValue);

  if ( isBlank(editedKeyValue) ) {
    return;
  }

  saveToDatastore(keyName, editedKeyValue);
  show_storage();
}

function export_backup_text() {
  displayPage("BackupExport");
}

function go_to_list(itemId) {
  goToItemView(itemId, false);
}

function grab_items() {
  if (app.grabbingEnabled) {
    stopGrabbingItems();
  } else {
    startGrabbingItems();
  }
}

function import_backup_text() {
  if ( getFromDatastore(CONST_importBlocked) == "1" ) {
    alert("OPERATION DISALLOWED\n\nImporting of text has been blocked on this device");
    return;
  }
  displayPage("BackupImport");
}

function mark_item_as_done() {
  app.itemObj.changeItem(null, "1", null, null, null);
  goToItemView(null, true);
}

function make_into_a_list() {
  app.itemObj.makeIntoAList();
  goToItemView(null, false);
}

function make_new_item() {
  var newItemObj;

  newItemObj = makeNewItem(null, null, null, "0", app.itemObj.itemId);
  if ( newItemObj ) {
    setAppItemObj(newItemObj);
    displayPage("ViewItem");
  }
}

function make_new_list() {
  var newItemObj;

  newItemObj = makeNewItem(null, "new list name:", null, "1", app.homePageList_itemId);
  if ( newItemObj ) {
    setAppItemObj(newItemObj);
    displayPage("ViewItem");
  }
}

function mark_all() {
  var markDirectionIsDone = false, listMemberDataObjs, i, confirmText;
  
  listMemberDataObjs = app.itemObj.getListMemberDataObjs();

  for (i = 0; i < listMemberDataObjs.length; i++) {
    let curItemObj = grabItemObj(listMemberDataObjs[i].itemId);

    //if we find at least one that is not-done, that mark-all direction will be towards Done
    if (curItemObj.done == "0") {
      markDirectionIsDone = true;
      break;
    }
  }

  confirmText = "mark all items on this list as";
  if (markDirectionIsDone) {
    confirmText += " done?";
  } else {
    confirmText += " not done?";
  }

  if ( !confirm(confirmText) ) {
    return;
  }

  app.itemObj.markAllListMembers(markDirectionIsDone, listMemberDataObjs);

  goToItemView(null, true);
}


function move_item_down(itemId) {
  if ( changeSortPosition(itemId, false, 1) ) {
    goToItemView(null, true);
  }
}

function move_item_up(itemId) {
  if ( changeSortPosition(itemId, true, 1) ) {
    goToItemView(null, true);
  }
}

function rename_item() {
  var editedItemName = prompt("Change item name to:", app.itemObj.itemName);
  if ( isBlank(editedItemName)) return;
  app.itemObj.changeItem(editedItemName, null, null, null, null);
  goToItemView(null, true);
}

function return_home() {
  setAppItemObj(grabItemObjByName(CONST_homePageListName));
  displayPage("Home");
}

function return_home_from_storage() {
  loadAppData();
  displayPage("Home");
}

function show_dev_screen() {
  displayPage("Dev");
}

function show_storage() {
  displayPage("ShowStorage");
}

function toggle_app_narrow() {
  var curAppNarrow, newAppNarrow;

  curAppNarrow = getFromDatastore(CONST_appNarrow);

  if ( curAppNarrow == "1" ) {
    newAppNarrow = "0";
  } else {
    newAppNarrow = "1";
  }

  saveToDatastore(CONST_appNarrow, newAppNarrow);

  alert("app_narrow set to " + newAppNarrow);
}

function toggle_dev() {
  var curDevText1, newDevText1;

  curDevText1 = getFromDatastore(CONST_devText1);

  if (curDevText1 == "1") {
    newDevText1 = "0";
  } else {
    newDevText1 = "1";
  }

  saveToDatastore(CONST_devText1, newDevText1);

  alert("devText1 set to " + newDevText1);
}

function toggle_import_blocked() {
  var curImportBlocked, newImportBlocked;

  curImportBlocked = getFromDatastore(CONST_importBlocked);

  if ( curImportBlocked == "1" ) {
    newImportBlocked = "0";
  } else {
    newImportBlocked = "1";
  }

  saveToDatastore(CONST_importBlocked, newImportBlocked);

  alert("importBlocked set to " + newImportBlocked);
}

function toggle_more_options() {
  if (app.moreOptionsEnabled) {
    elem("dvMoreOptions").style.display = "none";
    elem("aMoreOptions").innerHTML = "more...";
    app.moreOptionsEnabled = false;
  } else {
    elem("dvMoreOptions").style.display = "";
    elem("aMoreOptions").innerHTML = "less...";
    app.moreOptionsEnabled = true;
  }
}

function toggle_reorder() {
  if (app.reorderEnabled) {
    app.reorderEnabled = false;
    elem("aReorder").style.color = "";
  } else {
    app.reorderEnabled = true;
    elem("aReorder").style.color = "red";
  }
}

function unmark_item_as_done() {
  app.itemObj.changeItem(null, "0", null, null, null);
  goToItemView(null, true);
}


///// LOADING & UPGRADING APP-LEVEL DATA FROM STORAGE

function loadAppData() {
  var homePageListItemObj;

  //set success-flag to false
  app.dataLoadedSuccessfully = false;

  //if it does not exist, create a home-page-list item
  homePageListItemObj = grabItemObjByName(CONST_homePageListName);
  if ( !homePageListItemObj ) {
    homePageListItemObj = makeNewItem(CONST_homePageListName, "", "0", "1", null)
  }

  //set app current-item to home-page-list
  setAppItemObj(homePageListItemObj);

  //set home-page-list item-id
  app.homePageList_itemId = homePageListItemObj.itemId;

  //update stored-data
  if ( ! upgradeStoredData() ) {
    return;
  }

  //set version# on screen
  elem("spnAppNameAndVersion").innerHTML = "wib v" + CONST_appVersion;

  app.dataLoadedSuccessfully = true;
}

function upgradeStoredData() {
  var appVersion_array, appVersion_major, appVersion_minor;
  var storedDataVersion_string, storedDataVersion_array, storedDataVersion_major, storedDataVersion_minor;

  //split app-version into major and minor
  appVersion_array = CONST_appVersion.split(".");
  appVersion_major = Number(appVersion_array[0]);
  appVersion_minor = Number(appVersion_array[1]);

  //establish existing version of the stored data
  storedDataVersion_string = getFromDatastore(CONST_storedDataVersion);
  if ( isBlank(storedDataVersion_string) ) storedDataVersion_string = "0.0";
  
  //split stored-data-version into major and minor
  storedDataVersion_array = storedDataVersion_string.split(".");
  storedDataVersion_major =  Number(storedDataVersion_array[0]);
  storedDataVersion_minor =  Number(storedDataVersion_array[1]);

  //warning if major version differs
  if ( !isEqual(appVersion_major, storedDataVersion_major) ) {
    alert("WARNING: app version is " + appVersion_major + ", stored data version is " + storedDataVersion_major + " ... no automatic data update available yet for major version upgrades");
    return false;
  }

  if (parseInt(appVersion_minor) >= 36 && parseInt(storedDataVersion_minor) < 36) {
    //upgrade from pre-0.36 to 0.36
    if ( upgradeStoredData_0_36() ) {
      // no action
    } else {
      return false;
    }
  }

  if (parseInt(appVersion_minor) >= 37 && parseInt(storedDataVersion_minor) < 37) {
    //upgrade from pre-0.37 to 0.37
    if ( upgradeStoredData_0_37() ) {
      // no action
    } else {
      return false;
    }
  }

  return true;
}

function upgradeStoredData_0_36() {
  var allItemIds_string, allItemIds_array, i, curItemId, saveKeyText_curItem, oldItemInfoString, newItemInfoString, storedDataVersion_string;

  allItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
  allItemIds_array = getIdArray(allItemIds_string);
 
  //cycle through all items, add blank Notes field for each
  for (i = 0; i < allItemIds_array.length; i++) {
    curItemId = allItemIds_array[i];
    saveKeyText_curItem = getSaveKeyText_item(curItemId);
    oldItemInfoString = getFromDatastore(saveKeyText_curItem);
    newItemInfoString = oldItemInfoString + sD;
    saveToDatastore(saveKeyText_curItem, newItemInfoString);
  }

  //update data's version-number to 0.36
  saveToDatastore(CONST_storedDataVersion, "0.36");

  //return success flag
  return true;
}

function upgradeStoredData_0_37() {
  var allItemIds_string, allItemIds_array, i, j;

  allItemIds_string = getFromDatastore(CONST_stringOfAllItemIds);
  allItemIds_array = getIdArray(allItemIds_string);
 
  //cycle through all items
  for (i = 0; i < allItemIds_array.length; i++) {
    let curItemId = allItemIds_array[i];
    let curItemObj = grabItemObj(curItemId);

    //for each item, if it is-list, cycle through list-members
    if (curItemObj.isList == "1") {
      let saveKeyText_listMembers_ofCurItem = getSaveKeyText_listMembers_ofItem(curItemId);
      let oldListMembers_string = getFromDatastore(saveKeyText_listMembers_ofCurItem);
      let oldListMembers_array = getIdArray(oldListMembers_string);
      let newListMembers_string = "";

      //add sort-position-number after each item-id
      for (j = 0; j < oldListMembers_array.length; j++) {
        if (newListMembers_string !== "") newListMembers_string += sD
        newListMembers_string += oldListMembers_array[j] + sD + String(j);
      }

      saveToDatastore(saveKeyText_listMembers_ofCurItem, newListMembers_string)
    }
  }

  //update data's version-number to 0.37
  saveToDatastore(CONST_storedDataVersion, "0.37");

  //return success flag
  return true;
}


///// RUN APP-DATA-LOAD AND SHOW HOME PAGE

loadAppData();

//only show home page is appLevelData loaded successfully
if ( app.dataLoadedSuccessfully ) {
  displayPage("Home");
}

/*
var ay1 = [{testProp:1}, {testProp:2}, {testProp:3}, {testProp:4}, {testProp:5}];
function displayAy(ay) {
  var x = "";
  for (var i = 0; i < ay.length; i++){
    if (i > 0) x += " ----- "
    x += "ay elem index " + i + ", testProp=" + ay[i].testProp;
  }
  console.log(x);
}
//console.log(ay1);
displayAy(ay1);
var ay2 = getObjArrayWithoutElem(ay1, "testProp", 4);
//console.log(ay2);
displayAy(ay2);
*/

</script>

</body>
</html>
